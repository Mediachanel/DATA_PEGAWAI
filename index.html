<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>SI Data Pegawai - Masuk</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="foto/Dinkes.png" />
  <style>
    :root {
      --bg: #f6f7fb;
      --panel: #ffffff;
      --deep: #1b2b3a;
      --accent: #5e8bff;
      --accent-soft: #eef3ff;
      --muted: #6a7a73;
      --shadow: 0 20px 38px rgba(24, 39, 75, 0.18);
      --border: #e6ecf4;
      --accent-2: #ff9f68;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: "Plus Jakarta Sans","Segoe UI", Arial, sans-serif; background: radial-gradient(circle at 18% 20%, rgba(94,139,255,0.08), transparent 30%), radial-gradient(circle at 80% 0%, rgba(255,159,104,0.12), transparent 32%), #f7f9fc; color: #1b2b3a; }
    main { padding: 24px 18px 36px; }
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 18px; background: linear-gradient(120deg, rgba(94,139,255,0.14), rgba(255,159,104,0.16)), #ffffff; border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 50; box-shadow: 0 10px 28px rgba(24,39,75,0.12); backdrop-filter: blur(6px);
    }
    .brand { display: flex; align-items: center; gap: 10px; }
    .brand img { width: 38px; height: 38px; object-fit: contain; }
    .brand .title { font-weight: 800; font-size: 15px; color: #0d2f1f; line-height: 1.2; }
    .pill { display: inline-flex; align-items: center; gap: 8px; background: #eef3ff; color: #3b5ecc; padding: 8px 12px; border-radius: 999px; font-size: 12px; box-shadow: 0 10px 20px rgba(94,139,255,0.22); }
    .pill .dot { width: 8px; height: 8px; background: #5e8bff; border-radius: 50%; box-shadow: 0 0 0 4px rgba(94,139,255,0.18); }
    .hero { max-width: 1100px; margin: 0 auto; background: linear-gradient(135deg, rgba(94,139,255,0.22), rgba(255,159,104,0.18)), #0f1f3a; border-radius: 22px; padding: 28px; box-shadow: var(--shadow); color: #e7efff; display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 18px; position: relative; overflow: hidden; }
    .bubble { position: absolute; width: 120px; height: 120px; border-radius: 50%; background: rgba(255,255,255,0.14); right: 26px; top: 26px; }
    .bubble.small { width: 86px; height: 86px; right: 60px; bottom: 22px; background: rgba(255,255,255,0.08); }
    h1 { margin: 6px 0 10px; font-size: 30px; line-height: 1.2; }
    .tag { display: inline-block; padding: 8px 12px; background: rgba(255,255,255,0.14); border-radius: 999px; font-size: 12px; font-weight: 700; margin-bottom: 10px; }
    p { margin: 0; color: #d6e1f5; line-height: 1.55; }
    .cta { margin-top: 16px; display: inline-block; background: linear-gradient(135deg, #ff9f68, #ffd6a3); color: #1b2b3a; padding: 12px 18px; border-radius: 999px; font-weight: 800; text-decoration: none; box-shadow: 0 12px 24px rgba(255,159,104,0.35); }

    .login-card { background: var(--panel); color: #1b2b3a; border-radius: 14px; padding: 20px 18px; box-shadow: 0 12px 24px rgba(24,39,75,0.12); border: 1px solid var(--border); }
    .login-card h3 { margin: 0 0 14px; font-size: 18px; color: #1b2b3a; }
    label { display: block; font-size: 12px; font-weight: 700; color: #4d5a54; margin-bottom: 6px; }
    input { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #dfe5f0; font-size: 14px; }
    .input-wrap { position: relative; }
    .input-wrap input { padding-right: 40px; }
    .toggle-visibility {
      position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
      width: 30px; height: 30px; border: none; background: transparent; display: grid; place-items: center;
      color: #64748b; cursor: pointer;
    }
    .toggle-visibility:hover { color: #0f172a; }
    .toggle-visibility:focus-visible { outline: 2px solid rgba(94,139,255,0.45); outline-offset: 2px; border-radius: 999px; }
    .toggle-visibility svg { width: 18px; height: 18px; display: block; fill: currentColor; }
    .btn { margin-top: 12px; width: 100%; padding: 12px 14px; border: none; border-radius: 10px; background: linear-gradient(120deg, var(--accent) 0%, #7cb3ff 45%, var(--accent-2) 100%); color: #0b1f2c; font-weight: 800; cursor: pointer; box-shadow: 0 15px 35px rgba(94,139,255,0.32); font-size: 14px; }
    .btn:disabled { background: #c9d7f5; cursor: not-allowed; }
    .status { margin-top: 10px; padding: 10px; border-radius: 10px; background: #f5f8ff; border: 1px solid #e6ecf4; color: #3b5ecc; font-weight: 700; font-size: 13px; }
    .muted { font-size: 12px; color: var(--muted); margin-top: 6px; }

    .faq-section { max-width: 1100px; margin: 20px auto 0; display: grid; gap: 16px; }
    .faq-card {
      background: linear-gradient(160deg, rgba(255,255,255,0.95), #f6f7ff);
      border: 1px solid var(--border);
      border-radius: 22px;
      padding: 20px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }
    .faq-card::before{
      content: "";
      position: absolute;
      right: -50px;
      top: -70px;
      width: 160px;
      height: 160px;
      border-radius: 50%;
      background: rgba(94,139,255,0.14);
    }
    .faq-card::after{
      content: "";
      position: absolute;
      left: -60px;
      bottom: -70px;
      width: 180px;
      height: 180px;
      border-radius: 50%;
      background: rgba(255,159,104,0.14);
    }
    .faq-hero { display: grid; grid-template-columns: minmax(0, 1.25fr) minmax(0, 0.75fr); gap: 16px; position: relative; z-index: 1; }
    .faq-hero-text { display: grid; gap: 8px; }
    .faq-kicker {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      background: #eef3ff;
      color: #3b5ecc;
      font-size: 12px;
      font-weight: 800;
      width: fit-content;
      box-shadow: 0 10px 20px rgba(94,139,255,0.18);
    }
    .faq-title { margin: 0; font-size: 22px; letter-spacing: 0.2px; }
    .faq-sub { margin: 0; color: #516273; font-size: 13px; line-height: 1.6; }
    .faq-search-wrap {
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 14px;
      background: #ffffff;
      border: 1px solid var(--border);
      box-shadow: 0 14px 26px rgba(15,23,42,0.08);
    }
    .faq-search-icon {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      background: #f0f4ff;
      display: grid;
      place-items: center;
      color: #3b5ecc;
      flex-shrink: 0;
    }
    .faq-search-icon svg { width: 18px; height: 18px; fill: currentColor; }
    .faq-search {
      border: none;
      background: transparent;
      padding: 8px 6px;
      font-size: 14px;
      flex: 1;
      min-width: 0;
    }
    .faq-search:focus { outline: none; }
    .faq-count {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #dbe5ff;
      background: #f0f4ff;
      font-weight: 800;
      font-size: 12px;
      color: #3b5ecc;
      white-space: nowrap;
    }
    .faq-hero-panel {
      background: linear-gradient(160deg, rgba(94,139,255,0.12), rgba(255,159,104,0.12)), #ffffff;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      display: grid;
      gap: 12px;
      align-content: start;
      box-shadow: 0 14px 28px rgba(24,39,75,0.1);
    }
    .faq-panel-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .faq-panel-label { font-size: 12px; color: #64748b; font-weight: 700; }
    .faq-panel-value { font-size: 20px; font-weight: 800; color: #1b2b3a; }
    .faq-tags {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding: 6px 2px;
      overflow-x: auto;
      position: relative;
      z-index: 1;
    }
    .faq-tags::-webkit-scrollbar { height: 6px; }
    .faq-tags::-webkit-scrollbar-thumb { background: #dbe3f3; border-radius: 999px; }
    .faq-tag {
      padding: 8px 14px;
      border-radius: 999px;
      background: #f7f9ff;
      border: 1px solid #dee6ff;
      font-weight: 800;
      font-size: 12px;
      cursor: pointer;
      color: #334155;
      transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
      white-space: nowrap;
    }
    .faq-tag:hover{ transform: translateY(-1px); box-shadow: 0 10px 18px rgba(94,139,255,0.16); }
    .faq-tag.active { background: var(--accent-soft); color: #2f4eb8; border-color: #c1d3ff; box-shadow: 0 8px 18px rgba(94,139,255,0.18); }
    .faq-body { display: grid; gap: 16px; grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr); margin-top: 12px; position: relative; z-index: 1; }
    .faq-list { display: grid; gap: 12px; }
    .faq-item{
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px 14px;
      background: #ffffff;
      cursor: pointer;
      text-align: left;
      font-family: inherit;
      appearance: none;
      -webkit-appearance: none;
      display: grid;
      grid-template-columns: 40px minmax(0, 1fr) 16px;
      gap: 12px;
      align-items: start;
      transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
    }
    .faq-item:hover{ transform: translateY(-1px); box-shadow: 0 12px 22px rgba(15,23,42,0.12); border-color: #d7e2ff; }
    .faq-item.active{ background: linear-gradient(135deg, #eef3ff, #ffffff); border-color: #c7d7ff; box-shadow: 0 14px 26px rgba(94,139,255,0.18); }
    .faq-item:focus-visible{ outline: 2px solid #aac4ff; outline-offset: 2px; }
    .faq-item-index{
      width: 36px;
      height: 36px;
      border-radius: 12px;
      background: #f0f4ff;
      color: #3b5ecc;
      font-weight: 800;
      display: grid;
      place-items: center;
      font-size: 12px;
      box-shadow: inset 0 0 0 1px #dbe5ff;
    }
    .faq-item-body { display: grid; gap: 6px; }
    .faq-item-head{ display: flex; align-items: center; justify-content: space-between; gap: 8px; }
    .faq-chip{ display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 999px; background: #eef2ff; color: #3b5ecc; font-size: 11px; font-weight: 700; }
    .faq-item-meta { font-size: 11px; color: #94a3b8; font-weight: 700; }
    .faq-item-title{ margin: 0; font-weight: 800; font-size: 14px; color: #1b2b3a; }
    .faq-item-preview{ color: #64748b; font-size: 12px; line-height: 1.5; margin: 0; }
    .faq-item-arrow{
      width: 12px;
      height: 12px;
      border-right: 2px solid #94a3b8;
      border-bottom: 2px solid #94a3b8;
      transform: rotate(-45deg);
      margin-top: 10px;
      justify-self: end;
    }
    .faq-detail{
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 18px;
      background: #ffffff;
      box-shadow: 0 12px 26px rgba(24,39,75,0.08);
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 260px;
      position: sticky;
      top: 110px;
    }
    .faq-detail-head { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .faq-detail-title{ font-size: 18px; margin: 0; color: #1b2b3a; }
    .faq-detail-answer{ color: #3d4b5a; line-height: 1.65; white-space: pre-wrap; }
    .faq-detail-meta{
      font-size: 12px;
      color: #3b5ecc;
      background: #eef3ff;
      border-radius: 999px;
      padding: 4px 10px;
      font-weight: 700;
    }
    .faq-empty{ text-align: center; color: var(--muted); padding: 16px; border: 1px dashed var(--border); border-radius: 12px; background: #ffffff; }
    .faq-status { margin-top: 12px; font-size: 12px; color: var(--muted); position: relative; z-index: 1; }

    footer { text-align: center; padding: 20px; color: #6c7b73; font-size: 12px; }
    @media (max-width: 700px) {
      h1 { font-size: 24px; }
      .hero { padding: 22px; }
    }
    @media (max-width: 900px) {
      .faq-hero { grid-template-columns: 1fr; }
      .faq-body { grid-template-columns: 1fr; }
      .faq-detail { position: static; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="foto/Dinkes.png" alt="Logo Dinkes" />
      <div class="title">Subkelompok Kepegawaian<br/><span style="font-weight:600;color:#4a5c55;">Dinas Kesehatan</span></div>
    </div>
    <div class="pill"><span class="dot"></span><span id="clock">Memuat...</span></div>
  </header>

  <main>
    <section class="hero">
      <div>
        <div class="tag">Informasi Kepegawaian</div>
        <h1>Layanan Kepegawaian Dinas Kesehatan Provinsi DKI Jakarta</h1>
        <p>Akses informasi perencanaan dan pendayagunaan pegawai, kesejahteraan pegawai, pengembangan karir, serta disiplin pegawai terintegrasi.</p>
        <a class="cta" href="#" aria-disabled="true">Baca Selengkapnya</a>
      </div>
      <div class="login-card">
        <h3>Masuk Sistem Informasi Data Pegawai</h3>
        <form id="loginForm">
          <div>
            <label>Username / UKPD ID</label>
            <input name="username" placeholder="Username" required />
          </div>
          <div style="margin-top:10px;">
            <label>Password</label>
            <div class="input-wrap">
              <input name="password" type="password" placeholder="Password" id="loginPassword" required />
              <button type="button" class="toggle-visibility" data-target="loginPassword" aria-label="Tampilkan password">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M12 5c5 0 9.27 3.11 11 7-1.73 3.89-6 7-11 7S2.73 15.89 1 12c1.73-3.89 6-7 11-7Zm0 2c-3.76 0-7.09 2.2-8.74 5 1.65 2.8 4.98 5 8.74 5s7.09-2.2 8.74-5C19.09 9.2 15.76 7 12 7Zm0 2.5A2.5 2.5 0 1 1 9.5 12 2.5 2.5 0 0 1 12 9.5Z" />
                </svg>
              </button>
            </div>
          </div>
          <button type="submit" class="btn" id="loginBtn" disabled>Masuk</button>
        </form>
        <div class="muted">Lupa password? Hubungi admin Kepegawaian</div>
        <div id="status" class="status">Status: menunggu koneksi server...</div>
      </div>
      <div class="bubble"></div>
      <div class="bubble small"></div>
    </section>

    <section class="faq-section">
      <div class="faq-card">
        <div class="faq-hero">
          <div class="faq-hero-text">
            <div class="faq-kicker">FAQ Layanan</div>
            <h3 class="faq-title">Pusat tanya jawab layanan kepegawaian</h3>
            <p class="faq-sub">Cari aturan, syarat, dan alur kerja mutasi atau pemutusan JF secara ringkas.</p>
            <div class="faq-search-wrap">
              <span class="faq-search-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                  <path d="M10 2a8 8 0 0 1 6.32 12.9l4.4 4.4-1.4 1.4-4.4-4.4A8 8 0 1 1 10 2Zm0 2a6 6 0 1 0 0 12 6 6 0 0 0 0-12Z"></path>
                </svg>
              </span>
              <input id="faqSearch" class="faq-search" placeholder="Cari pertanyaan..." />
              <div class="faq-count" id="faqCount">0 pertanyaan</div>
            </div>
          </div>
          <div class="faq-hero-panel">
            <div class="faq-panel-row">
              <span class="faq-panel-label">Total FAQ</span>
              <span class="faq-panel-value" id="faqCountBadge">0</span>
            </div>
            <div class="faq-panel-row">
              <span class="faq-panel-label">Status Data</span>
              <span class="faq-panel-value" id="faqStatusBadge">-</span>
            </div>
          </div>
        </div>
        <div class="faq-tags" id="faqTags"></div>
        <div class="faq-body">
          <div class="faq-list" id="faqList"></div>
          <div class="faq-detail" id="faqDetail">
            <div class="faq-detail-head">
              <div class="faq-chip" id="faqDetailCategory">Umum</div>
              <div class="faq-detail-meta" id="faqDetailMeta">Status: -</div>
            </div>
            <h4 class="faq-detail-title" id="faqDetailTitle">Pilih pertanyaan di daftar.</h4>
            <div class="faq-detail-answer" id="faqDetailAnswer">Jawaban akan tampil otomatis di sini.</div>
          </div>
        </div>
        <div class="faq-status" id="faqStatus">Status FAQ: menunggu data.</div>
      </div>
    </section>
  </main>

  <footer>(c) 2025 SI Data Informasi dan Layanan Keppegawaian. Sub Kelompok Kepegawaian Dinas Kesehatan Provinsi DKI Jakarta.</footer>

  <script src="loader.js?v=20251224-1"></script>


  <script>
    // --- BASE PATH FIX
    const BASE = (() => {
      const parts = location.pathname.split('/').filter(Boolean);
      return parts.length && parts[0].toUpperCase() === 'DATA_PEGAWAI' ? '/' + parts[0] + '/' : '/';
    })();

    // Fix favicon path (works in subfolder)
    const favicon = document.querySelector("link[rel='icon']");
    if (favicon) favicon.href = BASE + 'foto/Dinkes.png';

    // --- API SETUP
    const API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.protocol === 'file:')
      ? 'http://127.0.0.1:5002'
      : 'https://sikepeg.seftianh23.workers.dev';
    const PROXY_KEY = 'proxy_5b8d2f7c4a9e1b6d3c7f2a8b5e9d4c6a';
    const API_HEADERS = { 'X-Proxy-Key': PROXY_KEY };

    if (window.AppLoader) window.AppLoader.wrapFetch(API_BASE);

    const statusEl = document.getElementById('status');
    const loginBtn = document.getElementById('loginBtn');
    const loginForm = document.getElementById('loginForm');
    const clockEl = document.getElementById('clock');

    const faqList = document.getElementById('faqList');
    const faqTags = document.getElementById('faqTags');
    const faqSearch = document.getElementById('faqSearch');
    const faqStatus = document.getElementById('faqStatus');
    const faqDetailCategory = document.getElementById('faqDetailCategory');
    const faqDetailTitle = document.getElementById('faqDetailTitle');
    const faqDetailAnswer = document.getElementById('faqDetailAnswer');
    const faqDetailMeta = document.getElementById('faqDetailMeta');
    const faqCount = document.getElementById('faqCount');
    const faqCountBadge = document.getElementById('faqCountBadge');
    const faqStatusBadge = document.getElementById('faqStatusBadge');

    let serverReady = false;

    function setStatus(msg) { statusEl.textContent = 'Status: ' + msg; }

    // --- Clock
    function updateClock(){
      const now = new Date();
      const hari = now.toLocaleDateString('id-ID', { weekday:'long', day:'numeric', month:'long', year:'numeric' });
      const jam = now.toLocaleTimeString('id-ID', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
      if (clockEl) clockEl.textContent = hari + ' - ' + jam + ' WIB';
    }
    updateClock(); setInterval(updateClock, 1000);

    // --- FAQ
    const faqState = { items: [], categories: [], activeCategory: '', filtered: [], activeId: '' };
    const fallbackFaq = [
      { id: 'faq-1', category: 'Mutasi', question: 'Apa itu usulan mutasi pegawai?', answer: 'Usulan mutasi adalah proses pengajuan perpindahan pegawai untuk penempatan baru sesuai kebutuhan organisasi.' },
      { id: 'faq-2', category: 'Pemutusan JF', question: 'Kapan pemutusan jabatan fungsional diajukan?', answer: 'Pemutusan JF diajukan saat terdapat perubahan kebutuhan formasi atau kebijakan organisasi terkait jabatan fungsional.' },
      { id: 'faq-3', category: 'Akun', question: 'Bagaimana jika lupa password?', answer: 'Silakan hubungi admin Subkelompok Kepegawaian untuk reset atau bantuan akses akun.' }
    ];

    function escapeHtml(str){
      return String(str || '').replace(/[&<>"']/g, (ch) => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[ch]));
    }

    function toBadgeStatus(message){
      const text = String(message || '').toLowerCase();
      if (!text) return '-';
      if (text.includes('memuat')) return 'Memuat';
      if (text.includes('siap')) return 'Siap';
      if (text.includes('contoh')) return 'Contoh';
      if (text.includes('gagal')) return 'Gagal';
      return message || '-';
    }

    function setFaqStatus(message){
      if (faqStatus) faqStatus.textContent = 'Status FAQ: ' + message;
      if (faqStatusBadge) faqStatusBadge.textContent = toBadgeStatus(message);
    }

    function renderFaqTags(){
      if (!faqTags) return;
      const tags = ['Semua', ...faqState.categories];
      faqTags.innerHTML = tags.map((tag) => {
        const key = tag === 'Semua' ? '' : tag;
        const active = faqState.activeCategory === key;
        return `<span class="faq-tag${active ? ' active' : ''}" data-category="${escapeHtml(key)}">${escapeHtml(tag)}</span>`;
      }).join('');
    }

    function setActiveFaq(id){
      faqState.activeId = id || '';
      const active = faqState.filtered.find(item => String(item.id) === String(faqState.activeId));
      if (faqDetailCategory) faqDetailCategory.textContent = active?.category || 'Umum';
      if (faqDetailTitle) faqDetailTitle.textContent = active?.question || 'Pilih pertanyaan di daftar.';
      if (faqDetailAnswer) faqDetailAnswer.textContent = active?.answer || 'Jawaban akan tampil otomatis di sini.';
      if (faqDetailMeta) {
        const statusText = active?.status ? active.status : '-';
        faqDetailMeta.textContent = 'Status: ' + statusText;
      }
      if (faqList) {
        faqList.querySelectorAll('.faq-item').forEach((el) => {
          const isActive = el.dataset.id === faqState.activeId;
          el.classList.toggle('active', isActive);
          el.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        });
      }
    }

    function renderFaqList(list){
      if (!faqList) return;
      if (!list.length){
        faqList.innerHTML = '<div class="faq-empty">Belum ada FAQ yang ditampilkan.</div>';
        setActiveFaq('');
        return;
      }
      faqList.innerHTML = list.map((item, idx) => {
        const id = escapeHtml(item.id || `faq-${idx}`);
        const question = escapeHtml(item.question || '-');
        const rawAnswer = item.answer || '-';
        const category = escapeHtml(item.category || 'Umum');
        const previewText = rawAnswer.length > 120 ? `${rawAnswer.slice(0, 120)}...` : rawAnswer;
        const preview = escapeHtml(previewText);
        return `
          <button type="button" class="faq-item" data-id="${id}" aria-pressed="false">
            <div class="faq-item-index">${idx + 1}</div>
            <div class="faq-item-body">
              <div class="faq-item-head">
                <span class="faq-chip">${category}</span>
                <span class="faq-item-meta">FAQ ${idx + 1}</span>
              </div>
              <div class="faq-item-title">${question}</div>
              <div class="faq-item-preview">${preview || '-'}</div>
            </div>
            <div class="faq-item-arrow" aria-hidden="true"></div>
          </button>
        `;
      }).join('');
      const nextActive = faqState.activeId && list.some(item => String(item.id) === String(faqState.activeId))
        ? faqState.activeId
        : (list[0]?.id || '');
      setActiveFaq(nextActive);
    }

    function applyFaqFilters(){
      const term = (faqSearch?.value || '').toLowerCase().trim();
      const active = faqState.activeCategory;
      let list = faqState.items.slice();
      if (active) list = list.filter(item => (item.category || '').toLowerCase() === active.toLowerCase());
      if (term) {
        list = list.filter(item => {
          const q = (item.question || '').toLowerCase();
          const a = (item.answer || '').toLowerCase();
          return q.includes(term) || a.includes(term);
        });
      }
      faqState.filtered = list;
      renderFaqList(list);
      if (faqCount) faqCount.textContent = `${list.length} pertanyaan`;
      if (faqCountBadge) faqCountBadge.textContent = String(list.length);
    }

    async function loadFaq(){
      if (!faqList) return;
      setFaqStatus('memuat data...');
      try {
        const res = await fetch(`${API_BASE}?action=qna_list&status=published&limit=50`, { headers: API_HEADERS });
        const body = await res.json();
        if (!res.ok || !body.ok) throw new Error(body.error || 'Gagal memuat FAQ');
        const items = (body.rows || []).map((item, idx) => ({
          id: item.id || `faq-${idx + 1}`,
          category: item.category || 'Umum',
          question: item.question || '',
          answer: item.answer || '',
          status: item.status || ''
        })).filter(item => item.question);

        faqState.items = items.length ? items : fallbackFaq;
        faqState.categories = Array.from(new Set(faqState.items.map(i => i.category).filter(Boolean))).sort();
        faqState.activeCategory = '';
        faqState.activeId = '';
        renderFaqTags();
        applyFaqFilters();
        setFaqStatus(items.length ? 'data FAQ siap' : 'gunakan data contoh');
      } catch (err) {
        faqState.items = fallbackFaq;
        faqState.categories = Array.from(new Set(faqState.items.map(i => i.category))).sort();
        faqState.activeCategory = '';
        faqState.activeId = '';
        renderFaqTags();
        applyFaqFilters();
        setFaqStatus('gagal memuat FAQ, tampilkan contoh');
      }
    }

    async function checkServer() {
      try {
        const res = await fetch(API_BASE + '?action=health', { headers: API_HEADERS });
        const body = await res.json();
        if (res.ok && body.ok) {
          serverReady = true;
          loginBtn.disabled = false;
          setStatus('Server siap, Silahkan login.');
        } else {
          setStatus('Server tidak siap.');
        }
      } catch (err) {
        setStatus('Gagal konek server: ' + err.message);
      }
    }
    checkServer();

    if (faqTags) {
      faqTags.addEventListener('click', (e) => {
        const tag = e.target.closest('.faq-tag');
        if (!tag) return;
        faqState.activeCategory = tag.dataset.category || '';
        renderFaqTags();
        applyFaqFilters();
      });
    }
    if (faqSearch) {
      faqSearch.addEventListener('input', () => applyFaqFilters());
    }
    if (faqList) {
      faqList.addEventListener('click', (e) => {
        const item = e.target.closest('.faq-item');
        if (!item) return;
        setActiveFaq(item.dataset.id || '');
      });
    }
    loadFaq();

    // --- Password toggle
    function initPasswordToggles(){
      document.querySelectorAll('.toggle-visibility').forEach(btn => {
        const targetId = btn.getAttribute('data-target');
        const input = document.getElementById(targetId);
        if (!input) return;
        btn.setAttribute('data-state', 'hidden');
        btn.addEventListener('click', () => {
          const show = input.type === 'password';
          input.type = show ? 'text' : 'password';
          btn.setAttribute('data-state', show ? 'shown' : 'hidden');
          btn.setAttribute('aria-label', show ? 'Sembunyikan password' : 'Tampilkan password');
        });
      });
    }
    initPasswordToggles();

    // --- LOGIN (FIXED: token disimpan konsisten ke authUser.session)
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!serverReady) { setStatus('Server belum siap.'); return; }
      loginBtn.disabled = true;
      setStatus('Memproses login...');

      const data = new FormData(loginForm);
      const payload = {
        username: String(data.get('username') || ''),
        password: String(data.get('password') || ''),
      };

      try {
        const res = await fetch(API_BASE, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-Proxy-Key': PROXY_KEY },
          body: JSON.stringify({ action: 'login', ...payload })
        });

        const body = await res.json().catch(() => ({}));
        if (!res.ok || !body.ok) throw new Error(body.error || 'Login gagal');
        const userPayload = body.user || (body.data && body.data.user) || null;
        const sessionToken = body.session_token || (body.data && body.data.session_token) || body.session || (body.data && body.data.session);
        const sessionExpires = body.session_expires_in || (body.data && body.data.session_expires_in);
        if (!sessionToken) throw new Error('Token sesi tidak ditemukan dari server');
        const user = (userPayload && typeof userPayload === 'object') ? { ...userPayload } : { username: payload.username };
        user.session = sessionToken;
        if (sessionExpires) user.session_expires_in = sessionExpires;
        if (window.AppLoader && typeof window.AppLoader.setAuthUser === 'function') {
          window.AppLoader.setAuthUser(user);
        } else {
          localStorage.setItem('authUser', JSON.stringify(user));
          try { localStorage.setItem('lastActivityAt', String(Date.now())); } catch (_) { /* ignore */ }
        }
        setStatus('Login berhasil. Membuka home...');
        window.location.href = BASE + 'home/';
      } catch (err) {
        setStatus('Gagal login: ' + err.message);
      } finally {
        loginBtn.disabled = false;
      }
    });
  </script>
</body>
</html>

