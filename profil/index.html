<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Profil Pegawai</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="foto/Dinkes.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --border: #e2e6eb;
      --muted: #6b7280;
      --accent: #7c3aed;
      --success: #16a34a;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Plus Jakarta Sans','Inter','Segoe UI',Arial,sans-serif; background: linear-gradient(135deg, #f3f5fb 0%, #eef3ff 40%, #f8fff9 100%); color: #0f172a; }
    .layout { min-height: 100vh; }
    .content { margin-left: 260px; min-height: 100vh; display:flex; flex-direction:column; transition: margin .2s ease; }
    .sidebar { position: fixed; inset: 0 auto 0 0; width: 260px; background: #ffffff; color: #475569; padding: 18px 14px; display:flex; flex-direction:column; gap:18px; min-height: 100vh; box-shadow: 8px 0 30px -20px rgba(0,0,0,0.08); border-right:1px solid #e2e8f0; }
    .logo { display:flex; align-items:center; gap:10px; color:#0f172a; font-weight:800; }
    .logo img { width:38px; height:38px; object-fit:contain; }
    .logo-title { font-size:13px; text-transform:uppercase; letter-spacing:.2px; }
    .logo-sub { font-size:12px; color:#94a3b8; }
    nav { display:flex; flex-direction:column; gap:6px; }
    .nav-title { margin:18px 10px 6px; font-size:11px; letter-spacing:0.5px; text-transform:uppercase; color:#94a3b8; }
    .nav-item { display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; color:#475569; text-decoration:none; transition:all .15s ease; font-weight:600; }
    .nav-item:hover { background:#f8fafc; }
    .nav-item.active { background:#ede9fe; color:#6d28d9; font-weight:700; }
    .icon-round { width:26px; height:26px; border-radius:10px; background:#eef2ff; color:#4338ca; display:grid; place-items:center; font-size:12px; }
    .topbar { background:#fff; border-bottom:1px solid var(--border); padding:12px 18px; display:flex; align-items:center; justify-content:space-between; gap:12px; box-shadow: 0 6px 24px rgba(15,23,42,0.06); }
    .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .badge { display:inline-flex; align-items:center; gap:8px; background:#ede9fe; color:#6d28d9; padding:8px 12px; border-radius:999px; font-weight:700; font-size:13px; }
    .ghost-btn { padding:8px 10px; border:1px solid var(--border); border-radius:10px; background:#f8fafc; cursor:pointer; }
    .user { display:inline-flex; align-items:center; gap:10px; padding:8px 10px; background:#f8fafc; border-radius:999px; border:1px solid var(--border); }
    .user img { width:32px; height:32px; border-radius:10px; object-fit:cover; }
    .user-name { font-weight:800; }
    .user-role { font-size:12px; color:var(--muted); }
    .danger-btn { background:#ef4444; color:#fff; border:none; border-radius:10px; padding:9px 14px; cursor:pointer; font-weight:700; box-shadow: 0 8px 18px rgba(239,68,68,0.24); }
    main { padding:18px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.04); }
    .flex { display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap; }
    .avatar { width:110px; height:110px; border-radius:14px; object-fit:cover; background:#e5e7eb; }
    .info-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap:10px 16px; }
    .info-item { background:#f8fafc; border:1px solid var(--border); border-radius:10px; padding:10px 12px; }
    .info-label { color: var(--muted); font-weight:700; font-size:12px; letter-spacing:.3px; }
    .info-value { font-size:14px; margin-top:4px; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:8px 10px; border-radius:999px; background:#e0f2fe; color:#0369a1; font-weight:700; }
    .mobile-toggle{
      position: fixed; top: 14px; left: 14px; z-index: 70;
      background: #5e8bff; color: #f8fafc; border: 1px solid rgba(255,255,255,0.18);
      border-radius: 14px; padding: 10px 14px; display:none; align-items:center; gap:8px; font-weight:800;
      box-shadow: 0 12px 26px rgba(94,139,255,0.35);
    }
    #sidebarBackdrop{
      position: fixed; inset:0; background: rgba(0,0,0,0.45);
      opacity:0; pointer-events:none; transition: opacity .2s ease; z-index:50;
    }
    #sidebarBackdrop.show{ opacity:1; pointer-events:auto; }
    @media (max-width: 1100px){
      .content { margin-left: 0; }
      .sidebar{
        position: fixed; inset: 0 auto 0 0; width: calc(100vw - 72px); max-width: 280px;
        transform: translateX(-100%); transition: transform .2s ease; z-index: 60; min-height: 100vh;
        box-shadow: 8px 0 30px -20px rgba(0,0,0,0.5);
      }
      .sidebar.show{ transform: translateX(0); }
      .mobile-toggle{ display:inline-flex; }
      main { padding: 14px; margin-top: 20px; }
    }
    @media (max-width: 640px){
      .info-grid { grid-template-columns: 1fr; }
      .avatar { width:88px; height:88px; }
      .info-value { font-size:13px; }
      .info-label { font-size:11px; }
    }
  </style>
</head>
<body>
  <div id="sidebarBackdrop"></div>
  <button id="sidebarToggle" aria-label="Buka menu" class="mobile-toggle">
    <span style="font-size:18px;">&#9776;</span> Menu
  </button>
  <div class="layout">
    <div id="sidebar-container"></div>
    <div class="content">
      <div id="header-container"></div>
      <main>
        <div class="card flex">
          <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'><circle cx='60' cy='60' r='60' fill='%23e2e8f0'/><circle cx='60' cy='46' r='24' fill='%2394a3b8'/><path d='M18 108c4-24 26-36 42-36s38 12 42 36' fill='%2394a3b8'/></svg>" alt="Avatar" class="avatar" id="avatar" />
          <div>
            <div class="pill" id="pillRole">-</div>
            <h2 id="namaPegawai" style="margin:6px 0 4px;">Nama Pegawai</h2>
            <div style="color:var(--muted);" id="jabatanPegawai">Jabatan</div>
            <div style="margin-top:8px; font-weight:700;">Unit/UKPD: <span id="unitPegawai"></span></div>
            <div style="margin-top:6px; color:var(--muted);">Status Aktif: <span id="statusAktif"></span></div>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 12px;">Identitas</h3>
          <div class="info-grid">
            <div class="info-item"><div class="info-label">NIP</div><div class="info-value" id="nip">-</div></div>
            <div class="info-item"><div class="info-label">Jenis Kelamin</div><div class="info-value" id="jenisKelamin">-</div></div>
            <div class="info-item"><div class="info-label">Tempat / Tanggal Lahir</div><div class="info-value" id="ttl">-</div></div>
            <div class="info-item"><div class="info-label">Umur</div><div class="info-value" id="umur">-</div></div>
            <div class="info-item"><div class="info-label">Agama</div><div class="info-value" id="agama">-</div></div>
            <div class="info-item"><div class="info-label">Status Pernikahan</div><div class="info-value" id="statusNikah">-</div></div>
            <div class="info-item"><div class="info-label">Golongan Darah</div><div class="info-value" id="goldar">-</div></div>
            <div class="info-item"><div class="info-label">NPWP</div><div class="info-value" id="npwp">-</div></div>
            <div class="info-item"><div class="info-label">No BPJS</div><div class="info-value" id="bpjs">-</div></div>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 12px;">Kepegawaian</h3>
          <div class="info-grid">
            <div class="info-item"><div class="info-label">Jenis Pegawai</div><div class="info-value" id="jenisPegawai">-</div></div>
            <div class="info-item"><div class="info-label">Status Aktif</div><div class="info-value" id="statusAktifDetail">-</div></div>
            <div class="info-item"><div class="info-label">Status Rumpun</div><div class="info-value" id="statusRumpun">-</div></div>
            <div class="info-item"><div class="info-label">Jenis Kontrak</div><div class="info-value" id="jenisKontrak">-</div></div>
            <div class="info-item"><div class="info-label">Jabatan ORB</div><div class="info-value" id="jabatanOrb">-</div></div>
            <div class="info-item"><div class="info-label">Jabatan PRB</div><div class="info-value" id="jabatanPrb">-</div></div>
            <div class="info-item"><div class="info-label">TMT Kerja UKPD</div><div class="info-value" id="tmtKerja">-</div></div>
            <div class="info-item"><div class="info-label">UKPD</div><div class="info-value" id="ukpdDetail">-</div></div>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 12px;">Pendidikan & Gelar</h3>
          <div class="info-grid">
            <div class="info-item"><div class="info-label">Jenjang Pendidikan</div><div class="info-value" id="jenjang">-</div></div>
            <div class="info-item"><div class="info-label">Jurusan Pendidikan</div><div class="info-value" id="jurusan">-</div></div>
            <div class="info-item"><div class="info-label">Gelar Depan</div><div class="info-value" id="gelarDepan">-</div></div>
            <div class="info-item"><div class="info-label">Gelar Belakang</div><div class="info-value" id="gelarBelakang">-</div></div>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 12px;">Kontak & Alamat</h3>
          <div class="info-grid">
            <div class="info-item"><div class="info-label">Email</div><div class="info-value" id="emailPegawai">-</div></div>
            <div class="info-item"><div class="info-label">Telepon</div><div class="info-value" id="telpPegawai">-</div></div>
            <div class="info-item"><div class="info-label">Alamat KTP</div><div class="info-value" id="alamatKtp">-</div></div>
            <div class="info-item"><div class="info-label">Alamat Domisili</div><div class="info-value" id="alamatDomisili">-</div></div>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 12px;">Catatan</h3>
          <div class="info-item" style="background:#fff;">
            <div class="info-value" id="catatan">-</div>
          </div>
        </div>
      </main>
      <div id="footer-container"></div>
    </div>
  </div>

  <script src="../loader.js"></script>
  <script>
    const BASE = (() => {
      const parts = location.pathname.split('/').filter(Boolean);
      return parts.length && parts[0].toUpperCase() === 'DATA_PEGAWAI' ? '/' + parts[0] + '/' : '/';
    })();
    const favicon = document.querySelector("link[rel='icon']");
    if (favicon) favicon.href = BASE + 'foto/Dinkes.png';
    const API_BASE = 'https://sikepeg.seftianh23.workers.dev';
    const PROXY_KEY = 'proxy_5b8d2f7c4a9e1b6d3c7f2a8b5e9d4c6a';
    const API_HEADERS = { 'X-Proxy-Key': PROXY_KEY };
    if (window.AppLoader) window.AppLoader.wrapFetch(API_BASE);
    const sidebar = fetch(BASE + 'sidebar.html').then(r=>r.text()).catch(()=>''), header = fetch(BASE + 'header.html').then(r=>r.text()).catch(()=>''), footer = fetch(BASE + 'footer.html').then(r=>r.text()).catch(()=> '');
    Promise.all([sidebar, header, footer]).then(([s,h,f])=>{
      document.getElementById('sidebar-container').innerHTML = s;
      document.getElementById('header-container').innerHTML = h;
      document.getElementById('footer-container').innerHTML = f;
      const logoutBtn = document.getElementById('logoutBtn'); if (logoutBtn) logoutBtn.addEventListener('click', doLogout);
      const logoutNav = document.querySelector('[data-logout]');
      if (logoutNav) logoutNav.addEventListener('click', doLogout);
      document.querySelectorAll('[data-path]').forEach(a=> a.href = BASE + a.dataset.path);
      document.querySelectorAll('[data-logo],[data-logo-header]').forEach(img=> img.src = BASE + 'foto/Dinkes.png');
      updateHeaderUser(); setActiveNav(); initSidebarToggle();
    });

    const authUser = (() => { try { return JSON.parse(localStorage.getItem('authUser')||'null'); } catch { return null; } })();
    if (!authUser) { window.location.href = BASE; }
    const norm = (v='') => String(v || '').toLowerCase().trim();
    const roleLower = norm(authUser?.role);
    const isSuper = roleLower.includes('super') || roleLower.includes('dinkes');
    const isWilayahAdmin = roleLower.includes('wilayah');
    const loginUkpd = authUser?.namaUkpd || authUser?.username || '';
    const loginWilayah = authUser?.wilayah || '';
    document.body.classList.toggle('role-super', isSuper);

    function updateHeaderUser() {
      if (!authUser) return;
      const badge = document.querySelector('.badge');
      const uname = document.querySelector('.user-name');
      const urole = document.querySelector('.user-role');
      if (badge) badge.textContent = (authUser.role || '').toUpperCase() || 'USER';
      if (uname) uname.textContent = authUser.namaUkpd || authUser.username || 'User';
      if (urole) urole.textContent = authUser.role || '';
    }
    function initSidebarToggle(){
      const btn = document.getElementById('sidebarToggle');
      const backdrop = document.getElementById('sidebarBackdrop');
      const sidebarEl = document.querySelector('.sidebar');
      if (!btn || !backdrop || !sidebarEl) return;
      const close = ()=>{ sidebarEl.classList.remove('show'); backdrop.classList.remove('show'); document.body.style.overflow=''; };
      btn.addEventListener('click', ()=>{
        const willShow = !sidebarEl.classList.contains('show');
        sidebarEl.classList.toggle('show', willShow);
        backdrop.classList.toggle('show', willShow);
        document.body.style.overflow = willShow ? 'hidden' : '';
      });
      backdrop.addEventListener('click', close);
      sidebarEl.addEventListener('click', (e)=>{ if (e.target.closest('a')) close(); });
      window.addEventListener('resize', ()=>{ if (window.innerWidth >= 1100) close(); });
    }
    function setActiveNav() {
      document.querySelectorAll('.nav-item').forEach(a => {
        if (a.getAttribute('href') === BASE + 'profil/') a.classList.add('active');
        else a.classList.remove('active');
      });
    }
    function doLogout() {
      localStorage.removeItem('authUser');
      window.location.href = BASE;
    }

    function serialToDate(serial){
      const ms = Math.round((serial - 25569) * 86400 * 1000);
      return new Date(ms);
    }

    function parseDateValue(raw){
      if (!raw) return null;
      if (raw instanceof Date) return raw;
      const num = Number(raw);
      if (!Number.isNaN(num) && String(raw).trim() !== '') {
        if (num > 100000000000) return new Date(num);
        if (num > 59) return serialToDate(num);
      }
      const str = String(raw).trim();
      if (!str) return null;
      if (/^\d{4}-\d{2}-\d{2}/.test(str)) {
        const iso = new Date(str);
        if (!Number.isNaN(iso.getTime())) return iso;
      }
      const match = str.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})/);
      if (match) {
        let day = parseInt(match[1], 10);
        let month = parseInt(match[2], 10);
        let year = parseInt(match[3], 10);
        if (year < 100) year += 2000;
        return new Date(year, month - 1, day);
      }
      const parsed = Date.parse(str);
      return Number.isNaN(parsed) ? null : new Date(parsed);
    }

    function fmtDate(raw){
      const dt = parseDateValue(raw);
      if (!dt || Number.isNaN(dt.getTime())) return '-';
      return dt.toLocaleDateString('id-ID');
    }

    function formatTenure(raw){
      const dt = parseDateValue(raw);
      if (!dt || Number.isNaN(dt.getTime())) return '';
      const now = new Date();
      let years = now.getFullYear() - dt.getFullYear();
      let months = now.getMonth() - dt.getMonth();
      if (now.getDate() < dt.getDate()) months -= 1;
      if (months < 0) {
        years -= 1;
        months += 12;
      }
      if (years < 0) return '';
      if (years === 0 && months === 0) return '0 bulan';
      if (years === 0) return `${months} bulan`;
      if (months === 0) return `${years} tahun`;
      return `${years} tahun ${months} bulan`;
    }

    function formatAge(raw){
      const dt = parseDateValue(raw);
      if (!dt || Number.isNaN(dt.getTime())) return '';
      const now = new Date();
      let years = now.getFullYear() - dt.getFullYear();
      let months = now.getMonth() - dt.getMonth();
      if (now.getDate() < dt.getDate()) months -= 1;
      if (months < 0) {
        years -= 1;
        months += 12;
      }
      if (years < 0) return '';
      if (years === 0 && months === 0) return '0 bulan';
      if (years === 0) return `${months} bulan`;
      if (months === 0) return `${years} tahun`;
      return `${years} tahun ${months} bulan`;
    }

    function fillProfile(p){
      const gelarDepan = p.gelar_depan || '';
      const gelarBelakang = p.gelar_belakang || '';
      const namaInti = p.nama_pegawai || p.nama || '-';
      const namaFull = `${gelarDepan ? gelarDepan + ' ' : ''}${namaInti}${gelarBelakang ? ', ' + gelarBelakang : ''}`;
      document.getElementById('namaPegawai').textContent = namaFull.trim();
      document.getElementById('jabatanPegawai').textContent = p.nama_jabatan_orb || p.jabatan || '-';
      document.getElementById('unitPegawai').textContent = p.nama_ukpd || p.unit || p.ukpd || '-';
      document.getElementById('statusAktif').textContent = p.nama_status_aktif || p.aktif || '-';

      document.getElementById('nip').textContent = p.nip || '-';
      document.getElementById('jenisKelamin').textContent = p.jenis_kelamin || '-';
      const ttlDate = fmtDate(p.tanggal_lahir);
      const ttlParts = [p.tempat_lahir, ttlDate !== '-' ? ttlDate : ''].filter(Boolean);
      const ttlVal = ttlParts.length ? ttlParts.join(' / ') : '-';
      document.getElementById('ttl').textContent = ttlVal;
      const ageText = formatAge(p.tanggal_lahir);
      document.getElementById('umur').textContent = ageText || '-';
      document.getElementById('agama').textContent = p.agama || '-';
      document.getElementById('statusNikah').textContent = p.status_pernikahan || '-';
      document.getElementById('goldar').textContent = p.golongan_darah || '-';
      document.getElementById('npwp').textContent = p.npwp || '-';
      document.getElementById('bpjs').textContent = p.no_bpjs || '-';

      document.getElementById('jenisPegawai').textContent = p.nama_jenis_pegawai || '-';
      document.getElementById('statusAktifDetail').textContent = p.nama_status_aktif || '-';
      document.getElementById('statusRumpun').textContent = p.nama_status_rumpun || '-';
      document.getElementById('jenisKontrak').textContent = p.jenis_kontrak || '-';
      document.getElementById('jabatanOrb').textContent = p.nama_jabatan_orb || '-';
      document.getElementById('jabatanPrb').textContent = p.nama_jabatan_prb || '-';
      const tmtText = fmtDate(p.tmt_kerja_ukpd);
      const tenure = formatTenure(p.tmt_kerja_ukpd);
      document.getElementById('tmtKerja').textContent = tmtText === '-' ? '-' : `${tmtText}${tenure ? ' - ' + tenure : ''}`;
      document.getElementById('ukpdDetail').textContent = p.nama_ukpd || '-';

      document.getElementById('jenjang').textContent = p.jenjang_pendidikan || '-';
      document.getElementById('jurusan').textContent = p.jurusan_pendidikan || '-';
      document.getElementById('gelarDepan').textContent = p.gelar_depan || '-';
      document.getElementById('gelarBelakang').textContent = p.gelar_belakang || '-';

      document.getElementById('emailPegawai').textContent = p.email || '-';
      document.getElementById('telpPegawai').textContent = p.no_tlp || p.telepon || '-';
      document.getElementById('alamatKtp').textContent = p.alamat_ktp || '-';
      document.getElementById('alamatDomisili').textContent = p.alamat_domisili || '-';

      document.getElementById('catatan').textContent = p.catatan_revisi_biodata || p.catatan || '-';
      document.getElementById('pillRole').textContent = (p.nama_jenis_pegawai || p.statusKaryawan || 'PEGAWAI').toUpperCase();
    }

    async function loadProfil() {
      const selected = (()=>{ try { return JSON.parse(localStorage.getItem('selectedPegawai')||'null'); } catch { return null; } })();
      if (selected) { fillProfile(selected); return; }
      try {
        const params = new URLSearchParams();
        params.set('limit', '1');
        params.set('offset', '0');
        params.set('lite', '1');
        if (!isSuper) {
          if (isWilayahAdmin && loginWilayah) params.set('wilayah', loginWilayah);
          else if (loginUkpd) params.set('unit', loginUkpd);
        }
        const query = params.toString();
        const url = `${API_BASE}?action=list${query ? '&' + query : ''}`;
        const res = await fetch(url, { headers: API_HEADERS });
        const body = await res.json();
        if (!res.ok || !body.ok) throw new Error(body.error || 'Gagal ambil data');
        let data = body.rows || [];
        if (!isSuper) {
          if (isWilayahAdmin && loginWilayah) {
            const w = norm(loginWilayah);
            data = data.filter(d => {
              const wukpd = norm(d.wilayah_ukpd || '');
              const unitName = norm(d.nama_ukpd || d.ukpd || d.unit || '');
              return wukpd ? wukpd.includes(w) : unitName.includes(w);
            });
          } else {
            const ukpd = norm(loginUkpd);
            data = data.filter(d => norm(d.nama_ukpd || d.ukpd || d.unit || '') === ukpd);
          }
        }
        if (data.length === 0) return;
        fillProfile(data[0]);
      } catch (err) {
        console.error(err);
      }
    }

    loadProfil();
  </script>
</body>
</html>





