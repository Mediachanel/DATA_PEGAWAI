<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Usulan Mutasi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="foto/Dinkes.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg: #f4f6f6;
      --card: #ffffff;
      --border: #e4eaee;
      --muted: #6b7280;
      --ink: #152025;
      --accent: #0f9d94;
      --accent-2: #f59e0b;
      --accent-soft: #e9fbf8;
      --success: #16a34a;
      --warn: #f59e0b;
      --danger: #dc2626;
      --shadow-sm: 0 10px 24px rgba(15, 23, 42, 0.08);
      --shadow-md: 0 18px 44px rgba(15, 23, 42, 0.14);
      --ring: rgba(15, 157, 148, 0.25);
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:'Plus Jakarta Sans','Inter','Segoe UI',Arial,sans-serif; background:radial-gradient(circle at 12% 20%, rgba(15,157,148,0.12), transparent 35%), radial-gradient(circle at 86% 10%, rgba(245,158,11,0.12), transparent 40%), #f4f6f6; color:var(--ink); }
    .layout{ min-height:100vh; }
    .content{ margin-left:260px; min-height:100vh; display:flex; flex-direction:column; transition:margin .2s ease; }
    .sidebar{ position:fixed; inset:0 auto 0 0; width:260px; background:linear-gradient(180deg, #ffffff 0%, #f9fbfb 100%); color:#475569; padding:18px 14px; display:flex; flex-direction:column; gap:18px; min-height:100vh; box-shadow:8px 0 30px -20px rgba(15,23,42,0.12); border-right:1px solid var(--border); }
    .logo{ display:flex; align-items:center; gap:10px; color:#0f172a; font-weight:800; }
    .logo img{ width:38px; height:38px; object-fit:contain; }
    .logo-title{ font-size:13px; text-transform:uppercase; letter-spacing:.2px; }
    .logo-sub{ font-size:12px; color:#94a3b8; }
    nav{ display:flex; flex-direction:column; gap:6px; }
    .nav-title{ margin:18px 10px 6px; font-size:11px; letter-spacing:0.5px; text-transform:uppercase; color:#94a3b8; }
    .nav-item{ display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; color:#475569; text-decoration:none; transition:all .15s ease; font-weight:600; }
    .nav-item:hover{ background:#f7fbfb; }
    .nav-item.active{ background:var(--accent-soft); color:#0f7f73; font-weight:700; box-shadow:0 10px 22px rgba(15,157,148,0.2); }
    .icon-round{ width:26px; height:26px; border-radius:10px; background:rgba(15,157,148,0.12); color:#0f7f73; display:grid; place-items:center; font-size:12px; }
    .topbar{ background:linear-gradient(120deg, rgba(15,157,148,0.18), rgba(245,158,11,0.14)), #ffffff; border-bottom:1px solid var(--border); padding:12px 18px; display:flex; align-items:center; justify-content:space-between; gap:12px; box-shadow:0 10px 28px rgba(24,39,75,0.12); backdrop-filter:blur(6px); }
    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .badge{ display:inline-flex; align-items:center; gap:8px; background:var(--accent-soft); color:#0f7f73; padding:8px 12px; border-radius:999px; font-weight:700; font-size:13px; box-shadow:0 10px 20px rgba(15,157,148,0.18); }
    .hero{ background:#ffffff; color:var(--ink); border-radius:18px; padding:18px; display:flex; justify-content:space-between; gap:12px; align-items:center; box-shadow:var(--shadow-md); border:1px solid var(--border); position:relative; overflow:hidden; }
    .hero::before{ content:''; position:absolute; inset:0 0 auto 0; height:6px; background:linear-gradient(90deg, var(--accent), var(--accent-2)); }
    .hero h2{ margin:6px 0 0; color:#0f172a; font-size:26px; }
    .eyebrow{ margin:0; font-size:11px; letter-spacing:.6px; text-transform:uppercase; color:#94a3b8; font-weight:800; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; font-weight:700; font-size:12px; }
    .pill.role{ background:#e0f2fe; color:#0369a1; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:18px; padding:14px; box-shadow:var(--shadow-sm); }
    .metric-grid{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
    .metric{ border:1px solid #d9e3ee; border-radius:16px; padding:14px 16px; box-shadow:0 10px 22px rgba(15,23,42,0.05); }
    .metric .label{ color:#64748b; font-size:11px; text-transform:uppercase; letter-spacing:.6px; }
    .metric .value{ font-size:26px; font-weight:800; color:#111827; margin-top:4px; }
    .metric.blue{ background:linear-gradient(135deg, #eef6ff, #dbeeff); }
    .metric.orange{ background:linear-gradient(135deg, #fff7d6, #ffe9a8); }
    .metric.green{ background:linear-gradient(135deg, #e7fff5, #d6fce8); }
    .metric.red{ background:linear-gradient(135deg, #ffe8e8, #ffd6d6); }
    label{ font-size:12px; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:.4px; display:block; margin-bottom:6px; }
    input, select, textarea, button{ padding:10px 12px; border:1px solid var(--border); border-radius:12px; font-size:14px; font-family:'Plus Jakarta Sans','Inter','Segoe UI',Arial,sans-serif; }
    input, select, textarea{ width:100%; background:#f9fafb; }
    input:focus, select:focus, textarea:focus{ outline:2px solid var(--ring); border-color:#b8e6e1; }
    button.primary{ background:var(--accent); color:#ffffff; border:none; font-weight:800; box-shadow:0 15px 35px rgba(15,157,148,0.28); cursor:pointer; transition:transform .14s ease, box-shadow .14s ease, filter .14s ease; }
    button.primary:hover{ transform:translateY(-1px); filter:saturate(1.05); box-shadow:0 18px 40px rgba(15,157,148,0.32); }
    button.ghost{ background:#f7fbfb; color:#1f2a2e; border:1px solid var(--border); cursor:pointer; box-shadow:0 8px 18px rgba(24,39,75,0.06); }
    .table-wrap{ overflow-x:auto; }
    table{ width:100%; border-collapse:collapse; }
    th, td{ padding:9px 10px; border-bottom:1px solid var(--border); text-align:left; font-size:12.5px; vertical-align:top; }
    th{ background:#f3f6fb; text-transform:uppercase; letter-spacing:.6px; font-size:11.5px; color:#475569; position: sticky; top: 0; z-index: 1; }
    tbody tr:nth-child(even){ background:#fafcfd; }
    tbody tr:hover{ background:#f1f6fb; }
    .status-pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px; border:1px solid transparent; }
    .pill-info{ background:#e0f2fe; color:#0f5098; }
    .pill-success{ background:#dcfce7; color:#166534; }
    .pill-danger{ background:#fee2e2; color:#b91c1c; }
    .pill-warn{ background:#fef9c3; color:#92400e; }
    .actions{ display:flex; gap:6px; align-items:center; }
    .dropdown{ position:relative; }
    .dropdown-menu{
      position:absolute; top:100%; left:0; min-width:140px; background:#fff; border:1px solid var(--border);
      border-radius:12px; box-shadow:0 10px 28px rgba(15,23,42,0.12); padding:6px 0; display:none; z-index:10;
    }
    .dropdown.open .dropdown-menu{ display:block; }
    .dropdown-menu button{
      width:100%; text-align:left; background:none; border:none; padding:10px 14px; font-size:13px; cursor:pointer;
    }
    .dropdown-menu button:hover{ background:#f7fbfb; }
    .filters{ display:grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap:10px; align-items:end; }
    .pagination{ display:flex; gap:10px; align-items:center; justify-content:flex-end; margin-top:10px; flex-wrap:wrap; }
    .pill-abk{ display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px; background:#f7fbfb; border:1px solid var(--border); font-size:12px; }
    .mobile-toggle{
      position: fixed; top: 14px; left: 14px; z-index: 70;
      background: var(--accent); color: #f7fbfb; border: 1px solid rgba(255,255,255,0.18);
      border-radius: 14px; padding: 10px 14px; display:none; align-items:center; gap:8px; font-weight:800;
      box-shadow: 0 12px 26px rgba(18,183,166,0.35);
    }
    #sidebarBackdrop{
      position: fixed; inset:0; background: rgba(0,0,0,0.45);
      opacity:0; pointer-events:none; transition: opacity .2s ease; z-index:50;
    }
    #sidebarBackdrop.show{ opacity:1; pointer-events:auto; }
    /* Modal */
    .modal-backdrop{
      position: fixed; inset:0; background: rgba(15,23,42,0.35);
      opacity:0; pointer-events:none; transition: opacity .15s ease; z-index:80; backdrop-filter: blur(4px);
    }
    .modal-backdrop.show{ opacity:1; pointer-events:auto; }
    .modal{
      position: fixed; inset:0; display:flex; align-items:center; justify-content:center;
      opacity:0; pointer-events:none; z-index:90; transition: opacity .15s ease, transform .15s ease;
      padding:14px; transform: translateY(12px) scale(0.98);
    }
    .modal.show{ opacity:1; pointer-events:auto; transform: translateY(0) scale(1); }
    .modal-dialog{
      width: min(1100px, 100%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 18px 48px rgba(15,23,42,0.18);
      max-height: 90vh; overflow:auto;
    }
    .modal-head{
      padding: 16px 18px; border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .close-btn{
      background: none; border:1px solid var(--border); border-radius:10px;
      padding:8px 12px; cursor:pointer; font-weight:800;
    }
    .modal-body{ padding: 16px 18px 20px; }
    .detail-grid{ display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); }
    .detail-grid .full{ grid-column: 1 / -1; }
    .detail-card{ border:1px solid var(--border); border-radius:12px; padding:10px 12px; background:#f7fbfb; }
    .detail-label{ font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.3px; }
    .detail-value{ font-weight:700; margin-top:2px; }
    @media (max-width:1100px){
      .content{ margin-left:0; }
      .sidebar{
        position: fixed; inset: 0 auto 0 0; width: calc(100vw - 72px); max-width: 280px;
        transform: translateX(-100%); transition: transform .2s ease; z-index: 60; min-height: 100vh;
        box-shadow: 8px 0 30px -20px rgba(0,0,0,0.5);
      }
      .sidebar.show{ transform: translateX(0); }
      .mobile-toggle{ display:inline-flex; }
      main{ padding:14px; margin-top:20px; padding-top:62px; }
    }
  </style>
</head>
<body>
  <div id="sidebarBackdrop"></div>
  <button id="sidebarToggle" aria-label="Buka menu" class="mobile-toggle">
    <span style="font-size:18px;">&#9776;</span> Menu
  </button>
  <div class="layout">
    <div id="sidebar-container"></div>
    <div class="content">
      <div id="header-container"></div>
      <main style="padding:18px;">
        <div class="hero">
          <div>
            <p class="eyebrow">Mutasi</p>
            <div class="pill role" id="roleBadge">-</div>
            <h2>Usulan Mutasi Pegawai</h2>
          </div>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <button id="btnAdd" class="primary" style="min-width:150px;">+ Tambah Usulan</button>
          </div>
        </div>

        <div class="metric-grid" style="margin-top:12px;">
          <div class="metric blue">
            <div class="label">Total</div>
            <div class="value" id="mTotal">0</div>
          </div>
          <div class="metric blue">
            <div class="label">Diusulkan</div>
            <div class="value" id="mDiusulkan">0</div>
          </div>
          <div class="metric orange">
            <div class="label">Diproses</div>
            <div class="value" id="mProses">0</div>
          </div>
          <div class="metric green">
            <div class="label">Selesai</div>
            <div class="value" id="mSelesai">0</div>
          </div>
          <div class="metric red">
            <div class="label">Ditolak</div>
            <div class="value" id="mDitolak">0</div>
          </div>
        </div>

        <div class="card" style="margin-top:12px; display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <div>
            <h3 style="margin:0 0 4px;">Usulan Mutasi</h3>
            <div style="color:var(--muted); font-size:13px;">Total (sesuai filter): <span id="totalFiltered">0</span> data</div>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <select id="pageSize" style="width:auto;">
              <option value="10">10</option>
              <option value="20">20</option>
              <option value="50">50</option>
            </select>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <div class="filters" style="grid-template-columns: repeat(auto-fit, minmax(200px,1fr));">
            <div>
              <label>Status</label>
              <select id="statusFilter">
                <option value="">Semua</option>
                <option value="DIUSULKAN">Diusulkan</option>
                <option value="DIPROSES">Diproses</option>
                <option value="SELESAI">Selesai</option>
                <option value="DITOLAK">Ditolak</option>
                <option value="DITARIK">Ditarik</option>
              </select>
            </div>
            <div>
              <label>Cari Nama / NIP</label>
              <input id="search" placeholder="Ketik nama atau NIP">
            </div>
            <div>
              <label>UKPD Asal</label>
              <select id="ukpdFilter"><option value="">Semua</option></select>
            </div>
            <div>
              <label>UKPD Tujuan</label>
              <select id="tujuanFilter"><option value="">Semua</option></select>
            </div>
            <div style="display:flex; gap:8px; align-items:flex-end;">
              <button id="applyFilter" class="primary" style="width:auto;">Terapkan</button>
              <button id="resetFilter" class="ghost" style="width:auto;">Reset</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>#</th><th>Status</th><th>Aksi</th><th>Nama / NIP / Pangkat</th><th>Jabatan</th><th>UKPD Asal</th><th>UKPD Tujuan</th><th>Jabatan Baru</th><th>ABK &amp; Bezetting (Lama)</th><th>ABK &amp; Bezetting (Baru)</th><th>Alasan</th><th>Berkas</th><th>Created By UKPD</th><th>Created At</th><th>Updated At</th><th>Keterangan</th>
                </tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
          <div class="pagination">
            <button class="ghost" id="prevPage">Sebelumnya</button>
            <div>Halaman <span id="pageNow">1</span> / <span id="pageTotal">1</span></div>
            <button class="ghost" id="nextPage">Berikutnya</button>
          </div>
        </div>
      </main>
      <div id="footer-container"></div>
    </div>
  </div>

  <div class="modal-backdrop" id="modalBackdrop"></div>

  <div class="modal" id="formModal" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-head">
        <h3 class="panel-title" id="formTitle" style="margin:0;">Tambah Usulan Mutasi</h3>
        <button type="button" class="close-btn" id="closeForm" aria-label="Tutup">×</button>
      </div>
      <div class="modal-body">
        <form id="mutasiForm" class="detail-grid">
          <div>
            <label>UKPD Asal</label>
            <select id="ukpdAsalSelect"></select>
            <input type="hidden" name="nama_ukpd" id="namaUkpdHidden">
          </div>
          <div>
            <label>Nama Pegawai (Bezetting)</label>
            <select name="nama_pegawai" id="pegawaiSelect" required>
              <option value="">Pilih pegawai</option>
            </select>
          </div>
          <div><label>NIP</label><input name="nip" id="nipInput" placeholder="NIP" required readonly></div>
          <div><label>Gelar Depan</label><input name="gelar_depan" placeholder="Gelar depan"></div>
          <div><label>Gelar Belakang</label><input name="gelar_belakang" placeholder="Gelar belakang"></div>
          <div><label>Pangkat / Golongan</label><input name="pangkat_golongan" id="pangkatInput" placeholder="Pangkat / golongan" readonly></div>
          <div><label>Jabatan (Saat Ini)</label><input name="jabatan" id="jabatanInput" placeholder="Jabatan saat ini" readonly></div>
          <div><label>Jenis Mutasi</label>
            <select name="jenis_mutasi">
              <option value="">Pilih</option>
              <option>Mutasi</option>
              <option>Rotasi</option>
              <option>Promosi</option>
              <option>Demosi</option>
            </select>
          </div>
          <div><label>Tanggal Usulan</label><input type="date" name="tanggal_usulan" id="tanggalUsulan"></div>
          <div><label>Status</label>
            <select name="status">
              <option value="DIUSULKAN">DIUSULKAN</option>
              <option value="DIPROSES">DIPROSES</option>
              <option value="SELESAI">SELESAI</option>
              <option value="DITOLAK">DITOLAK</option>
              <option value="DITARIK">DITARIK</option>
            </select>
          </div>
          <div>
            <label>UKPD Tujuan</label>
            <select name="ukpd_tujuan" id="ukpdTujuanSelect">
              <option value="">Pilih UKPD tujuan</option>
            </select>
          </div>
          <div>
            <label>Jabatan Baru (Bezetting)</label>
            <select id="jabatanBaruSelect">
              <option value="">Pilih jabatan baru</option>
            </select>
          </div>
          <div><label>Jabatan Baru</label><input name="jabatan_baru" id="jabatanBaruInput" placeholder="Jabatan baru" readonly></div>
          <div><label>ABK PNS (Lama)</label><input name="abk_j_lama" id="abkLamaInput" placeholder="ABK J lama" readonly></div>
          <div><label>Bezetting PNS (Lama)</label><input name="bezetting_j_lama" id="bezettingLamaInput" placeholder="Bezetting J lama" readonly></div>
          <div><label>Non-ASN Bezetting Lama</label><input name="nonasn_bezetting_lama" placeholder="Non-ASN bezetting lama"></div>
          <div><label>Non-ASN ABK Lama</label><input name="nonasn_abk_lama" placeholder="Non-ASN ABK lama"></div>
          <div><label>ABK PNS (Baru)</label><input name="abk_j_baru" id="abkBaruInput" placeholder="ABK J baru" readonly></div>
          <div><label>Bezetting PNS (Baru)</label><input name="bezetting_j_baru" id="bezettingBaruInput" placeholder="Bezetting J baru" readonly></div>
          <div><label>Non-ASN Bezetting Baru</label><input name="nonasn_bezetting_baru" placeholder="Non-ASN bezetting baru"></div>
          <div><label>Non-ASN ABK Baru</label><input name="nonasn_abk_baru" placeholder="Non-ASN ABK baru"></div>
          <div><label>Mutasi ID</label><input name="mutasi_id" placeholder="Mutasi ID (opsional)"></div>
          <div><label>Berkas (URL/Path)</label><input name="berkas_path" placeholder="https://... atau path" inputmode="url"></div>
          <div style="grid-column:1/-1;"><label>Alasan</label><textarea name="alasan" placeholder="Alasan mutasi"></textarea></div>
          <div style="grid-column:1/-1;"><label>Verifikasi Checklist</label><textarea name="verif_checklist" placeholder="Checklist verifikasi..."></textarea></div>
          <div style="grid-column:1/-1;"><label>Keterangan / Verifikasi</label><textarea name="keterangan" placeholder="Catatan verifikasi..."></textarea></div>
          <div style="display:flex; gap:10px; justify-content:flex-end; grid-column:1/-1;">
            <button type="button" class="ghost" id="resetForm">Reset</button>
            <button type="submit" class="primary" id="submitBtn">Simpan</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal" id="viewModal" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-head">
        <h3 class="panel-title" style="margin:0;">Detail Usulan</h3>
        <button type="button" class="close-btn" id="closeView" aria-label="Tutup">×</button>
      </div>
      <div class="modal-body">
        <div class="detail-grid" id="detailGrid"></div>
        <div style="margin-top:12px;">
          <label>Alasan</label>
          <div id="detailAlasan" style="white-space:pre-wrap; background:#f7fbfb; border:1px solid var(--border); border-radius:10px; padding:10px;"></div>
        </div>
        <div style="margin-top:12px;">
          <label>Keterangan / Verifikasi</label>
          <div id="detailKet" style="white-space:pre-wrap; background:#f7fbfb; border:1px solid var(--border); border-radius:10px; padding:10px;"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="validateModal" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-head">
        <h3 class="panel-title" id="validateTitle" style="margin:0;">Validasi Usulan Mutasi</h3>
        <button type="button" class="close-btn" id="closeValidate" aria-label="Tutup">x</button>
      </div>
      <div class="modal-body">
        <form id="validateForm" class="detail-grid">
          <div>
            <label>Status</label>
            <select name="status" id="validateStatus">
              <option value="DIUSULKAN">DIUSULKAN</option>
              <option value="DIPROSES">DIPROSES</option>
              <option value="SELESAI">SELESAI</option>
              <option value="DITOLAK">DITOLAK</option>
              <option value="DITARIK">DITARIK</option>
            </select>
          </div>
          <div class="full">
            <label>Keterangan / Catatan Dinkes</label>
            <textarea name="keterangan" id="validateNote" placeholder="Catatan hasil validasi..."></textarea>
          </div>
          <div style="display:flex; gap:10px; justify-content:flex-end; grid-column:1/-1;">
            <button type="button" class="ghost" id="resetValidate">Reset</button>
            <button type="submit" class="primary">Simpan Validasi</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="../loader.js"></script>
  <script>
    const BASE = (() => {
      const parts = location.pathname.split('/').filter(Boolean);
      if (parts.length && parts[0].toUpperCase() === 'DATA_PEGAWAI') return '/' + parts[0] + '/';
      if (parts.length > 1) return '../';
      return '/';
    })();
    const favicon = document.querySelector("link[rel='icon']");
    if (favicon) favicon.href = BASE + 'foto/Dinkes.png';
    const API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.protocol === 'file:')
      ? 'http://127.0.0.1:5002'
      : 'https://sikepeg.seftianh23.workers.dev';
    const PROXY_KEY = 'proxy_5b8d2f7c4a9e1b6d3c7f2a8b5e9d4c6a';
    const API_HEADERS = { 'X-Proxy-Key': PROXY_KEY };
    if (window.AppLoader) window.AppLoader.wrapFetch(API_BASE);
    const sidebar = fetch(BASE + 'sidebar.html').then(r=>r.text()).catch(()=>''), header = fetch(BASE + 'header.html').then(r=>r.text()).catch(()=>''), footer = fetch(BASE + 'footer.html').then(r=>r.text()).catch(()=> '');
    Promise.all([sidebar, header, footer]).then(([s,h,f])=>{
      document.getElementById('sidebar-container').innerHTML = s;
      document.getElementById('header-container').innerHTML = h;
      document.getElementById('footer-container').innerHTML = f;
      document.querySelectorAll('[data-path]').forEach(a=> a.href = BASE + a.dataset.path);
      document.querySelectorAll('[data-logo],[data-logo-header]').forEach(img=> img.src = BASE + 'foto/Dinkes.png');
      document.querySelector('.nav-item.active')?.classList.remove('active');
        const mLink = Array.from(document.querySelectorAll('.nav-item')).find(a=>a.textContent.trim().toLowerCase().includes('usulan mutasi'));
        if (mLink) mLink.classList.add('active');
        document.getElementById('logoutBtn')?.addEventListener('click', doLogout);
        const logoutNav = document.querySelector('[data-logout]');
        if (logoutNav) logoutNav.addEventListener('click', doLogout);
        initSidebarToggle();
        syncHeaderUser();
      });

    const authUser = (()=>{ try { return JSON.parse(localStorage.getItem('authUser')||'null'); } catch { return null; } })();
    if (!authUser) { window.location.href = BASE; }
    const norm = (v='') => String(v || '').toLowerCase().trim();
    const roleLower = norm(authUser?.role);
    const isSuper = roleLower.includes('super') || roleLower.includes('dinkes');
    const isWilayahAdmin = roleLower.includes('wilayah');
    const loginUkpd = authUser?.namaUkpd || authUser?.username || '';
    const loginWilayah = authUser?.wilayah || '';
    document.body.classList.toggle('role-super', isSuper);

    let editingId = null;
    let cacheRows = [];
    let page = 1;
    let totalPages = 1;
    let currentLimit = 10;
    const STATUS_ORDER = { DIUSULKAN: 1, DIPROSES: 2, SELESAI: 3, DITOLAK: 4, DITARIK: 5 };
    const STATUS_LABELS = {
      DIUSULKAN: 'Diusulkan',
      DIPROSES: 'Diproses',
      SELESAI: 'Selesai',
      DITOLAK: 'Ditolak',
      DITARIK: 'Ditarik'
    };
    const bezettingState = { allUkpds: null, wilayahUkpds: null, byUkpd: new Map() };

    const form = document.getElementById('mutasiForm');
    const ukpdAsalSelect = document.getElementById('ukpdAsalSelect');
    const namaUkpdHidden = document.getElementById('namaUkpdHidden');
    const pegawaiSelect = document.getElementById('pegawaiSelect');
    const nipInput = document.getElementById('nipInput');
    const pangkatInput = document.getElementById('pangkatInput');
    const jabatanInput = document.getElementById('jabatanInput');
    const tanggalUsulanInput = document.getElementById('tanggalUsulan');
    const ukpdTujuanSelect = document.getElementById('ukpdTujuanSelect');
    const jabatanBaruSelect = document.getElementById('jabatanBaruSelect');
    const jabatanBaruInput = document.getElementById('jabatanBaruInput');
    const abkLamaInput = document.getElementById('abkLamaInput');
    const bezettingLamaInput = document.getElementById('bezettingLamaInput');
    const abkBaruInput = document.getElementById('abkBaruInput');
    const bezettingBaruInput = document.getElementById('bezettingBaruInput');
    const resetFormBtn = document.getElementById('resetForm');
    const tableBody = document.getElementById('tableBody');
    const search = document.getElementById('search');
    const statusFilter = document.getElementById('statusFilter');
    const ukpdFilter = document.getElementById('ukpdFilter');
    const tujuanFilter = document.getElementById('tujuanFilter');
    const applyFilter = document.getElementById('applyFilter');
    const resetFilter = document.getElementById('resetFilter');
    const pageSize = document.getElementById('pageSize');
    const pageNow = document.getElementById('pageNow');
    const pageTotal = document.getElementById('pageTotal');
    const prevPage = document.getElementById('prevPage');
    const nextPage = document.getElementById('nextPage');
    const btnAdd = document.getElementById('btnAdd');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const formModal = document.getElementById('formModal');
    const viewModal = document.getElementById('viewModal');
    const validateModal = document.getElementById('validateModal');
    const validateForm = document.getElementById('validateForm');
    const validateStatus = document.getElementById('validateStatus');
    const validateNote = document.getElementById('validateNote');
    const validateTitle = document.getElementById('validateTitle');
    const closeForm = document.getElementById('closeForm');
    const closeView = document.getElementById('closeView');
    const closeValidate = document.getElementById('closeValidate');
    const formTitle = document.getElementById('formTitle');
    const submitBtn = document.getElementById('submitBtn');
    const detailGrid = document.getElementById('detailGrid');
    const detailAlasan = document.getElementById('detailAlasan');
    const detailKet = document.getElementById('detailKet');
    const totalFiltered = document.getElementById('totalFiltered');
    const roleBadge = document.getElementById('roleBadge');
    const userNameEl = document.getElementById('userName');
    const userRoleEl = document.getElementById('userRole');
    const resetValidate = document.getElementById('resetValidate');
    const TEMPLATE_PATH = `${BASE}templates/usulan-mutasi-kajian.html`;
    let validatingRow = null;
    let templateCache = null;

    function showModal(el){
      el.classList.add('show');
      modalBackdrop.classList.add('show');
      el.setAttribute('aria-hidden','false');
    }
    function hideModal(el){
      el.classList.remove('show');
      const modals = [formModal, viewModal, validateModal].filter(Boolean);
      if (!modals.some(m=>m.classList.contains('show'))) {
        modalBackdrop.classList.remove('show');
      }
      el.setAttribute('aria-hidden','true');
    }

    function normalizeStatus(value){
      const raw = String(value || '').trim().toUpperCase();
      if (!raw) return '';
      if (raw === 'DISETUJUI' || raw === 'SELESAI') return 'SELESAI';
      if (raw === 'DIPROSES' || raw === 'PROSES' || raw === 'DALAM PROSES') return 'DIPROSES';
      if (raw === 'DIUSULKAN' || raw === 'USULAN') return 'DIUSULKAN';
      if (raw === 'DITOLAK' || raw === 'TOLAK') return 'DITOLAK';
      if (raw === 'DITARIK' || raw === 'DICABUT') return 'DITARIK';
      return raw;
    }

    function escapeHtml(str){
      return String(str || '').replace(/[&<>"']/g, (ch) => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[ch]));
    }


    function safeUrl(value){
      const raw = String(value || '').trim();
      if (!raw) return '';
      const lower = raw.toLowerCase();
      if (lower.startsWith('http://') || lower.startsWith('https://')) return raw;
      return '';
    }

    function formatMultiline(value){
      return escapeHtml(value || '').replace(/\n/g, '<br>');
    }

    function formatStatusLabel(value){
      const key = normalizeStatus(value);
      return escapeHtml(STATUS_LABELS[key] || (value ? String(value) : '-'));
    }

    function getKeteranganText(row){
      const note = String(row?.keterangan || '').trim();
      if (note) return note;
      const statusKey = normalizeStatus(row?.status || '');
      if (!statusKey) return '-';
      const label = STATUS_LABELS[statusKey] || statusKey;
      return `Status: ${label}`;
    }

    function sanitizeFilename(value){
      return String(value || '')
        .replace(/[\\\/:*?"<>|]+/g, '')
        .replace(/\s+/g, ' ')
        .trim();
    }

    function formatAbkPlain(abk, bezetting, nonasnAbk, nonasnBezetting){
      const parts = [
        `ASN: ${String(abk || '-')} | Bezetting: ${String(bezetting || '-')}`
      ];
      if (nonasnAbk || nonasnBezetting) {
        parts.push(`Non-ASN: ${String(nonasnAbk || '-')} | Bezetting: ${String(nonasnBezetting || '-')}`);
      }
      return parts.join(' ; ');
    }

    function toNumeric(value){
      if (value === null || value === undefined) return null;
      const raw = String(value).trim();
      if (!raw) return null;
      const cleaned = raw.replace(',', '.').replace(/[^0-9.\-]/g, '');
      if (!cleaned) return null;
      const num = Number(cleaned);
      return Number.isFinite(num) ? num : null;
    }

    function formatNum(value){
      if (value === null || value === undefined || value === '') return '-';
      const num = Number(value);
      if (!Number.isFinite(num)) return String(value);
      return Number.isInteger(num) ? String(num) : String(num);
    }

    async function loadWordTemplate(){
      if (templateCache) return templateCache;
      const res = await fetch(TEMPLATE_PATH, { cache: 'no-store' });
      if (!res.ok) throw new Error('Template Word tidak ditemukan');
      templateCache = await res.text();
      return templateCache;
    }

    function renderTemplate(template, data){
      return template.replace(/{{\s*([a-z0-9_]+)\s*}}/gi, (match, key) => {
        const k = String(key || '').toLowerCase();
        return Object.prototype.hasOwnProperty.call(data, k) ? data[k] : '';
      });
    }

    function buildWordMap(row){
      const nama = formatNama(row) || row.nama_pegawai || '-';
      const berkasUrl = safeUrl(row.berkas_path);
      const nowText = new Date().toLocaleDateString('id-ID');
      const validator = (userNameEl?.textContent || authUser?.namaUkpd || authUser?.username || 'Admin Dinkes').trim();
      const pnsBLama = toNumeric(row.bezetting_j_lama);
      const pnsKLama = toNumeric(row.abk_j_lama);
      const pnsSLama = (pnsBLama !== null && pnsKLama !== null) ? (pnsBLama - pnsKLama) : null;
      const nonPnsBLama = toNumeric(row.nonasn_bezetting_lama);
      const nonPnsKLama = toNumeric(row.nonasn_abk_lama);
      const nonPnsSLama = (nonPnsBLama !== null && nonPnsKLama !== null) ? (nonPnsBLama - nonPnsKLama) : null;
      const pnsBBaru = toNumeric(row.bezetting_j_baru);
      const pnsKBaru = toNumeric(row.abk_j_baru);
      const pnsSBaru = (pnsBBaru !== null && pnsKBaru !== null) ? (pnsBBaru - pnsKBaru) : null;
      const nonPnsBBaru = toNumeric(row.nonasn_bezetting_baru);
      const nonPnsKBaru = toNumeric(row.nonasn_abk_baru);
      const nonPnsSBaru = (nonPnsBBaru !== null && nonPnsKBaru !== null) ? (nonPnsBBaru - nonPnsKBaru) : null;
      return {
        id: escapeHtml(row.id || '-'),
        mutasi_id: escapeHtml(row.mutasi_id || '-'),
        no: '1',
        nama_pegawai: escapeHtml(nama),
        nip: escapeHtml(row.nip || '-'),
        gelar_depan: escapeHtml(row.gelar_depan || '-'),
        gelar_belakang: escapeHtml(row.gelar_belakang || '-'),
        pangkat_golongan: escapeHtml(row.pangkat_golongan || '-'),
        jabatan: escapeHtml(row.jabatan || '-'),
        jabatan_lama: escapeHtml(row.jabatan || '-'),
        jabatan_baru: escapeHtml(row.jabatan_baru || '-'),
        jenis_mutasi: escapeHtml(row.jenis_mutasi || '-'),
        tempat_tugas_lama: escapeHtml(row.nama_ukpd || '-'),
        tempat_tugas_baru: escapeHtml(row.ukpd_tujuan || '-'),
        ukpd_asal: escapeHtml(row.nama_ukpd || '-'),
        ukpd_tujuan: escapeHtml(row.ukpd_tujuan || '-'),
        pns_b_lama: formatNum(pnsBLama),
        pns_k_lama: formatNum(pnsKLama),
        pns_s_lama: formatNum(pnsSLama),
        nonpns_b_lama: formatNum(nonPnsBLama),
        nonpns_k_lama: formatNum(nonPnsKLama),
        nonpns_s_lama: formatNum(nonPnsSLama),
        pns_b_baru: formatNum(pnsBBaru),
        pns_k_baru: formatNum(pnsKBaru),
        pns_s_baru: formatNum(pnsSBaru),
        nonpns_b_baru: formatNum(nonPnsBBaru),
        nonpns_k_baru: formatNum(nonPnsKBaru),
        nonpns_s_baru: formatNum(nonPnsSBaru),
        alasan: formatMultiline(row.alasan || '-'),
        verif_checklist: formatMultiline(row.verif_checklist || '-'),
        hasil_validasi: formatMultiline(row.keterangan || '-'),
        keterangan: formatMultiline(row.keterangan || '-'),
        status: formatStatusLabel(row.status || '-'),
        created_by_ukpd: escapeHtml(row.created_by_ukpd || '-'),
        tanggal_usulan: escapeHtml(formatDateDisplay(row.tanggal_usulan)),
        created_at: escapeHtml(formatDateDisplay(row.created_at)),
        updated_at: escapeHtml(formatDateDisplay(row.updated_at)),
        berkas: berkasUrl ? `<a href="${escapeHtml(berkasUrl)}">${escapeHtml(berkasUrl)}</a>` : '-',
        tanggal_cetak: escapeHtml(nowText),
        validator: escapeHtml(validator)
      };
    }

    async function exportWord(row){
      const template = await loadWordTemplate();
      const html = renderTemplate(template, buildWordMap(row));
      const filenameBase = sanitizeFilename(row?.nama_pegawai || row?.id || 'mutasi');
      const blob = new Blob(['\ufeff', html], { type: 'application/msword;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Kajian Mutasi - ${filenameBase}.doc`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=> URL.revokeObjectURL(url), 1000);
    }

    function parseDateValue(value){
      if (!value) return 0;
      if (value instanceof Date) return value.getTime();
      if (typeof value === 'number' && !Number.isNaN(value)) {
        if (value < 100000000000) return serialToDate(value).getTime();
        return value;
      }
      const str = String(value).trim();
      if (!str) return 0;
      const parsed = Date.parse(str);
      if (!Number.isNaN(parsed)) return parsed;
      const match = str.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})/);
      if (match) {
        const day = parseInt(match[1], 10);
        const month = parseInt(match[2], 10) - 1;
        let year = parseInt(match[3], 10);
        if (year < 100) year += 2000;
        const dt = new Date(year, month, day);
        return Number.isNaN(dt.getTime()) ? 0 : dt.getTime();
      }
      return 0;
    }

    function serialToDate(serial){
      const ms = Math.round((serial - 25569) * 86400 * 1000);
      return new Date(ms);
    }

    function formatDateParts(date){
      if (!(date instanceof Date) || Number.isNaN(date.getTime())) return '-';
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${d}/${m}/${y}`;
    }

    function formatDateDisplay(value){
      if (value === null || value === undefined) return '-';
      const raw = String(value).trim();
      if (!raw || raw === '#######') return '-';
      if (typeof value === 'number' && !Number.isNaN(value)) {
        const date = value > 100000000000 ? new Date(value) : serialToDate(value);
        return formatDateParts(date);
      }
      const parsed = Date.parse(raw);
      if (!Number.isNaN(parsed)) return formatDateParts(new Date(parsed));
      return raw;
    }

    function getRowTimestamp(row){
      return parseDateValue(row.updated_at) || parseDateValue(row.created_at) || parseDateValue(row.tanggal_usulan) || 0;
    }

    function sortRows(rows){
      return (rows || []).slice().sort((a, b) => {
        const aKey = normalizeStatus(a.status);
        const bKey = normalizeStatus(b.status);
        const aOrder = STATUS_ORDER[aKey] || 99;
        const bOrder = STATUS_ORDER[bKey] || 99;
        if (aOrder !== bOrder) return aOrder - bOrder;
        const aTime = getRowTimestamp(a);
        const bTime = getRowTimestamp(b);
        if (aTime !== bTime) return bTime - aTime;
        return String(b.id || '').localeCompare(String(a.id || ''));
      });
    }

    function badgeStatus(val){
      const v = normalizeStatus(val);
      if (v === 'SELESAI') return '<span class="status-pill pill-success">Selesai</span>';
      if (v === 'DITOLAK') return '<span class="status-pill pill-danger">Ditolak</span>';
      if (v === 'DIPROSES') return '<span class="status-pill pill-warn">Diproses</span>';
      if (v === 'DITARIK') return '<span class="status-pill pill-warn">Ditarik</span>';
      if (v === 'DIUSULKAN') return '<span class="status-pill pill-info">Diusulkan</span>';
      return `<span class="status-pill pill-info">${formatStatusLabel(val)}</span>`;
    }

    function formatNama(row){
      const parts = [row.gelar_depan, row.nama_pegawai, row.gelar_belakang].filter(Boolean);
      return parts.join(' ').replace(/\s+/g, ' ').trim();
    }

    function formatAbk(abk, bezetting, nonasnAbk, nonasnBezetting){
      const asn = `ASN: ${escapeHtml(abk || '-')} | Bezetting: ${escapeHtml(bezetting || '-')}`;
      const nonasn = (nonasnAbk || nonasnBezetting)
        ? `<div class="pill-abk">Non-ASN: ${escapeHtml(nonasnAbk || '-')} | Bezetting: ${escapeHtml(nonasnBezetting || '-')}</div>`
        : '';
      return `<div class="pill-abk">${asn}</div>${nonasn}`;
    }

    function todayIso(){
      return new Date().toISOString().slice(0, 10);
    }

    function getJabatanOrb(row){
      return row.jabatan_orb || row.nama_jabatan_pergub || row.nama_jabatan_permenpan || row.jabatan || '';
    }

    function resetSelect(select, placeholder){
      if (!select) return;
      select.innerHTML = '';
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = placeholder || 'Pilih';
      select.appendChild(opt);
    }

    function addSelectOption(select, value, label, dataset){
      if (!select) return;
      const opt = document.createElement('option');
      opt.value = value;
      opt.textContent = label || value;
      if (dataset) {
        Object.entries(dataset).forEach(([key, val]) => {
          if (val !== undefined && val !== null) opt.dataset[key] = String(val);
        });
      }
      select.appendChild(opt);
    }

    function setSelectOptions(select, items, placeholder){
      resetSelect(select, placeholder);
      (items || []).forEach((item) => {
        if (!item) return;
        addSelectOption(select, item, item);
      });
    }

    function setSelectValue(select, value, label){
      if (!select) return;
      if (!value) {
        select.value = '';
        return;
      }
      const exists = Array.from(select.options).some(opt => opt.value === value);
      if (!exists) addSelectOption(select, value, label || value);
      select.value = value;
    }

    async function fetchBezettingMeta(params){
      const qs = new URLSearchParams(params || {});
      if (!qs.has('limit')) qs.set('limit', '1');
      const body = await apiFetch(`${API_BASE}?action=bezetting_list&${qs.toString()}`);
      return { rows: body.rows || [], ukpds: body.ukpds || [] };
    }

    async function getUkpdListAll(){
      if (bezettingState.allUkpds) return bezettingState.allUkpds;
      const meta = await fetchBezettingMeta();
      bezettingState.allUkpds = meta.ukpds || [];
      return bezettingState.allUkpds;
    }

    async function getUkpdListWilayah(){
      if (bezettingState.wilayahUkpds) return bezettingState.wilayahUkpds;
      const meta = await fetchBezettingMeta({ wilayah: loginWilayah || '' });
      bezettingState.wilayahUkpds = meta.ukpds || [];
      return bezettingState.wilayahUkpds;
    }

    async function getBezettingByUkpd(ukpd){
      const key = norm(ukpd);
      if (!key) return [];
      if (bezettingState.byUkpd.has(key)) return bezettingState.byUkpd.get(key);
      const qs = new URLSearchParams({ ukpd, limit: '30000' });
      const body = await apiFetch(`${API_BASE}?action=bezetting_list&${qs.toString()}`);
      const rows = body.rows || [];
      bezettingState.byUkpd.set(key, rows);
      return rows;
    }

    function resetPegawaiFields(){
      if (nipInput) nipInput.value = '';
      if (pangkatInput) pangkatInput.value = '';
      if (jabatanInput) jabatanInput.value = '';
      if (abkLamaInput) abkLamaInput.value = '';
      if (bezettingLamaInput) bezettingLamaInput.value = '';
    }

    function resetJabatanBaruFields(){
      if (jabatanBaruInput) jabatanBaruInput.value = '';
      if (abkBaruInput) abkBaruInput.value = '';
      if (bezettingBaruInput) bezettingBaruInput.value = '';
    }

    async function renderPegawaiOptions(ukpd, selectedName){
      if (!pegawaiSelect) return;
      resetSelect(pegawaiSelect, 'Pilih pegawai');
      resetPegawaiFields();
      if (!ukpd) {
        pegawaiSelect.disabled = true;
        return;
      }
      pegawaiSelect.disabled = false;
      const rows = await getBezettingByUkpd(ukpd);
      rows.filter(r => r.nama_pegawai).forEach((r) => {
        const label = r.nip ? `${r.nama_pegawai} - ${r.nip}` : r.nama_pegawai;
        addSelectOption(pegawaiSelect, r.nama_pegawai, label, {
          nip: r.nip || '',
          pangkat: r.pangkat_golongan || '',
          jabatan: getJabatanOrb(r),
          abk: r.abk || '',
          bezetting: r.eksisting || '',
          ukpd: r.ukpd || ''
        });
      });
      if (selectedName) setSelectValue(pegawaiSelect, selectedName);
      if (pegawaiSelect.value) applyPegawaiSelection();
    }

    function applyPegawaiSelection(){
      if (!pegawaiSelect) return;
      const opt = pegawaiSelect.selectedOptions[0];
      if (!opt || !opt.value) {
        resetPegawaiFields();
        return;
      }
      const dataset = opt.dataset || {};
      const hasData = Object.keys(dataset).length > 0;
      if (!hasData) return;
      if (nipInput) nipInput.value = dataset.nip || '';
      if (pangkatInput) pangkatInput.value = dataset.pangkat || '';
      if (jabatanInput) jabatanInput.value = dataset.jabatan || '';
      if (abkLamaInput) abkLamaInput.value = dataset.abk || '';
      if (bezettingLamaInput) bezettingLamaInput.value = dataset.bezetting || '';
      if (namaUkpdHidden && dataset.ukpd) namaUkpdHidden.value = dataset.ukpd;
    }

    async function renderJabatanOptions(ukpd, selectedJabatan){
      if (!jabatanBaruSelect) return;
      resetSelect(jabatanBaruSelect, 'Pilih jabatan baru');
      resetJabatanBaruFields();
      if (!ukpd) {
        jabatanBaruSelect.disabled = true;
        return;
      }
      jabatanBaruSelect.disabled = false;
      const rows = await getBezettingByUkpd(ukpd);
      rows.forEach((r) => {
        const jabatan = getJabatanOrb(r);
        if (!jabatan) return;
        const permenpan = r.nama_jabatan_permenpan || '';
        const label = permenpan && permenpan !== jabatan ? `${jabatan} (${permenpan})` : jabatan;
        addSelectOption(jabatanBaruSelect, jabatan, label, {
          jabatan,
          abk: r.abk || '',
          bezetting: r.eksisting || ''
        });
      });
      if (selectedJabatan) setSelectValue(jabatanBaruSelect, selectedJabatan);
      if (jabatanBaruSelect.value) applyJabatanBaruSelection();
    }

    function applyJabatanBaruSelection(){
      if (!jabatanBaruSelect) return;
      const opt = jabatanBaruSelect.selectedOptions[0];
      if (!opt || !opt.value) {
        resetJabatanBaruFields();
        return;
      }
      const dataset = opt.dataset || {};
      if (jabatanBaruInput) jabatanBaruInput.value = dataset.jabatan || opt.value || '';
      if (abkBaruInput) abkBaruInput.value = dataset.abk || '';
      if (bezettingBaruInput) bezettingBaruInput.value = dataset.bezetting || '';
    }

    async function renderUkpdAsalOptions(selectedUkpd){
      if (!ukpdAsalSelect) return;
      if (!isSuper && !isWilayahAdmin) {
        setSelectOptions(ukpdAsalSelect, loginUkpd ? [loginUkpd] : [], 'UKPD asal');
        ukpdAsalSelect.value = loginUkpd || '';
        ukpdAsalSelect.disabled = true;
        if (namaUkpdHidden) namaUkpdHidden.value = ukpdAsalSelect.value;
        return;
      }
      ukpdAsalSelect.disabled = false;
      const ukpds = isWilayahAdmin ? await getUkpdListWilayah() : await getUkpdListAll();
      setSelectOptions(ukpdAsalSelect, ukpds, 'Pilih UKPD asal');
      if (selectedUkpd) setSelectValue(ukpdAsalSelect, selectedUkpd);
      if (namaUkpdHidden) namaUkpdHidden.value = ukpdAsalSelect.value || '';
    }

    async function renderUkpdTujuanOptions(selectedUkpd){
      if (!ukpdTujuanSelect) return;
      const ukpds = await getUkpdListAll();
      setSelectOptions(ukpdTujuanSelect, ukpds, 'Pilih UKPD tujuan');
      if (selectedUkpd) setSelectValue(ukpdTujuanSelect, selectedUkpd);
    }

    async function applyFormDefaults(selectedAsal, selectedPegawai, selectedTujuan, selectedJabatan){
      if (tanggalUsulanInput && !tanggalUsulanInput.value) tanggalUsulanInput.value = todayIso();
      const asalUkpd = selectedAsal || (!isSuper && !isWilayahAdmin ? loginUkpd : '');
      await renderUkpdAsalOptions(asalUkpd);
      if (asalUkpd) {
        await renderPegawaiOptions(asalUkpd, selectedPegawai);
        if (selectedPegawai) applyPegawaiSelection();
      } else {
        resetSelect(pegawaiSelect, 'Pilih pegawai');
        if (pegawaiSelect) pegawaiSelect.disabled = true;
        resetPegawaiFields();
      }
      await renderUkpdTujuanOptions(selectedTujuan);
      if (selectedTujuan) {
        await renderJabatanOptions(selectedTujuan, selectedJabatan);
        if (selectedJabatan) applyJabatanBaruSelection();
      } else {
        resetSelect(jabatanBaruSelect, 'Pilih jabatan baru');
        if (jabatanBaruSelect) jabatanBaruSelect.disabled = true;
        resetJabatanBaruFields();
      }
    }

    function applyRoleLocks(){
      const statusField = form?.elements?.status;
      const ketField = form?.elements?.keterangan;
      if (!statusField && !ketField) return;
      if (!isSuper) {
        if (statusField) statusField.disabled = true;
        if (ketField) ketField.readOnly = true;
        return;
      }
      if (statusField) statusField.disabled = false;
      if (ketField) ketField.readOnly = false;
    }

    function normalizeMutasiRow(row){
      const next = { ...(row || {}) };
      if (!next.id) next.id = next.id_usulan || '';
      if (!next.nama_ukpd) next.nama_ukpd = next.nama_ukpd_asal || next.ukpd_asal || '';
      if (!next.ukpd_tujuan) next.ukpd_tujuan = next.nama_ukpd_tujuan || '';
      if (!next.jabatan) next.jabatan = next.jabatan_asal || '';
      if (!next.pangkat_golongan) next.pangkat_golongan = next.pangkat_gol || '';
      if (!next.berkas_path) next.berkas_path = next.berkas_url || next.link_dokumen || '';
      if (!next.status) {
        const candidates = [
          next.status_usulan,
          next.status_mutasi,
          next.status_pengajuan,
          next.status_usulan_mutasi,
          next.status_mutasi_pegawai,
          next.status_pengajuan_mutasi
        ].filter(Boolean);
        if (candidates.length) {
          next.status = candidates[0];
        } else {
          const key = Object.keys(next).find((k) => {
            const lower = String(k || '').toLowerCase();
            if (!lower.startsWith('status')) return false;
            if (lower.includes('formasi') || lower.includes('aktif') || lower.includes('rumpun')) return false;
            return next[k];
          });
          if (key) next.status = next[key];
        }
      }
      if (next.id !== undefined && next.id !== null) next.id = String(next.id);
      return next;
    }

    async function apiFetch(url, options={}){
      const opts = { ...options };
      opts.headers = { ...API_HEADERS, ...(opts.headers || {}) };
      if (opts.body && !opts.headers['Content-Type']) opts.headers['Content-Type'] = 'application/json';
      const res = await fetch(url, opts);
      const text = await res.text();
      let body;
      try { body = JSON.parse(text); }
      catch { throw new Error(text || 'Respon bukan JSON'); }
      if (!res.ok || !body.ok) throw new Error(body.error || 'Permintaan gagal');
      return body;
    }

    function renderMetrics(rows){
      const counts = (rows || []).reduce((acc, r) => {
        const key = normalizeStatus(r.status);
        if (!key) return acc;
        acc[key] = (acc[key] || 0) + 1;
        return acc;
      }, {});
      const totalCount = (rows || []).length;
      const diusulkan = counts.DIUSULKAN || 0;
      const diproses = counts.DIPROSES || 0;
      const selesai = counts.SELESAI || 0;
      const ditolak = (counts.DITOLAK || 0) + (counts.DITARIK || 0);
      document.getElementById('mTotal').textContent = totalCount;
      document.getElementById('mDiusulkan').textContent = diusulkan;
      document.getElementById('mProses').textContent = diproses;
      document.getElementById('mSelesai').textContent = selesai;
      document.getElementById('mDitolak').textContent = ditolak;
      totalFiltered.textContent = totalCount;
    }

    function syncHeaderUser(){
      if (!authUser) return;
      const roleText = (authUser.role || 'USER').toUpperCase();
      const namaText = authUser.namaUkpd || authUser.username || 'User';
      if (roleBadge) roleBadge.textContent = roleText;
      if (userNameEl) userNameEl.textContent = namaText;
      if (userRoleEl) userRoleEl.textContent = authUser.role || '';
      const headerRole = document.getElementById('rolePill');
      const headerUkpd = document.getElementById('ukpdPill');
      const headerName = document.getElementById('userName');
      const headerRoleText = document.getElementById('userRole');
      if (headerRole) headerRole.textContent = roleText;
      if (headerUkpd) headerUkpd.textContent = namaText;
      if (headerName) headerName.textContent = namaText;
      if (headerRoleText) headerRoleText.textContent = authUser.role || '';
    }

    function renderFilters(body){
      const setOptions = (el, list)=>{ el.innerHTML = '<option value="">Semua</option>' + (list||[]).map(v=>`<option>${escapeHtml(v)}</option>`).join(''); };
      setOptions(ukpdFilter, body.ukpds || []);
      setOptions(tujuanFilter, body.tujuan || []);
      if (!isSuper && !isWilayahAdmin){
        ukpdFilter.value = loginUkpd;
        ukpdFilter.disabled = true;
      } else {
        ukpdFilter.disabled = false;
      }
    }

    function getFilteredRows(){
      let rows = cacheRows.slice();
      const statusValue = statusFilter.value;
      if (statusValue) {
        rows = rows.filter(r => normalizeStatus(r.status) === statusValue);
      }
      return rows;
    }

    function applyTableState(){
      const filtered = getFilteredRows();
      const sorted = sortRows(filtered);
      const total = sorted.length;
      totalPages = Math.max(1, Math.ceil(total / currentLimit));
      if (page > totalPages) page = totalPages;
      pageNow.textContent = page;
      pageTotal.textContent = totalPages;
      renderMetrics(sorted);
      const startIndex = (page - 1) * currentLimit;
      const pageRows = sorted.slice(startIndex, startIndex + currentLimit);
      renderTable(pageRows, startIndex);
    }

    function renderTable(rows, startIndex){
      tableBody.innerHTML = '';
      const safeRows = rows || [];
      safeRows.forEach((r, idx)=>{
        const tr = document.createElement('tr');
        const nama = escapeHtml(formatNama(r) || r.nama_pegawai || '-');
        const alasan = formatMultiline(r.alasan || '');
        const ket = formatMultiline(getKeteranganText(r));
        const verif = formatMultiline(r.verif_checklist || '');
        const verifHtml = verif ? `<div style="color:var(--muted); font-size:12px;">Verif: ${verif}</div>` : '';
        const safeId = escapeHtml(r.id || '');
        const berkasUrl = safeUrl(r.berkas_path);
        tr.innerHTML = `
          <td>${(startIndex || 0) + idx + 1}</td>
          <td>${badgeStatus(r.status)}</td>
          <td class="actions">
            <div class="dropdown">
              <button class="ghost dropdown-toggle">Aksi v</button>
              <div class="dropdown-menu">
                <button data-action="view" data-id="${safeId}">Lihat</button>
                ${isSuper ? `<button data-action="validate" data-id="${safeId}">Validasi</button>` : ''}
                ${isSuper ? `<button data-action="print" data-id="${safeId}">Cetak Word</button>` : ''}
                <button data-action="edit" data-id="${safeId}">Ubah</button>
                <button data-action="delete" data-id="${safeId}">Hapus</button>
              </div>
            </div>
          </td>
          <td>
            <div style="font-weight:700;">${nama}</div>
            <div style="color:var(--muted); font-size:12px;">NIP: ${escapeHtml(r.nip || '-')}</div>
            <div style="color:var(--muted); font-size:12px;">Pangkat/Gol: ${escapeHtml(r.pangkat_golongan || '-')}</div>
          </td>
          <td>
            <div style="font-weight:700;">${escapeHtml(r.jabatan || '-')}</div>
            <div style="color:var(--muted); font-size:12px;">Jenis: ${escapeHtml(r.jenis_mutasi || '-')}</div>
          </td>
          <td>${escapeHtml(r.nama_ukpd || '-')}</td>
          <td>${escapeHtml(r.ukpd_tujuan || '-')}</td>
          <td>${escapeHtml(r.jabatan_baru || '-')}</td>
          <td>${formatAbk(r.abk_j_lama, r.bezetting_j_lama, r.nonasn_abk_lama, r.nonasn_bezetting_lama)}</td>
          <td>${formatAbk(r.abk_j_baru, r.bezetting_j_baru, r.nonasn_abk_baru, r.nonasn_bezetting_baru)}</td>
          <td style="min-width:220px;">${alasan || '-'}</td>
          <td>${berkasUrl ? `<a href="${escapeHtml(berkasUrl)}" target="_blank" rel="noopener">Berkas</a>` : '-'}</td>
          <td>${escapeHtml(r.created_by_ukpd || '-')}</td>
          <td>${escapeHtml(formatDateDisplay(r.created_at))}</td>
          <td>${escapeHtml(formatDateDisplay(r.updated_at))}</td>
          <td style="min-width:220px;">${verifHtml}${ket}</td>
        `;
        tableBody.appendChild(tr);
      });

      // dropdown toggle
      tableBody.querySelectorAll('.dropdown-toggle').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          const dd = btn.closest('.dropdown');
          document.querySelectorAll('.dropdown').forEach(o=>{ if (o!==dd) o.classList.remove('open'); });
          dd.classList.toggle('open');
        });
      });
      document.addEventListener('click', ()=> document.querySelectorAll('.dropdown').forEach(o=> o.classList.remove('open')), { once:true });
    }

    async function loadData(){
      const params = new URLSearchParams();
      if (search.value) params.set('search', search.value);
      if (isSuper) {
        if (ukpdFilter.value) params.set('ukpd', ukpdFilter.value);
      } else if (isWilayahAdmin) {
        if (loginWilayah) params.set('wilayah', loginWilayah);
        if (ukpdFilter.value) params.set('ukpd', ukpdFilter.value);
      } else {
        params.set('ukpd', loginUkpd);
      }
      if (tujuanFilter.value) params.set('tujuan', tujuanFilter.value);
      const body = await apiFetch(`${API_BASE}?action=mutasi_list&${params.toString()}`);
      cacheRows = (body.rows || []).map(normalizeMutasiRow);
      renderFilters(body);
      applyTableState();
    }

    async function saveMutasi(e){
      e.preventDefault();
      const data = Object.fromEntries(new FormData(form).entries());
      if (!isSuper) {
        delete data.status;
        delete data.keterangan;
      }
      if (data.status) data.status = normalizeStatus(data.status) || data.status;
      const currentRow = editingId ? cacheRows.find(r=>String(r.id || '') === String(editingId || '')) : null;
      if (!data.berkas_path && currentRow?.berkas_path) {
        data.berkas_path = currentRow.berkas_path;
      }
      if (!data.nama_ukpd && namaUkpdHidden?.value) {
        data.nama_ukpd = namaUkpdHidden.value;
      }
      const nowIso = new Date().toISOString();
      if (!editingId) {
        if (!data.created_at) data.created_at = nowIso;
        if (!data.created_by_ukpd) data.created_by_ukpd = loginUkpd;
      }
      data.updated_at = nowIso;
      if (!isSuper && !isWilayahAdmin) {
        data.nama_ukpd = loginUkpd;
      }
      const action = editingId ? 'mutasi_update' : 'mutasi_create';
      const bodyPayload = { action, ...data };
      if (editingId) bodyPayload.id = editingId;
      await apiFetch(API_BASE, { method: 'POST', body: JSON.stringify(bodyPayload) });
      editingId = null;
      form.reset();
      await loadData();
      alert('Berhasil disimpan');
      hideModal(formModal);
    }

    async function deleteMutasi(id){
      if (!confirm('Hapus usulan ini?')) return;
      await apiFetch(API_BASE, {
        method: 'POST',
        body: JSON.stringify({ action: 'mutasi_delete', id })
      });
      await loadData();
    }

    function openView(row){
      const berkasUrl = safeUrl(row.berkas_path);
      const fields = [
        ['NIP', row.nip],
        ['Nama', formatNama(row) || row.nama_pegawai],
        ['Gelar Depan', row.gelar_depan],
        ['Gelar Belakang', row.gelar_belakang],
        ['Pangkat/Golongan', row.pangkat_golongan],
        ['Jabatan', row.jabatan],
        ['Jenis Mutasi', row.jenis_mutasi],
        ['Tanggal Usulan', formatDateDisplay(row.tanggal_usulan)],
        ['Status', formatStatusLabel(row.status), true],
        ['UKPD Asal', row.nama_ukpd],
        ['UKPD Tujuan', row.ukpd_tujuan],
        ['ABK J Lama', row.abk_j_lama],
        ['Bezetting J Lama', row.bezetting_j_lama],
        ['Non-ASN Bezetting Lama', row.nonasn_bezetting_lama],
        ['Non-ASN ABK Lama', row.nonasn_abk_lama],
        ['Jabatan Baru', row.jabatan_baru],
        ['ABK J Baru', row.abk_j_baru],
        ['Bezetting J Baru', row.bezetting_j_baru],
        ['Non-ASN Bezetting Baru', row.nonasn_bezetting_baru],
        ['Non-ASN ABK Baru', row.nonasn_abk_baru],
        ['Mutasi ID', row.mutasi_id],
        ['Verifikasi Checklist', row.verif_checklist],
        ['Berkas', berkasUrl ? `<a href="${escapeHtml(berkasUrl)}" target="_blank" rel="noopener">Buka Berkas</a>` : '-', true],
        ['Created By UKPD', row.created_by_ukpd],
        ['Created At', formatDateDisplay(row.created_at)],
        ['Updated At', formatDateDisplay(row.updated_at)],
      ];
      detailGrid.innerHTML = fields.map(([l,v,isHtml])=>{
        const safeLabel = escapeHtml(l);
        const safeValue = isHtml ? (v || '-') : escapeHtml(v || '-');
        return `<div class="detail-card"><div class="detail-label">${safeLabel}</div><div class="detail-value">${safeValue}</div></div>`;
      }).join('');
      detailAlasan.textContent = row.alasan || '-';
      detailKet.textContent = getKeteranganText(row);
      showModal(viewModal);
    }

    function openValidate(row){
      validatingRow = row;
      if (validateForm) validateForm.reset();
      if (validateStatus) validateStatus.value = normalizeStatus(row.status) || 'DIUSULKAN';
      if (validateNote) validateNote.value = row.keterangan || '';
      if (validateTitle) {
        const nama = formatNama(row) || row.nama_pegawai || '-';
        validateTitle.textContent = `Validasi Usulan Mutasi - ${nama}`;
      }
      showModal(validateModal);
    }

    async function saveValidate(e){
      e.preventDefault();
      if (!validatingRow) return;
      const payload = {
        action: 'mutasi_update',
        id: validatingRow.id,
        status: normalizeStatus(validateStatus?.value || validatingRow.status || ''),
        keterangan: String(validateNote?.value || '').trim(),
        updated_at: new Date().toISOString()
      };
      await apiFetch(API_BASE, { method: 'POST', body: JSON.stringify(payload) });
      hideModal(validateModal);
      validatingRow = null;
      await loadData();
      alert('Validasi tersimpan');
    }

    tableBody.addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if (!btn) return;
      const id = btn.dataset.id;
      const action = btn.dataset.action;
      const row = cacheRows.find(r=>String(r.id || '') === String(id || ''));
      if (action==='view' && row){ openView(row); }
      if (action==='validate' && row && isSuper){ openValidate(row); }
      if (action==='print' && row && isSuper){
        exportWord(row).catch(err=>alert(err.message));
      }
      if (action==='edit' && row){
        openEditForm(row).catch(err=>alert(err.message));
      }
      if (action==='delete' && id) deleteMutasi(id).catch(err=>alert(err.message));
    });

    async function openAddForm(){
      editingId = null;
      form.reset();
      await applyFormDefaults();
      applyRoleLocks();
      submitBtn.textContent = 'Simpan';
      formTitle.textContent = 'Tambah Usulan Mutasi';
      showModal(formModal);
    }

    async function openEditForm(row){
      editingId = row.id;
      form.reset();
      Object.keys(row).forEach(k=>{ if (form.elements[k]) form.elements[k].value = row[k] || ''; });
      if (form.elements.status) form.elements.status.value = normalizeStatus(row.status) || row.status || '';
      if (namaUkpdHidden && row.nama_ukpd) namaUkpdHidden.value = row.nama_ukpd;
      await applyFormDefaults(row.nama_ukpd, row.nama_pegawai, row.ukpd_tujuan, row.jabatan_baru);
      applyRoleLocks();
      formTitle.textContent = 'Ubah Usulan Mutasi';
      submitBtn.textContent = 'Update';
      showModal(formModal);
    }

    if (ukpdAsalSelect) {
      ukpdAsalSelect.addEventListener('change', ()=>{
        if (namaUkpdHidden) namaUkpdHidden.value = ukpdAsalSelect.value || '';
        renderPegawaiOptions(ukpdAsalSelect.value, '').catch(err=>alert(err.message));
      });
    }
    if (pegawaiSelect) {
      pegawaiSelect.addEventListener('change', ()=>{ applyPegawaiSelection(); });
    }
    if (ukpdTujuanSelect) {
      ukpdTujuanSelect.addEventListener('change', ()=>{
        renderJabatanOptions(ukpdTujuanSelect.value, '').catch(err=>alert(err.message));
      });
    }
    if (jabatanBaruSelect) {
      jabatanBaruSelect.addEventListener('change', ()=>{ applyJabatanBaruSelection(); });
    }

    form.addEventListener('submit', (e)=>{ saveMutasi(e).catch(err=>alert(err.message)); });
    resetFormBtn.addEventListener('click', ()=>{ editingId=null; form.reset(); applyFormDefaults().catch(err=>alert(err.message)); submitBtn.textContent='Simpan'; formTitle.textContent='Tambah Usulan Mutasi'; });
    if (validateForm) validateForm.addEventListener('submit', (e)=>{ saveValidate(e).catch(err=>alert(err.message)); });
    if (resetValidate) resetValidate.addEventListener('click', ()=>{ if (validatingRow) openValidate(validatingRow); else validateForm?.reset(); });
    applyFilter.addEventListener('click', ()=>{ page=1; loadData().catch(err=>alert(err.message)); });
    resetFilter.addEventListener('click', ()=>{
      statusFilter.value = '';
      search.value = '';
      ukpdFilter.value = (!isSuper && !isWilayahAdmin) ? loginUkpd : '';
      tujuanFilter.value = '';
      page = 1;
      loadData().catch(err=>alert(err.message));
    });
    [statusFilter, ukpdFilter, tujuanFilter, search].forEach(el=> el.addEventListener('change', ()=>{ page=1; loadData().catch(err=>alert(err.message)); }));
    pageSize.addEventListener('change', ()=>{ currentLimit=parseInt(pageSize.value,10)||10; page=1; loadData().catch(err=>alert(err.message)); });
    prevPage.addEventListener('click', ()=>{ if (page>1){ page--; loadData().catch(err=>alert(err.message)); } });
    nextPage.addEventListener('click', ()=>{ if (page<totalPages){ page++; loadData().catch(err=>alert(err.message)); } });
    btnAdd.addEventListener('click', ()=>{ openAddForm().catch(err=>alert(err.message)); });
    closeForm.addEventListener('click', ()=> hideModal(formModal));
    closeView.addEventListener('click', ()=> hideModal(viewModal));
    if (closeValidate) closeValidate.addEventListener('click', ()=> hideModal(validateModal));
    modalBackdrop.addEventListener('click', ()=>{ hideModal(formModal); hideModal(viewModal); hideModal(validateModal); });
    document.addEventListener('keydown', (e)=>{ if (e.key==='Escape'){ hideModal(formModal); hideModal(viewModal); hideModal(validateModal); } });

    function doLogout(){ localStorage.removeItem('authUser'); window.location.href = BASE; }

    function initSidebarToggle(){
      const btn = document.getElementById('sidebarToggle');
      const backdrop = document.getElementById('sidebarBackdrop');
      const sidebarEl = document.querySelector('.sidebar');
      if (!btn || !backdrop || !sidebarEl) return;
      const close = ()=>{ sidebarEl.classList.remove('show'); backdrop.classList.remove('show'); document.body.style.overflow=''; };
      btn.addEventListener('click', ()=>{
        const willShow = !sidebarEl.classList.contains('show');
        sidebarEl.classList.toggle('show', willShow);
        backdrop.classList.toggle('show', willShow);
        document.body.style.overflow = willShow ? 'hidden' : '';
      });
      backdrop.addEventListener('click', close);
      sidebarEl.addEventListener('click', (e)=>{ if (e.target.closest('a')) close(); });
      window.addEventListener('resize', ()=>{ if (window.innerWidth >= 1100) close(); });
    }

    loadData().catch(err=>alert(err.message));
  </script>
</body>
</html>
