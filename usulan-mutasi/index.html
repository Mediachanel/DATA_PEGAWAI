<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Usulan Mutasi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="foto/Dinkes.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg: #f6f7fb;
      --card: #ffffff;
      --border: #e6ecf4;
      --muted: #6b7280;
      --accent: #5e8bff;
      --accent-2: #ff9f68;
      --accent-soft: #eef3ff;
      --success: #16a34a;
      --warn: #f59e0b;
      --danger: #dc2626;
      --purple: #7c3aed;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:'Plus Jakarta Sans','Inter','Segoe UI',Arial,sans-serif; background:radial-gradient(circle at 18% 20%, rgba(94,139,255,0.08), transparent 30%), radial-gradient(circle at 80% 0%, rgba(255,159,104,0.12), transparent 32%), #f7f9fc; color:#1b2b3a; }
    .layout{ min-height:100vh; }
    .content{ margin-left:260px; min-height:100vh; display:flex; flex-direction:column; transition:margin .2s ease; }
    .sidebar{ position:fixed; inset:0 auto 0 0; width:260px; background:#ffffff; color:#475569; padding:18px 14px; display:flex; flex-direction:column; gap:18px; min-height:100vh; box-shadow:8px 0 30px -20px rgba(0,0,0,0.08); border-right:1px solid #e2e8f0; }
    .logo{ display:flex; align-items:center; gap:10px; color:#0f172a; font-weight:800; }
    .logo img{ width:38px; height:38px; object-fit:contain; }
    .logo-title{ font-size:13px; text-transform:uppercase; letter-spacing:.2px; }
    .logo-sub{ font-size:12px; color:#94a3b8; }
    nav{ display:flex; flex-direction:column; gap:6px; }
    .nav-title{ margin:18px 10px 6px; font-size:11px; letter-spacing:0.5px; text-transform:uppercase; color:#94a3b8; }
    .nav-item{ display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; color:#475569; text-decoration:none; transition:all .15s ease; font-weight:600; }
    .nav-item:hover{ background:#f8fafc; }
    .nav-item.active{ background:var(--accent-soft); color:#3b5ecc; font-weight:700; box-shadow:0 10px 22px rgba(94,139,255,0.18); }
    .icon-round{ width:26px; height:26px; border-radius:10px; background:#eef2ff; color:#4338ca; display:grid; place-items:center; font-size:12px; }
    .topbar{ background:linear-gradient(120deg, rgba(94,139,255,0.14), rgba(255,159,104,0.16)), #ffffff; border-bottom:1px solid var(--border); padding:12px 18px; display:flex; align-items:center; justify-content:space-between; gap:12px; box-shadow:0 10px 28px rgba(24,39,75,0.12); backdrop-filter:blur(6px); }
    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .badge{ display:inline-flex; align-items:center; gap:8px; background:#eef3ff; color:#3b5ecc; padding:8px 12px; border-radius:999px; font-weight:700; font-size:13px; box-shadow:0 10px 20px rgba(94,139,255,0.2); }
    .hero{ background:linear-gradient(135deg, rgba(94,139,255,0.2), rgba(255,159,104,0.18)), #0f1f3a; color:#e2e8f0; border-radius:16px; padding:18px; display:flex; justify-content:space-between; gap:12px; align-items:center; box-shadow:0 12px 30px rgba(24,39,75,0.2); }
    .hero h2{ margin:0; color:#fff; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; font-weight:700; font-size:12px; }
    .pill.role{ background:#e0f2fe; color:#0369a1; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:14px; box-shadow:0 10px 28px rgba(15,23,42,0.08); }
    .metric-grid{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
    .metric{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:0 8px 20px rgba(15,23,42,0.06); }
    .metric .label{ color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.4px; }
    .metric .value{ font-size:26px; font-weight:800; }
    .metric.blue{ background:#e0f2fe; border-color:#c7e0f7; }
    .metric.orange{ background:#fef3c7; border-color:#fde68a; }
    .metric.green{ background:#dcfce7; border-color:#bbf7d0; }
    .metric.red{ background:#fee2e2; border-color:#fecdd3; }
    label{ font-size:12px; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:.4px; display:block; margin-bottom:6px; }
    input, select, textarea, button{ padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-size:14px; font-family:'Plus Jakarta Sans','Inter','Segoe UI',Arial,sans-serif; }
    input, select, textarea{ width:100%; }
    button.primary{ background:linear-gradient(120deg,var(--accent) 0%, #7cb3ff 45%, var(--accent-2) 100%); color:#0b1f2c; border:none; font-weight:800; box-shadow:0 15px 35px rgba(94,139,255,0.32); cursor:pointer; }
    button.ghost{ background:#f8fafc; color:#1b2b3a; border:1px solid var(--border); cursor:pointer; box-shadow:0 8px 18px rgba(24,39,75,0.06); }
    .table-wrap{ overflow-x:auto; }
    table{ width:100%; border-collapse:collapse; }
    th, td{ padding:10px 8px; border-bottom:1px solid var(--border); text-align:left; font-size:13px; vertical-align:top; }
    th{ background:#f8fafc; text-transform:uppercase; letter-spacing:.4px; font-size:12px; }
    .status-pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px; border:1px solid transparent; }
    .pill-info{ background:#e0f2fe; color:#0f5098; }
    .pill-success{ background:#dcfce7; color:#166534; }
    .pill-danger{ background:#fee2e2; color:#b91c1c; }
    .pill-warn{ background:#fef9c3; color:#92400e; }
    .actions{ display:flex; gap:6px; align-items:center; }
    .dropdown{ position:relative; }
    .dropdown-menu{
      position:absolute; top:100%; left:0; min-width:140px; background:#fff; border:1px solid var(--border);
      border-radius:12px; box-shadow:0 10px 28px rgba(15,23,42,0.12); padding:6px 0; display:none; z-index:10;
    }
    .dropdown.open .dropdown-menu{ display:block; }
    .dropdown-menu button{
      width:100%; text-align:left; background:none; border:none; padding:10px 14px; font-size:13px; cursor:pointer;
    }
    .dropdown-menu button:hover{ background:#f8fafc; }
    .filters{ display:grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap:10px; align-items:end; }
    .pagination{ display:flex; gap:10px; align-items:center; justify-content:flex-end; margin-top:10px; flex-wrap:wrap; }
    .pill-abk{ display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px; background:#f8fafc; border:1px solid var(--border); font-size:12px; }
    .mobile-toggle{
      position: fixed; top: 14px; left: 14px; z-index: 70;
      background: var(--accent); color: #f8fafc; border: 1px solid rgba(255,255,255,0.18);
      border-radius: 14px; padding: 10px 14px; display:none; align-items:center; gap:8px; font-weight:800;
      box-shadow: 0 12px 26px rgba(94,139,255,0.35);
    }
    #sidebarBackdrop{
      position: fixed; inset:0; background: rgba(0,0,0,0.45);
      opacity:0; pointer-events:none; transition: opacity .2s ease; z-index:50;
    }
    #sidebarBackdrop.show{ opacity:1; pointer-events:auto; }
    /* Modal */
    .modal-backdrop{
      position: fixed; inset:0; background: rgba(15,23,42,0.35);
      opacity:0; pointer-events:none; transition: opacity .15s ease; z-index:80;
    }
    .modal-backdrop.show{ opacity:1; pointer-events:auto; }
    .modal{
      position: fixed; inset:0; display:flex; align-items:center; justify-content:center;
      opacity:0; pointer-events:none; z-index:90; transition: opacity .15s ease;
      padding:14px;
    }
    .modal.show{ opacity:1; pointer-events:auto; }
    .modal-dialog{
      width: min(1100px, 100%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 18px 48px rgba(15,23,42,0.18);
      max-height: 90vh; overflow:auto;
    }
    .modal-head{
      padding: 16px 18px; border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .close-btn{
      background: none; border:1px solid var(--border); border-radius:10px;
      padding:8px 12px; cursor:pointer; font-weight:800;
    }
    .modal-body{ padding: 16px 18px 20px; }
    .detail-grid{ display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); }
    .detail-card{ border:1px solid var(--border); border-radius:12px; padding:10px 12px; background:#f8fafc; }
    .detail-label{ font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.3px; }
    .detail-value{ font-weight:700; margin-top:2px; }
    @media (max-width:1100px){
      .content{ margin-left:0; }
      .sidebar{
        position: fixed; inset: 0 auto 0 0; width: calc(100vw - 72px); max-width: 280px;
        transform: translateX(-100%); transition: transform .2s ease; z-index: 60; min-height: 100vh;
        box-shadow: 8px 0 30px -20px rgba(0,0,0,0.5);
      }
      .sidebar.show{ transform: translateX(0); }
      .mobile-toggle{ display:inline-flex; }
      main{ padding:14px; margin-top:20px; padding-top:62px; }
    }
  </style>
</head>
<body>
  <div id="sidebarBackdrop"></div>
  <button id="sidebarToggle" aria-label="Buka menu" class="mobile-toggle">
    <span style="font-size:18px;">&#9776;</span> Menu
  </button>
  <div class="layout">
    <div id="sidebar-container"></div>
    <div class="content">
      <div id="header-container"></div>
      <main style="padding:18px;">
        <div class="hero">
          <div>
            <div class="pill role" id="roleBadge">-</div>
            <h2>Usulan Mutasi Pegawai</h2>
            <p style="margin:4px 0 0; color:#cbd5e1;">Pantau status usulan mutasi, unggah berkas, dan tindak lanjuti verifikasi.</p>
          </div>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <button id="btnAdd" class="primary" style="min-width:150px;">+ Tambah Usulan</button>
          </div>
        </div>

        <div class="metric-grid">
          <div class="metric blue">
            <div class="label">Total</div>
            <div class="value" id="mTotal">0</div>
          </div>
          <div class="metric blue">
            <div class="label">Diusulkan</div>
            <div class="value" id="mDiusulkan">0</div>
          </div>
          <div class="metric orange">
            <div class="label">Diproses</div>
            <div class="value" id="mProses">0</div>
          </div>
          <div class="metric green">
            <div class="label">Selesai</div>
            <div class="value" id="mSelesai">0</div>
          </div>
          <div class="metric red">
            <div class="label">Ditolak</div>
            <div class="value" id="mDitolak">0</div>
          </div>
        </div>

        <div class="card" style="margin-top:12px; display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <div>
            <h3 style="margin:0 0 4px;">Usulan Mutasi</h3>
            <div style="color:var(--muted); font-size:13px;">Total (sesuai filter): <span id="totalFiltered">0</span> data</div>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <select id="pageSize" style="width:auto;">
              <option value="10">10</option>
              <option value="20">20</option>
              <option value="50">50</option>
            </select>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <div class="filters" style="grid-template-columns: repeat(auto-fit, minmax(200px,1fr));">
            <div>
              <label>Status</label>
              <select id="statusFilter">
                <option value="">Semua</option>
                <option value="DIUSULKAN">Diusulkan</option>
                <option value="DISETUJUI">Disetujui</option>
                <option value="DITOLAK">Ditolak</option>
                <option value="DITARIK">Ditarik</option>
              </select>
            </div>
            <div>
              <label>Cari Nama / NIP</label>
              <input id="search" placeholder="Ketik nama atau NIP">
            </div>
            <div>
              <label>UKPD Asal</label>
              <select id="ukpdFilter"><option value="">Semua</option></select>
            </div>
            <div>
              <label>UKPD Tujuan</label>
              <select id="tujuanFilter"><option value="">Semua</option></select>
            </div>
            <div style="display:flex; gap:8px; align-items:flex-end;">
              <button id="applyFilter" class="primary" style="width:auto;">Terapkan</button>
              <button id="resetFilter" class="ghost" style="width:auto;">Reset</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>#</th><th>Status</th><th>Aksi</th><th>Nama / NIP / Pangkat</th><th>Jabatan</th><th>UKPD Asal</th><th>UKPD Tujuan</th><th>Jabatan Baru</th><th>ABK &amp; Bezetting (Lama)</th><th>ABK &amp; Bezetting (Baru)</th><th>Alasan</th><th>Berkas</th><th>Created By UKPD</th><th>Created At</th><th>Updated At</th><th>Keterangan</th>
                </tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
          <div class="pagination">
            <button class="ghost" id="prevPage">Sebelumnya</button>
            <div>Halaman <span id="pageNow">1</span> / <span id="pageTotal">1</span></div>
            <button class="ghost" id="nextPage">Berikutnya</button>
          </div>
        </div>
      </main>
      <div id="footer-container"></div>
    </div>
  </div>

  <div class="modal-backdrop" id="modalBackdrop"></div>

  <div class="modal" id="formModal" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-head">
        <h3 class="panel-title" id="formTitle" style="margin:0;">Tambah Usulan Mutasi</h3>
        <button type="button" class="close-btn" id="closeForm" aria-label="Tutup">×</button>
      </div>
      <div class="modal-body">
        <form id="mutasiForm" class="detail-grid">
          <div>
            <label>UKPD Asal</label>
            <select id="ukpdAsalSelect"></select>
            <input type="hidden" name="nama_ukpd" id="namaUkpdHidden">
          </div>
          <div>
            <label>Nama Pegawai (Bezetting)</label>
            <select name="nama_pegawai" id="pegawaiSelect" required>
              <option value="">Pilih pegawai</option>
            </select>
          </div>
          <div><label>NIP</label><input name="nip" id="nipInput" placeholder="NIP" required readonly></div>
          <div><label>Gelar Depan</label><input name="gelar_depan" placeholder="Gelar depan"></div>
          <div><label>Gelar Belakang</label><input name="gelar_belakang" placeholder="Gelar belakang"></div>
          <div><label>Pangkat / Golongan</label><input name="pangkat_golongan" id="pangkatInput" placeholder="Pangkat / golongan" readonly></div>
          <div><label>Jabatan (Saat Ini)</label><input name="jabatan" id="jabatanInput" placeholder="Jabatan saat ini" readonly></div>
          <div><label>Jenis Mutasi</label>
            <select name="jenis_mutasi">
              <option value="">Pilih</option>
              <option>Mutasi</option>
              <option>Rotasi</option>
              <option>Promosi</option>
              <option>Demosi</option>
            </select>
          </div>
          <div><label>Tanggal Usulan</label><input type="date" name="tanggal_usulan" id="tanggalUsulan"></div>
          <div><label>Status</label>
            <select name="status">
              <option value="DIUSULKAN">DIUSULKAN</option>
              <option value="DISETUJUI">DISETUJUI</option>
              <option value="DITOLAK">DITOLAK</option>
              <option value="DITARIK">DITARIK</option>
            </select>
          </div>
          <div>
            <label>UKPD Tujuan</label>
            <select name="ukpd_tujuan" id="ukpdTujuanSelect">
              <option value="">Pilih UKPD tujuan</option>
            </select>
          </div>
          <div>
            <label>Jabatan Baru (Bezetting)</label>
            <select id="jabatanBaruSelect">
              <option value="">Pilih jabatan baru</option>
            </select>
          </div>
          <div><label>Jabatan Baru</label><input name="jabatan_baru" id="jabatanBaruInput" placeholder="Jabatan baru" readonly></div>
          <div><label>ABK PNS (Lama)</label><input name="abk_j_lama" id="abkLamaInput" placeholder="ABK J lama" readonly></div>
          <div><label>Bezetting PNS (Lama)</label><input name="bezetting_j_lama" id="bezettingLamaInput" placeholder="Bezetting J lama" readonly></div>
          <div><label>Non-ASN Bezetting Lama</label><input name="nonasn_bezetting_lama" placeholder="Non-ASN bezetting lama"></div>
          <div><label>Non-ASN ABK Lama</label><input name="nonasn_abk_lama" placeholder="Non-ASN ABK lama"></div>
          <div><label>ABK PNS (Baru)</label><input name="abk_j_baru" id="abkBaruInput" placeholder="ABK J baru" readonly></div>
          <div><label>Bezetting PNS (Baru)</label><input name="bezetting_j_baru" id="bezettingBaruInput" placeholder="Bezetting J baru" readonly></div>
          <div><label>Non-ASN Bezetting Baru</label><input name="nonasn_bezetting_baru" placeholder="Non-ASN bezetting baru"></div>
          <div><label>Non-ASN ABK Baru</label><input name="nonasn_abk_baru" placeholder="Non-ASN ABK baru"></div>
          <div><label>Mutasi ID</label><input name="mutasi_id" placeholder="Mutasi ID (opsional)"></div>
          <div><label>Berkas (URL/Path)</label><input name="berkas_path" placeholder="https://... atau path" inputmode="url"></div>
          <div style="grid-column:1/-1;"><label>Alasan</label><textarea name="alasan" placeholder="Alasan mutasi"></textarea></div>
          <div style="grid-column:1/-1;"><label>Verifikasi Checklist</label><textarea name="verif_checklist" placeholder="Checklist verifikasi..."></textarea></div>
          <div style="grid-column:1/-1;"><label>Keterangan / Verifikasi</label><textarea name="keterangan" placeholder="Catatan verifikasi..."></textarea></div>
          <div style="display:flex; gap:10px; justify-content:flex-end; grid-column:1/-1;">
            <button type="button" class="ghost" id="resetForm">Reset</button>
            <button type="submit" class="primary" id="submitBtn">Simpan</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal" id="viewModal" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-head">
        <h3 class="panel-title" style="margin:0;">Detail Usulan</h3>
        <button type="button" class="close-btn" id="closeView" aria-label="Tutup">×</button>
      </div>
      <div class="modal-body">
        <div class="detail-grid" id="detailGrid"></div>
        <div style="margin-top:12px;">
          <label>Alasan</label>
          <div id="detailAlasan" style="white-space:pre-wrap; background:#f8fafc; border:1px solid var(--border); border-radius:10px; padding:10px;"></div>
        </div>
        <div style="margin-top:12px;">
          <label>Keterangan / Verifikasi</label>
          <div id="detailKet" style="white-space:pre-wrap; background:#f8fafc; border:1px solid var(--border); border-radius:10px; padding:10px;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const BASE = (() => {
      const parts = location.pathname.split('/').filter(Boolean);
      if (parts.length && parts[0].toUpperCase() === 'DATA_PEGAWAI') return '/' + parts[0] + '/';
      if (parts.length > 1) return '../';
      return '/';
    })();
    const favicon = document.querySelector("link[rel='icon']");
    if (favicon) favicon.href = BASE + 'foto/Dinkes.png';
    const API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.protocol === 'file:')
      ? 'http://127.0.0.1:5002'
      : 'https://sikepeg.seftianh23.workers.dev';
    const PROXY_KEY = 'proxy_5b8d2f7c4a9e1b6d3c7f2a8b5e9d4c6a';
    const API_HEADERS = { 'X-Proxy-Key': PROXY_KEY };
    const sidebar = fetch(BASE + 'sidebar.html').then(r=>r.text()).catch(()=>''), header = fetch(BASE + 'header.html').then(r=>r.text()).catch(()=>''), footer = fetch(BASE + 'footer.html').then(r=>r.text()).catch(()=> '');
    Promise.all([sidebar, header, footer]).then(([s,h,f])=>{
      document.getElementById('sidebar-container').innerHTML = s;
      document.getElementById('header-container').innerHTML = h;
      document.getElementById('footer-container').innerHTML = f;
      document.querySelectorAll('[data-path]').forEach(a=> a.href = BASE + a.dataset.path);
      document.querySelectorAll('[data-logo],[data-logo-header]').forEach(img=> img.src = BASE + 'foto/Dinkes.png');
      document.querySelector('.nav-item.active')?.classList.remove('active');
      const mLink = Array.from(document.querySelectorAll('.nav-item')).find(a=>a.textContent.trim().toLowerCase().includes('usulan mutasi'));
      if (mLink) mLink.classList.add('active');
      document.getElementById('logoutBtn')?.addEventListener('click', doLogout);
      const logoutNav = document.querySelector('[data-logout]');
      if (logoutNav) logoutNav.addEventListener('click', doLogout);
      initSidebarToggle();
      syncHeaderUser();
    });

    const authUser = (()=>{ try { return JSON.parse(localStorage.getItem('authUser')||'null'); } catch { return null; } })();
    if (!authUser) { window.location.href = BASE; }
    const norm = (v='') => String(v || '').toLowerCase().trim();
    const roleLower = norm(authUser?.role);
    const isSuper = roleLower.includes('super') || roleLower.includes('dinkes');
    const isWilayahAdmin = roleLower.includes('wilayah');
    const loginUkpd = authUser?.namaUkpd || authUser?.username || '';
    const loginWilayah = authUser?.wilayah || '';

    let editingId = null;
    let cacheRows = [];
    let page = 1;
    let totalPages = 1;
    let currentLimit = 10;
    const bezettingState = { allUkpds: null, wilayahUkpds: null, byUkpd: new Map() };

    const form = document.getElementById('mutasiForm');
    const ukpdAsalSelect = document.getElementById('ukpdAsalSelect');
    const namaUkpdHidden = document.getElementById('namaUkpdHidden');
    const pegawaiSelect = document.getElementById('pegawaiSelect');
    const nipInput = document.getElementById('nipInput');
    const pangkatInput = document.getElementById('pangkatInput');
    const jabatanInput = document.getElementById('jabatanInput');
    const tanggalUsulanInput = document.getElementById('tanggalUsulan');
    const ukpdTujuanSelect = document.getElementById('ukpdTujuanSelect');
    const jabatanBaruSelect = document.getElementById('jabatanBaruSelect');
    const jabatanBaruInput = document.getElementById('jabatanBaruInput');
    const abkLamaInput = document.getElementById('abkLamaInput');
    const bezettingLamaInput = document.getElementById('bezettingLamaInput');
    const abkBaruInput = document.getElementById('abkBaruInput');
    const bezettingBaruInput = document.getElementById('bezettingBaruInput');
    const resetFormBtn = document.getElementById('resetForm');
    const tableBody = document.getElementById('tableBody');
    const search = document.getElementById('search');
    const statusFilter = document.getElementById('statusFilter');
    const ukpdFilter = document.getElementById('ukpdFilter');
    const tujuanFilter = document.getElementById('tujuanFilter');
    const applyFilter = document.getElementById('applyFilter');
    const resetFilter = document.getElementById('resetFilter');
    const pageSize = document.getElementById('pageSize');
    const pageNow = document.getElementById('pageNow');
    const pageTotal = document.getElementById('pageTotal');
    const prevPage = document.getElementById('prevPage');
    const nextPage = document.getElementById('nextPage');
    const btnAdd = document.getElementById('btnAdd');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const formModal = document.getElementById('formModal');
    const viewModal = document.getElementById('viewModal');
    const closeForm = document.getElementById('closeForm');
    const closeView = document.getElementById('closeView');
    const formTitle = document.getElementById('formTitle');
    const submitBtn = document.getElementById('submitBtn');
    const detailGrid = document.getElementById('detailGrid');
    const detailAlasan = document.getElementById('detailAlasan');
    const detailKet = document.getElementById('detailKet');
    const totalFiltered = document.getElementById('totalFiltered');
    const roleBadge = document.getElementById('roleBadge');
    const userNameEl = document.getElementById('userName');
    const userRoleEl = document.getElementById('userRole');

    function showModal(el){
      el.classList.add('show');
      modalBackdrop.classList.add('show');
      el.setAttribute('aria-hidden','false');
    }
    function hideModal(el){
      el.classList.remove('show');
      if (![formModal, viewModal].some(m=>m.classList.contains('show'))) {
        modalBackdrop.classList.remove('show');
      }
      el.setAttribute('aria-hidden','true');
    }

    function badgeStatus(val){
      const v = (val||'').toUpperCase();
      if (v==='DISETUJUI') return '<span class="status-pill pill-success">Disetujui</span>';
      if (v==='DITOLAK') return '<span class="status-pill pill-danger">Ditolak</span>';
      if (v==='DITARIK') return '<span class="status-pill pill-warn">Ditarik</span>';
      return '<span class="status-pill pill-info">Diusulkan</span>';
    }

    function formatNama(row){
      const parts = [row.gelar_depan, row.nama_pegawai, row.gelar_belakang].filter(Boolean);
      return parts.join(' ').replace(/\s+/g, ' ').trim();
    }

    function formatAbk(abk, bezetting, nonasnAbk, nonasnBezetting){
      const asn = `ASN: ${abk || '-'} | Bezetting: ${bezetting || '-'}`;
      const nonasn = (nonasnAbk || nonasnBezetting)
        ? `<div class="pill-abk">Non-ASN: ${nonasnAbk || '-'} | Bezetting: ${nonasnBezetting || '-'}</div>`
        : '';
      return `<div class="pill-abk">${asn}</div>${nonasn}`;
    }

    function todayIso(){
      return new Date().toISOString().slice(0, 10);
    }

    function getJabatanOrb(row){
      return row.jabatan_orb || row.nama_jabatan_pergub || row.nama_jabatan_permenpan || row.jabatan || '';
    }

    function resetSelect(select, placeholder){
      if (!select) return;
      select.innerHTML = '';
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = placeholder || 'Pilih';
      select.appendChild(opt);
    }

    function addSelectOption(select, value, label, dataset){
      if (!select) return;
      const opt = document.createElement('option');
      opt.value = value;
      opt.textContent = label || value;
      if (dataset) {
        Object.entries(dataset).forEach(([key, val]) => {
          if (val !== undefined && val !== null) opt.dataset[key] = String(val);
        });
      }
      select.appendChild(opt);
    }

    function setSelectOptions(select, items, placeholder){
      resetSelect(select, placeholder);
      (items || []).forEach((item) => {
        if (!item) return;
        addSelectOption(select, item, item);
      });
    }

    function setSelectValue(select, value, label){
      if (!select) return;
      if (!value) {
        select.value = '';
        return;
      }
      const exists = Array.from(select.options).some(opt => opt.value === value);
      if (!exists) addSelectOption(select, value, label || value);
      select.value = value;
    }

    async function fetchBezettingMeta(params){
      const qs = new URLSearchParams(params || {});
      if (!qs.has('limit')) qs.set('limit', '1');
      const body = await apiFetch(`${API_BASE}?action=bezetting_list&${qs.toString()}`);
      return { rows: body.rows || [], ukpds: body.ukpds || [] };
    }

    async function getUkpdListAll(){
      if (bezettingState.allUkpds) return bezettingState.allUkpds;
      const meta = await fetchBezettingMeta();
      bezettingState.allUkpds = meta.ukpds || [];
      return bezettingState.allUkpds;
    }

    async function getUkpdListWilayah(){
      if (bezettingState.wilayahUkpds) return bezettingState.wilayahUkpds;
      const meta = await fetchBezettingMeta({ wilayah: loginWilayah || '' });
      bezettingState.wilayahUkpds = meta.ukpds || [];
      return bezettingState.wilayahUkpds;
    }

    async function getBezettingByUkpd(ukpd){
      const key = norm(ukpd);
      if (!key) return [];
      if (bezettingState.byUkpd.has(key)) return bezettingState.byUkpd.get(key);
      const qs = new URLSearchParams({ ukpd, limit: '30000' });
      const body = await apiFetch(`${API_BASE}?action=bezetting_list&${qs.toString()}`);
      const rows = body.rows || [];
      bezettingState.byUkpd.set(key, rows);
      return rows;
    }

    function resetPegawaiFields(){
      if (nipInput) nipInput.value = '';
      if (pangkatInput) pangkatInput.value = '';
      if (jabatanInput) jabatanInput.value = '';
      if (abkLamaInput) abkLamaInput.value = '';
      if (bezettingLamaInput) bezettingLamaInput.value = '';
    }

    function resetJabatanBaruFields(){
      if (jabatanBaruInput) jabatanBaruInput.value = '';
      if (abkBaruInput) abkBaruInput.value = '';
      if (bezettingBaruInput) bezettingBaruInput.value = '';
    }

    async function renderPegawaiOptions(ukpd, selectedName){
      if (!pegawaiSelect) return;
      resetSelect(pegawaiSelect, 'Pilih pegawai');
      resetPegawaiFields();
      if (!ukpd) {
        pegawaiSelect.disabled = true;
        return;
      }
      pegawaiSelect.disabled = false;
      const rows = await getBezettingByUkpd(ukpd);
      rows.filter(r => r.nama_pegawai).forEach((r) => {
        const label = r.nip ? `${r.nama_pegawai} - ${r.nip}` : r.nama_pegawai;
        addSelectOption(pegawaiSelect, r.nama_pegawai, label, {
          nip: r.nip || '',
          pangkat: r.pangkat_golongan || '',
          jabatan: getJabatanOrb(r),
          abk: r.abk || '',
          bezetting: r.eksisting || '',
          ukpd: r.ukpd || ''
        });
      });
      if (selectedName) setSelectValue(pegawaiSelect, selectedName);
      if (pegawaiSelect.value) applyPegawaiSelection();
    }

    function applyPegawaiSelection(){
      if (!pegawaiSelect) return;
      const opt = pegawaiSelect.selectedOptions[0];
      if (!opt || !opt.value) {
        resetPegawaiFields();
        return;
      }
      const dataset = opt.dataset || {};
      const hasData = Object.keys(dataset).length > 0;
      if (!hasData) return;
      if (nipInput) nipInput.value = dataset.nip || '';
      if (pangkatInput) pangkatInput.value = dataset.pangkat || '';
      if (jabatanInput) jabatanInput.value = dataset.jabatan || '';
      if (abkLamaInput) abkLamaInput.value = dataset.abk || '';
      if (bezettingLamaInput) bezettingLamaInput.value = dataset.bezetting || '';
      if (namaUkpdHidden && dataset.ukpd) namaUkpdHidden.value = dataset.ukpd;
    }

    async function renderJabatanOptions(ukpd, selectedJabatan){
      if (!jabatanBaruSelect) return;
      resetSelect(jabatanBaruSelect, 'Pilih jabatan baru');
      resetJabatanBaruFields();
      if (!ukpd) {
        jabatanBaruSelect.disabled = true;
        return;
      }
      jabatanBaruSelect.disabled = false;
      const rows = await getBezettingByUkpd(ukpd);
      rows.forEach((r) => {
        const jabatan = getJabatanOrb(r);
        if (!jabatan) return;
        const permenpan = r.nama_jabatan_permenpan || '';
        const label = permenpan && permenpan !== jabatan ? `${jabatan} (${permenpan})` : jabatan;
        addSelectOption(jabatanBaruSelect, jabatan, label, {
          jabatan,
          abk: r.abk || '',
          bezetting: r.eksisting || ''
        });
      });
      if (selectedJabatan) setSelectValue(jabatanBaruSelect, selectedJabatan);
      if (jabatanBaruSelect.value) applyJabatanBaruSelection();
    }

    function applyJabatanBaruSelection(){
      if (!jabatanBaruSelect) return;
      const opt = jabatanBaruSelect.selectedOptions[0];
      if (!opt || !opt.value) {
        resetJabatanBaruFields();
        return;
      }
      const dataset = opt.dataset || {};
      if (jabatanBaruInput) jabatanBaruInput.value = dataset.jabatan || opt.value || '';
      if (abkBaruInput) abkBaruInput.value = dataset.abk || '';
      if (bezettingBaruInput) bezettingBaruInput.value = dataset.bezetting || '';
    }

    async function renderUkpdAsalOptions(selectedUkpd){
      if (!ukpdAsalSelect) return;
      if (!isSuper && !isWilayahAdmin) {
        setSelectOptions(ukpdAsalSelect, loginUkpd ? [loginUkpd] : [], 'UKPD asal');
        ukpdAsalSelect.value = loginUkpd || '';
        ukpdAsalSelect.disabled = true;
        if (namaUkpdHidden) namaUkpdHidden.value = ukpdAsalSelect.value;
        return;
      }
      ukpdAsalSelect.disabled = false;
      const ukpds = isWilayahAdmin ? await getUkpdListWilayah() : await getUkpdListAll();
      setSelectOptions(ukpdAsalSelect, ukpds, 'Pilih UKPD asal');
      if (selectedUkpd) setSelectValue(ukpdAsalSelect, selectedUkpd);
      if (namaUkpdHidden) namaUkpdHidden.value = ukpdAsalSelect.value || '';
    }

    async function renderUkpdTujuanOptions(selectedUkpd){
      if (!ukpdTujuanSelect) return;
      const ukpds = await getUkpdListAll();
      setSelectOptions(ukpdTujuanSelect, ukpds, 'Pilih UKPD tujuan');
      if (selectedUkpd) setSelectValue(ukpdTujuanSelect, selectedUkpd);
    }

    async function applyFormDefaults(selectedAsal, selectedPegawai, selectedTujuan, selectedJabatan){
      if (tanggalUsulanInput && !tanggalUsulanInput.value) tanggalUsulanInput.value = todayIso();
      const asalUkpd = selectedAsal || (!isSuper && !isWilayahAdmin ? loginUkpd : '');
      await renderUkpdAsalOptions(asalUkpd);
      if (asalUkpd) {
        await renderPegawaiOptions(asalUkpd, selectedPegawai);
        if (selectedPegawai) applyPegawaiSelection();
      } else {
        resetSelect(pegawaiSelect, 'Pilih pegawai');
        if (pegawaiSelect) pegawaiSelect.disabled = true;
        resetPegawaiFields();
      }
      await renderUkpdTujuanOptions(selectedTujuan);
      if (selectedTujuan) {
        await renderJabatanOptions(selectedTujuan, selectedJabatan);
        if (selectedJabatan) applyJabatanBaruSelection();
      } else {
        resetSelect(jabatanBaruSelect, 'Pilih jabatan baru');
        if (jabatanBaruSelect) jabatanBaruSelect.disabled = true;
        resetJabatanBaruFields();
      }
    }

    function normalizeMutasiRow(row){
      const next = { ...(row || {}) };
      if (!next.id) next.id = next.id_usulan || '';
      if (!next.nama_ukpd) next.nama_ukpd = next.nama_ukpd_asal || next.ukpd_asal || '';
      if (!next.ukpd_tujuan) next.ukpd_tujuan = next.nama_ukpd_tujuan || '';
      if (!next.jabatan) next.jabatan = next.jabatan_asal || '';
      if (!next.pangkat_golongan) next.pangkat_golongan = next.pangkat_gol || '';
      if (!next.berkas_path) next.berkas_path = next.berkas_url || next.link_dokumen || '';
      if (next.id !== undefined && next.id !== null) next.id = String(next.id);
      return next;
    }

    async function apiFetch(url, options={}){
      const opts = { ...options };
      opts.headers = { ...API_HEADERS, ...(opts.headers || {}) };
      if (opts.body && !opts.headers['Content-Type']) opts.headers['Content-Type'] = 'application/json';
      const res = await fetch(url, opts);
      const text = await res.text();
      let body;
      try { body = JSON.parse(text); }
      catch { throw new Error(text || 'Respon bukan JSON'); }
      if (!res.ok || !body.ok) throw new Error(body.error || 'Permintaan gagal');
      return body;
    }

    function renderMetrics(summary, total){
      const totalCount = typeof total === 'number' ? total : cacheRows.length;
      const disetujui = summary.DISETUJUI || 0;
      const ditolak = summary.DITOLAK || 0;
      const diusulkan = summary.DIUSULKAN || 0;
      const ditarik = summary.DITARIK || 0;
      const proses = totalCount - (disetujui + ditolak + ditarik);
      document.getElementById('mTotal').textContent = totalCount;
      document.getElementById('mDiusulkan').textContent = diusulkan;
      document.getElementById('mProses').textContent = proses < 0 ? 0 : proses;
      document.getElementById('mSelesai').textContent = disetujui;
      document.getElementById('mDitolak').textContent = ditolak;
      totalFiltered.textContent = totalCount;
    }

    function syncHeaderUser(){
      if (!authUser) return;
      const roleText = (authUser.role || 'USER').toUpperCase();
      const namaText = authUser.namaUkpd || authUser.username || 'User';
      if (roleBadge) roleBadge.textContent = roleText;
      if (userNameEl) userNameEl.textContent = namaText;
      if (userRoleEl) userRoleEl.textContent = authUser.role || '';
      const headerRole = document.getElementById('rolePill');
      const headerUkpd = document.getElementById('ukpdPill');
      const headerName = document.getElementById('userName');
      const headerRoleText = document.getElementById('userRole');
      if (headerRole) headerRole.textContent = roleText;
      if (headerUkpd) headerUkpd.textContent = namaText;
      if (headerName) headerName.textContent = namaText;
      if (headerRoleText) headerRoleText.textContent = authUser.role || '';
    }

    function renderFilters(body){
      const setOptions = (el, list)=>{ el.innerHTML = '<option value="">Semua</option>' + (list||[]).map(v=>`<option>${v}</option>`).join(''); };
      setOptions(ukpdFilter, body.ukpds || []);
      setOptions(tujuanFilter, body.tujuan || []);
      if (!isSuper && !isWilayahAdmin){
        ukpdFilter.value = loginUkpd;
        ukpdFilter.disabled = true;
      } else {
        ukpdFilter.disabled = false;
      }
    }

    function renderTable(){
      tableBody.innerHTML = '';
      cacheRows.forEach((r, idx)=>{
        const tr = document.createElement('tr');
        const nama = formatNama(r) || r.nama_pegawai || '-';
        const alasan = (r.alasan||'').replace(/\n/g,'<br>');
        const ket = (r.keterangan||'-').replace(/\n/g,'<br>');
        const verif = (r.verif_checklist||'').replace(/\n/g,'<br>');
        const verifHtml = verif ? `<div style="color:var(--muted); font-size:12px;">Verif: ${verif}</div>` : '';
        tr.innerHTML = `
          <td>${(page-1)*currentLimit + idx + 1}</td>
          <td>${badgeStatus(r.status)}</td>
          <td class="actions">
            <div class="dropdown">
              <button class="ghost dropdown-toggle">Aksi v</button>
              <div class="dropdown-menu">
                <button data-action="view" data-id="${r.id}">Lihat</button>
                <button data-action="edit" data-id="${r.id}">Ubah</button>
                <button data-action="delete" data-id="${r.id}">Hapus</button>
              </div>
            </div>
          </td>
          <td>
            <div style="font-weight:700;">${nama}</div>
            <div style="color:var(--muted); font-size:12px;">NIP: ${r.nip||'-'}</div>
            <div style="color:var(--muted); font-size:12px;">Pangkat/Gol: ${r.pangkat_golongan||'-'}</div>
          </td>
          <td>
            <div style="font-weight:700;">${r.jabatan||'-'}</div>
            <div style="color:var(--muted); font-size:12px;">Jenis: ${r.jenis_mutasi||'-'}</div>
          </td>
          <td>${r.nama_ukpd||'-'}</td>
          <td>${r.ukpd_tujuan||'-'}</td>
          <td>${r.jabatan_baru||'-'}</td>
          <td>${formatAbk(r.abk_j_lama, r.bezetting_j_lama, r.nonasn_abk_lama, r.nonasn_bezetting_lama)}</td>
          <td>${formatAbk(r.abk_j_baru, r.bezetting_j_baru, r.nonasn_abk_baru, r.nonasn_bezetting_baru)}</td>
          <td style="min-width:220px;">${alasan||'-'}</td>
          <td>${r.berkas_path ? `<a href="${r.berkas_path}" target="_blank" rel="noopener">Berkas</a>` : '-'}</td>
          <td>${r.created_by_ukpd || '-'}</td>
          <td>${r.created_at || '-'}</td>
          <td>${r.updated_at || '-'}</td>
          <td style="min-width:220px;">${verifHtml}${ket}</td>
        `;
        tableBody.appendChild(tr);
      });

      // dropdown toggle
      tableBody.querySelectorAll('.dropdown-toggle').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          const dd = btn.closest('.dropdown');
          document.querySelectorAll('.dropdown').forEach(o=>{ if (o!==dd) o.classList.remove('open'); });
          dd.classList.toggle('open');
        });
      });
      document.addEventListener('click', ()=> document.querySelectorAll('.dropdown').forEach(o=> o.classList.remove('open')), { once:true });
    }

    async function loadData(){
      const params = new URLSearchParams();
      params.set('limit', currentLimit);
      params.set('offset', (page-1)*currentLimit);
      if (search.value) params.set('search', search.value);
      if (statusFilter.value) params.set('status', statusFilter.value);
      if (isSuper) {
        if (ukpdFilter.value) params.set('ukpd', ukpdFilter.value);
      } else if (isWilayahAdmin) {
        if (loginWilayah) params.set('wilayah', loginWilayah);
        if (ukpdFilter.value) params.set('ukpd', ukpdFilter.value);
      } else {
        params.set('ukpd', loginUkpd);
      }
      if (tujuanFilter.value) params.set('tujuan', tujuanFilter.value);
      const body = await apiFetch(`${API_BASE}?action=mutasi_list&${params.toString()}`);
      cacheRows = (body.rows || []).map(normalizeMutasiRow);
      const total = typeof body.total === 'number' ? body.total : cacheRows.length;
      totalPages = Math.max(1, Math.ceil(total / currentLimit));
      pageNow.textContent = page;
      pageTotal.textContent = totalPages;
      renderMetrics(body.summary || {}, total);
      renderFilters(body);
      renderTable();
    }

    async function saveMutasi(e){
      e.preventDefault();
      const data = Object.fromEntries(new FormData(form).entries());
      const currentRow = editingId ? cacheRows.find(r=>String(r.id || '') === String(editingId || '')) : null;
      if (!data.berkas_path && currentRow?.berkas_path) {
        data.berkas_path = currentRow.berkas_path;
      }
      if (!data.nama_ukpd && namaUkpdHidden?.value) {
        data.nama_ukpd = namaUkpdHidden.value;
      }
      const nowIso = new Date().toISOString();
      if (!editingId) {
        if (!data.created_at) data.created_at = nowIso;
        if (!data.created_by_ukpd) data.created_by_ukpd = loginUkpd;
      }
      data.updated_at = nowIso;
      if (!isSuper && !isWilayahAdmin) {
        data.nama_ukpd = loginUkpd;
      }
      const action = editingId ? 'mutasi_update' : 'mutasi_create';
      const bodyPayload = { action, ...data };
      if (editingId) bodyPayload.id = editingId;
      await apiFetch(API_BASE, { method: 'POST', body: JSON.stringify(bodyPayload) });
      editingId = null;
      form.reset();
      await loadData();
      alert('Berhasil disimpan');
      hideModal(formModal);
    }

    async function deleteMutasi(id){
      if (!confirm('Hapus usulan ini?')) return;
      await apiFetch(API_BASE, {
        method: 'POST',
        body: JSON.stringify({ action: 'mutasi_delete', id })
      });
      await loadData();
    }

    function openView(row){
      const fields = [
        ['NIP', row.nip],
        ['Nama', formatNama(row) || row.nama_pegawai],
        ['Gelar Depan', row.gelar_depan],
        ['Gelar Belakang', row.gelar_belakang],
        ['Pangkat/Golongan', row.pangkat_golongan],
        ['Jabatan', row.jabatan],
        ['Jenis Mutasi', row.jenis_mutasi],
        ['Tanggal Usulan', row.tanggal_usulan],
        ['Status', row.status],
        ['UKPD Asal', row.nama_ukpd],
        ['UKPD Tujuan', row.ukpd_tujuan],
        ['ABK J Lama', row.abk_j_lama],
        ['Bezetting J Lama', row.bezetting_j_lama],
        ['Non-ASN Bezetting Lama', row.nonasn_bezetting_lama],
        ['Non-ASN ABK Lama', row.nonasn_abk_lama],
        ['Jabatan Baru', row.jabatan_baru],
        ['ABK J Baru', row.abk_j_baru],
        ['Bezetting J Baru', row.bezetting_j_baru],
        ['Non-ASN Bezetting Baru', row.nonasn_bezetting_baru],
        ['Non-ASN ABK Baru', row.nonasn_abk_baru],
        ['Mutasi ID', row.mutasi_id],
        ['Verifikasi Checklist', row.verif_checklist],
        ['Berkas', row.berkas_path ? `<a href="${row.berkas_path}" target="_blank" rel="noopener">Buka Berkas</a>` : '-'],
        ['Created By UKPD', row.created_by_ukpd],
        ['Created At', row.created_at],
        ['Updated At', row.updated_at],
      ];
      detailGrid.innerHTML = fields.map(([l,v])=>`<div class="detail-card"><div class="detail-label">${l}</div><div class="detail-value">${v||'-'}</div></div>`).join('');
      detailAlasan.textContent = row.alasan || '-';
      detailKet.textContent = row.keterangan || '-';
      showModal(viewModal);
    }

    tableBody.addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if (!btn) return;
      const id = btn.dataset.id;
      const action = btn.dataset.action;
      const row = cacheRows.find(r=>String(r.id || '') === String(id || ''));
      if (action==='view' && row){ openView(row); }
      if (action==='edit' && row){
        openEditForm(row).catch(err=>alert(err.message));
      }
      if (action==='delete' && id) deleteMutasi(id).catch(err=>alert(err.message));
    });

    async function openAddForm(){
      editingId = null;
      form.reset();
      await applyFormDefaults();
      submitBtn.textContent = 'Simpan';
      formTitle.textContent = 'Tambah Usulan Mutasi';
      showModal(formModal);
    }

    async function openEditForm(row){
      editingId = row.id;
      form.reset();
      Object.keys(row).forEach(k=>{ if (form.elements[k]) form.elements[k].value = row[k] || ''; });
      if (namaUkpdHidden && row.nama_ukpd) namaUkpdHidden.value = row.nama_ukpd;
      await applyFormDefaults(row.nama_ukpd, row.nama_pegawai, row.ukpd_tujuan, row.jabatan_baru);
      formTitle.textContent = 'Ubah Usulan Mutasi';
      submitBtn.textContent = 'Update';
      showModal(formModal);
    }

    if (ukpdAsalSelect) {
      ukpdAsalSelect.addEventListener('change', ()=>{
        if (namaUkpdHidden) namaUkpdHidden.value = ukpdAsalSelect.value || '';
        renderPegawaiOptions(ukpdAsalSelect.value, '').catch(err=>alert(err.message));
      });
    }
    if (pegawaiSelect) {
      pegawaiSelect.addEventListener('change', ()=>{ applyPegawaiSelection(); });
    }
    if (ukpdTujuanSelect) {
      ukpdTujuanSelect.addEventListener('change', ()=>{
        renderJabatanOptions(ukpdTujuanSelect.value, '').catch(err=>alert(err.message));
      });
    }
    if (jabatanBaruSelect) {
      jabatanBaruSelect.addEventListener('change', ()=>{ applyJabatanBaruSelection(); });
    }

    form.addEventListener('submit', (e)=>{ saveMutasi(e).catch(err=>alert(err.message)); });
    resetFormBtn.addEventListener('click', ()=>{ editingId=null; form.reset(); applyFormDefaults().catch(err=>alert(err.message)); submitBtn.textContent='Simpan'; formTitle.textContent='Tambah Usulan Mutasi'; });
    applyFilter.addEventListener('click', ()=>{ page=1; loadData().catch(err=>alert(err.message)); });
    resetFilter.addEventListener('click', ()=>{
      statusFilter.value = '';
      search.value = '';
      ukpdFilter.value = (!isSuper && !isWilayahAdmin) ? loginUkpd : '';
      tujuanFilter.value = '';
      page = 1;
      loadData().catch(err=>alert(err.message));
    });
    [statusFilter, ukpdFilter, tujuanFilter, search].forEach(el=> el.addEventListener('change', ()=>{ page=1; loadData().catch(err=>alert(err.message)); }));
    pageSize.addEventListener('change', ()=>{ currentLimit=parseInt(pageSize.value,10)||10; page=1; loadData().catch(err=>alert(err.message)); });
    prevPage.addEventListener('click', ()=>{ if (page>1){ page--; loadData().catch(err=>alert(err.message)); } });
    nextPage.addEventListener('click', ()=>{ if (page<totalPages){ page++; loadData().catch(err=>alert(err.message)); } });
    btnAdd.addEventListener('click', ()=>{ openAddForm().catch(err=>alert(err.message)); });
    closeForm.addEventListener('click', ()=> hideModal(formModal));
    closeView.addEventListener('click', ()=> hideModal(viewModal));
    modalBackdrop.addEventListener('click', ()=>{ hideModal(formModal); hideModal(viewModal); });
    document.addEventListener('keydown', (e)=>{ if (e.key==='Escape'){ hideModal(formModal); hideModal(viewModal); } });

    function doLogout(){ localStorage.removeItem('authUser'); window.location.href = BASE; }

    function initSidebarToggle(){
      const btn = document.getElementById('sidebarToggle');
      const backdrop = document.getElementById('sidebarBackdrop');
      const sidebarEl = document.querySelector('.sidebar');
      if (!btn || !backdrop || !sidebarEl) return;
      const close = ()=>{ sidebarEl.classList.remove('show'); backdrop.classList.remove('show'); document.body.style.overflow=''; };
      btn.addEventListener('click', ()=>{
        const willShow = !sidebarEl.classList.contains('show');
        sidebarEl.classList.toggle('show', willShow);
        backdrop.classList.toggle('show', willShow);
        document.body.style.overflow = willShow ? 'hidden' : '';
      });
      backdrop.addEventListener('click', close);
      sidebarEl.addEventListener('click', (e)=>{ if (e.target.closest('a')) close(); });
      window.addEventListener('resize', ()=>{ if (window.innerWidth >= 1100) close(); });
    }

    loadData().catch(err=>alert(err.message));
  </script>
</body>
</html>





