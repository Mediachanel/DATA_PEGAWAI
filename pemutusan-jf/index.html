<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Usulan Pemutusan JF</title>
  <link rel="icon" type="image/png" href="foto/Dinkes.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#f4f6f6;
      --card:#fff;
      --border:#e4eaee;
      --muted:#6b7280;
      --ink:#152025;
      --accent:#0f9d94;
      --accent-2:#f59e0b;
      --accent-soft:#e9fbf8;
      --shadow:0 18px 40px rgba(24,39,75,0.12);
      --shadow-sm:0 10px 24px rgba(15,23,42,0.08);
      --shadow-md:0 18px 44px rgba(15,23,42,0.14);
      --ring: rgba(15, 157, 148, 0.25);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:'Plus Jakarta Sans','Inter','Segoe UI',Arial,sans-serif;
      background:radial-gradient(circle at 12% 20%, rgba(15,157,148,0.12), transparent 35%), radial-gradient(circle at 86% 10%, rgba(245,158,11,0.12), transparent 40%), #f4f6f6;
      color:var(--ink);
    }
    .layout{ min-height:100vh; }
    .content{ margin-left:260px; min-height:100vh; display:flex; flex-direction:column; transition:margin .2s ease; }
    main{ padding:18px; }
    .page{ width:100%; max-width:none; margin:0; display:flex; flex-direction:column; gap:12px; padding:0; }
    .sidebar{
      position:fixed; inset:0 auto 0 0; width:260px; background:linear-gradient(180deg, #ffffff 0%, #f9fbfb 100%); color:#475569; padding:18px 14px; display:flex; flex-direction:column; gap:18px; min-height:100vh; box-shadow:8px 0 30px -20px rgba(15,23,42,0.12); border-right:1px solid var(--border); backdrop-filter:blur(8px);
    }
    .logo{ display:flex; align-items:center; gap:10px; color:var(--ink); font-weight:800; }
    .logo img{ width:38px; height:38px; object-fit:contain; }
    .logo-title{ font-size:13px; text-transform:uppercase; letter-spacing:.2px; }
    .logo-sub{ font-size:12px; color:#94a3b8; }
    nav{ display:flex; flex-direction:column; gap:6px; }
    .nav-title{ margin:18px 10px 6px; font-size:11px; letter-spacing:0.5px; text-transform:uppercase; color:#94a3b8; }
    .nav-item{ display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; color:#475569; text-decoration:none; transition:all .15s ease; font-weight:600; }
    .nav-item:hover{ background:#f7fbfb; }
    .nav-item.active{ background:var(--accent-soft); color:#0f7f73; font-weight:700; box-shadow:0 10px 22px rgba(15,157,148,0.2); }
    .icon-round{ width:26px; height:26px; border-radius:10px; background:rgba(15,157,148,0.12); color:#0f7f73; display:grid; place-items:center; font-size:12px; }
    .hero{
      background:#ffffff;
      border-radius:18px;
      padding:18px;
      box-shadow:var(--shadow-md);
      position:relative;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      gap:12px;
      color:var(--ink);
      border:1px solid var(--border);
    }
    .hero::before{
      content:'';
      position:absolute;
      inset:0 0 auto 0;
      height:6px;
      background:linear-gradient(90deg, var(--accent), var(--accent-2));
    }
    .hero h2{ color:#0f172a; }
    .hero p{ color:var(--muted); }
    .hero .eyebrow{ color:#94a3b8; }
    .hero-top{ display:flex; align-items:flex-start; justify-content:space-between; gap:16px; flex-wrap:wrap; position:relative; z-index:2; }
    .eyebrow{ text-transform:uppercase; letter-spacing:.4px; color:#94a3b8; font-weight:800; font-size:11px; margin:0; }
    .hero h2{ margin:6px 0 4px; font-size:26px; }
    .hero p{ margin:0; color:var(--muted); max-width:680px; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; font-weight:700; font-size:12px; border:1px solid transparent; }
    .pill.role{ background:#e0f2fe; color:#0369a1; box-shadow:0 8px 20px rgba(3,105,161,0.12); }
    .hero-actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .hero-meta{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; z-index:2; }
    .meta-actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .preview-shell{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      box-shadow:var(--shadow-sm);
      position:relative;
      overflow:hidden;
      z-index:2;
    }
    .preview-shell::before{
      content:'';
      position:absolute;
      inset:0;
      background:linear-gradient(135deg,rgba(255,88,179,0.08),rgba(11,188,180,0.08));
      pointer-events:none;
    }
    .preview-toolbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding-bottom:12px; border-bottom:1px dashed var(--border); }
    .toolbar-left{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .brand-mark{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:12px; background:#e9fbf8; color:#4338ca; font-weight:800; }
    .preview-tabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .preview-pill{ padding:8px 10px; border-radius:10px; background:#f7fbfb; border:1px solid var(--border); font-size:12px; font-weight:700; color:#475569; }
    .preview-search{ display:inline-flex; align-items:center; gap:6px; padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:#f7fbfb; color:#94a3b8; min-width:220px; }
    .preview-search .dot{ width:10px; height:10px; border-radius:999px; background:var(--accent); display:inline-block; }
    .toolbar-actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .toolbar-pill{ padding:8px 10px; border-radius:10px; background:var(--accent-soft); color:#0f7f73; border:1px solid #b9efe8; font-weight:700; }
    .avatar-mock{ width:36px; height:36px; border-radius:12px; background:linear-gradient(135deg,var(--accent),var(--accent-2)); }
    .preview-body{ display:grid; grid-template-columns:2fr 1.05fr; gap:12px; margin-top:12px; }
    .preview-grid{ display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); }
    .preview-card{ background:#f9fafb; border:1px solid var(--border); border-radius:12px; padding:10px 12px; box-shadow:0 10px 18px rgba(15,23,42,0.05); }
    .mini-title{ font-size:12px; font-weight:800; color:#475569; text-transform:uppercase; letter-spacing:.2px; }
    .bars{ display:grid; gap:6px; margin-top:8px; }
    .bars span{ display:block; height:10px; border-radius:999px; background:linear-gradient(90deg,var(--accent),var(--accent-2)); opacity:.9; width:var(--w,70%); }
    .donut{ width:120px; height:120px; border-radius:50%; background:conic-gradient(var(--accent) 0 120deg, #3b82f6 120deg 220deg, var(--accent-2) 220deg 360deg); margin:10px auto; position:relative; }
    .donut::after{ content:''; position:absolute; inset:28px; border-radius:50%; background:#f9fafb; }
    .list-soft{ display:grid; gap:6px; margin-top:8px; color:#475569; }
    .list-soft span{ display:flex; justify-content:space-between; font-weight:700; }
    .preview-side{ display:grid; gap:10px; }
    .banner{ border-radius:14px; padding:14px; color:#fff; background:radial-gradient(circle at 10% 10%, rgba(255,255,255,0.35), transparent 35%), linear-gradient(135deg,#06b6d4,#4f46e5); box-shadow:0 12px 24px rgba(79,70,229,0.25); }
    .banner h4{ margin:0 0 4px; }
    .mini-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:8px; }
    .mini-grid .mini-card{ border-radius:12px; padding:10px; background:#f7fbfb; border:1px solid var(--border); font-weight:800; color:#0f172a; box-shadow:0 8px 16px rgba(15,23,42,0.05); }
    .mini-grid .muted{ color:var(--muted); font-weight:600; font-size:12px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:18px; padding:16px; box-shadow:var(--shadow-sm); position:relative; z-index:1; }
    .metric-grid{ display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); }
    .metric{ border-radius:16px; padding:14px 16px; border:1px solid #d9e3ee; box-shadow:0 10px 22px rgba(15,23,42,0.05); }
    .metric .label{ color:#64748b; font-size:11px; text-transform:uppercase; letter-spacing:.6px; }
    .metric .value{ font-size:24px; font-weight:800; margin-top:4px; color:#111827; }
    .metric.blue{ background:linear-gradient(135deg, #eef6ff, #dbeeff); }
    .metric.orange{ background:linear-gradient(135deg, #fff7d6, #ffe9a8); }
    .metric.green{ background:linear-gradient(135deg, #e7fff5, #d6fce8); }
    .metric.red{ background:linear-gradient(135deg, #ffe8e8, #ffd6d6); }
    .filters{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; align-items:end; }
    label{ font-size:12px; font-weight:800; color:#475569; text-transform:uppercase; letter-spacing:.4px; display:block; margin-bottom:6px; }
    input, select, textarea{ width:100%; padding:11px 12px; border:1px solid var(--border); border-radius:12px; font-size:14px; font-family:'Plus Jakarta Sans','Inter','Segoe UI',Arial,sans-serif; background:#f9fafb; }
    input:focus, select:focus, textarea:focus{ outline:2px solid var(--ring); border-color:#b8e6e1; }
    button{ font-family:'Plus Jakarta Sans','Inter','Segoe UI',Arial,sans-serif; }
    button.primary{
      background:var(--accent);
      color:#ffffff;
      border:none;
      font-weight:800;
      box-shadow:0 15px 35px rgba(15,157,148,0.28);
      cursor:pointer;
      border-radius:12px;
      padding:11px 14px;
      transition:transform .15s ease, box-shadow .15s ease, filter .15s ease;
    }
    button.primary:hover{ transform:translateY(-1px); box-shadow:0 18px 40px rgba(15,157,148,0.32); filter:saturate(1.05); }
    button.ghost{ background:#f7fbfb; color:var(--ink); border:1px solid var(--border); cursor:pointer; border-radius:12px; padding:11px 14px; box-shadow:0 10px 18px rgba(15,23,42,0.04); }
    table{ width:100%; border-collapse:collapse; }
    th, td{ padding:9px 10px; border-bottom:1px solid var(--border); text-align:left; font-size:12.5px; vertical-align:top; }
    th{ background:#f3f6fb; text-transform:uppercase; letter-spacing:.6px; font-size:11.5px; color:#475569; position: sticky; top: 0; z-index: 1; }
    tbody tr:nth-child(even){ background:#fafcfd; }
    tbody tr:hover{ background:#f1f6fb; }
    .table-wrap{ overflow-x:auto; overflow-y:visible; }
    td.actions{ position:relative; }
    .status-pill{ display:inline-flex; align-items:center; gap:6px; padding:7px 10px; border-radius:999px; font-weight:800; font-size:12px; border:1px solid transparent; }
    .pill-info{ background:#e0f2fe; color:#0f5098; }
    .pill-success{ background:#dcfce7; color:#166534; }
    .pill-danger{ background:#fee2e2; color:#b91c1c; }
    .pill-warn{ background:#fef9c3; color:#92400e; }
    .pill-meta{ display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px; background:#f7fbfb; border:1px solid var(--border); font-size:12px; }
    .dropdown-menu{ position:absolute; top:110%; left:0; min-width:170px; background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:0 12px 30px rgba(15,23,42,0.12); padding:6px 0; display:none; z-index:60; }
    .dropdown-menu button, .dropdown-menu a{ width:100%; text-align:left; background:none; border:none; padding:10px 12px; font-size:13px; cursor:pointer; display:block; color:#0f172a; text-decoration:none; }
    .dropdown-menu button:hover, .dropdown-menu a:hover{ background:#f7fbfb; }
    .pagination{ display:flex; gap:10px; align-items:center; justify-content:flex-end; margin-top:12px; flex-wrap:wrap; }
    .status-bar{ margin-top:10px; color:var(--muted); font-size:13px; }
    .mobile-toggle{ position:fixed; top:14px; left:14px; z-index:70; background:var(--accent); color:#f7fbfb; border:1px solid rgba(255,255,255,0.18); border-radius:14px; padding:10px 14px; display:none; align-items:center; gap:8px; font-weight:800; box-shadow:0 12px 26px rgba(18,183,166,0.35); }
    #sidebarBackdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.45); opacity:0; pointer-events:none; transition:opacity .2s ease; z-index:50; }
    #sidebarBackdrop.show{ opacity:1; pointer-events:auto; }
    .modal-backdrop{ position:fixed; inset:0; background:rgba(15,23,42,0.35); opacity:0; pointer-events:none; transition:opacity .15s ease; z-index:80; backdrop-filter: blur(4px); }
    .modal-backdrop.show{ opacity:1; pointer-events:auto; }
    .modal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; z-index:90; transition:opacity .15s ease, transform .15s ease; padding:14px; transform: translateY(12px) scale(0.98); }
    .modal.show{ opacity:1; pointer-events:auto; transform: translateY(0) scale(1); }
    .modal-dialog{ width:min(960px,100%); background:var(--card); border:1px solid var(--border); border-radius:18px; box-shadow:0 18px 48px rgba(15,23,42,0.18); max-height:90vh; overflow:auto; }
    .modal-head{ padding:16px 18px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .modal-body{ padding:16px 18px 20px; }
    .close-btn{ background:none; border:1px solid var(--border); border-radius:10px; padding:8px 12px; cursor:pointer; font-weight:800; }
    .form-grid{ display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); }
    .form-grid textarea{ min-height:90px; resize:vertical; grid-column:1/-1; }
    .detail-grid{ display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); }
    .detail-card{ border:1px solid var(--border); border-radius:12px; padding:10px 12px; background:#f7fbfb; }
    .detail-label{ font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.3px; }
    .detail-value{ font-weight:700; margin-top:2px; }
    .info-card{ line-height:1.6; color:#1f2a2e; }
    .info-card h3{ margin:4px 0 8px; }
    .tech-list{ margin:6px 0 0 16px; color:#1f2a2e; }
    .tech-list li{ margin:4px 0; }
    @media (max-width:1200px){ .preview-body{ grid-template-columns:1fr; } }
    @media (max-width:1100px){
      .content{ margin-left:0; }
      .sidebar{ position:fixed; inset:0 auto 0 0; width:calc(100vw - 72px); max-width:280px; transform:translateX(-100%); transition:transform .2s ease; z-index:60; min-height:100vh; box-shadow:8px 0 30px -20px rgba(0,0,0,0.5); }
      .sidebar.show{ transform:translateX(0); }
      .mobile-toggle{ display:inline-flex; }
      main{ padding:14px; margin-top:20px; padding-top:62px; }
    }
    @media (max-width:768px){
      .hero{ padding:16px; }
      .preview-search{ min-width:auto; width:100%; }
      .hero-top{ flex-direction:column; }
    }
    @media (max-width:640px){ th, td{ font-size:12px; } .preview-tabs{ width:100%; } }
  </style>
</head>
<body>
  <div id="sidebarBackdrop"></div>
  <button id="sidebarToggle" aria-label="Buka menu" class="mobile-toggle"><span style="font-size:18px;">&#9776;</span> Menu</button>
    <div class="layout">
      <div id="sidebar-container"></div>
      <div class="content">
        <div id="header-container"></div>
        <main>
        <div class="page">
        <section class="hero">
          <div class="hero-top">
            <div class="hero-copy">
              <p class="eyebrow">Pemutusan JF</p>
              <div class="pill role" id="roleBadge">-</div>
              <h2>Usulan Pemutusan Jabatan Fungsional</h2>
            </div>
            <div class="hero-actions">
              <button class="ghost" id="refreshBtn" type="button">Muat ulang</button>
              <button class="primary" id="addBtn" style="min-width:150px;">+ Tambah Usulan</button>
            </div>
          </div>
        </section>

        <div class="metric-grid">
          <div class="metric blue"><div class="label">Total</div><div class="value" id="mTotal">0</div></div>
          <div class="metric blue"><div class="label">Diusulkan</div><div class="value" id="mDiusulkan">0</div></div>
          <div class="metric orange"><div class="label">Diproses</div><div class="value" id="mProses">0</div></div>
          <div class="metric green"><div class="label">Selesai</div><div class="value" id="mSelesai">0</div></div>
          <div class="metric red"><div class="label">Ditolak</div><div class="value" id="mDitolak">0</div></div>
        </div>

        <div class="card" style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
          <div>
            <h3 style="margin:0 0 4px;">Daftar Usulan Pemutusan JF</h3>
            <div style="color:var(--muted); font-size:13px;">Total (sesuai filter): <span id="totalFiltered">0</span> data</div>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <label style="margin:0;">Per halaman</label>
            <select id="perPage" style="width:auto;">
              <option value="10">10</option>
              <option value="20">20</option>
              <option value="50">50</option>
            </select>
          </div>
        </div>

        <div class="card">
          <div class="filters">
            <div>
              <label>Cari Nama / NIP</label>
              <input id="search" placeholder="Ketik nama atau NIP">
            </div>
            <div>
              <label>UKPD</label>
              <select id="ukpdFilter"><option value="">Semua</option></select>
            </div>
            <div>
              <label>Status</label>
              <select id="statusFilter">
                <option value="">Semua</option>
                <option value="DIUSULKAN">Diusulkan</option>
                <option value="DIPROSES">Diproses</option>
                <option value="SELESAI">Selesai</option>
                <option value="DITOLAK">Ditolak</option>
              </select>
            </div>
            <div style="display:flex; gap:8px; align-items:flex-end;">
              <button id="applyFilter" class="primary" style="width:auto;">Terapkan</button>
              <button id="resetFilter" class="ghost" style="width:auto;">Reset</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>#</th><th>Status</th><th>Aksi</th><th>Nama / NIP / Pangkat</th><th>Jabatan</th><th>Nama UKPD</th><th>Nomor Surat</th><th>Tanggal Surat</th><th>Berkas</th>
                </tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
          <div class="pagination">
            <button class="ghost" id="prevPage">Sebelumnya</button>
            <div>Halaman <span id="pageNow">1</span> / <span id="pageTotal">1</span></div>
            <button class="ghost" id="nextPage">Berikutnya</button>
          </div>
          <div class="status-bar" id="statusBar">Status: memuat...</div>
        </div>
        </div>
      </main>
      <div id="footer-container"></div>
    </div>
  </div>

  <div class="modal-backdrop" id="modalBackdrop"></div>

  <div class="modal" id="formModal" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-head">
        <h3 id="formTitle" style="margin:0;">Tambah Usulan Pemutusan JF</h3>
        <button type="button" class="close-btn" id="closeForm" aria-label="Tutup">x</button>
      </div>
      <div class="modal-body">
        <form id="pemutusanForm" class="form-grid">
          <div>
            <label>Status</label>
            <select name="status" id="f_status">
              <option value="DIUSULKAN">Diusulkan</option>
              <option value="DIPROSES">Diproses</option>
              <option value="SELESAI">Selesai</option>
              <option value="DITOLAK">Ditolak</option>
            </select>
          </div>
          <div>
            <label>Nama UKPD</label>
            <select name="nama_ukpd" id="f_ukpd"></select>
          </div>
          <div>
            <label>Nama Pegawai</label>
            <select name="nama_pegawai" id="f_nama" required>
              <option value="">Pilih pegawai</option>
            </select>
          </div>
          <div><label>NIP</label><input name="nip" id="f_nip" placeholder="NIP" required readonly></div>
          <div><label>Pangkat / Golongan</label><input name="pangkat_golongan" id="f_pangkat" placeholder="Mis. Penata Muda Tk I / III/b" readonly></div>
          <div><label>Jabatan</label><input name="jabatan" id="f_jabatan" placeholder="Jabatan saat ini" required readonly></div>
          <div><label>Jabatan Baru</label><input name="jabatan_baru" id="f_jab_baru" placeholder="Jabatan baru (opsional)"></div>
          <div><label>Angka Kredit</label><input name="angka_kredit" id="f_ak" placeholder="Angka kredit"></div>
          <div><label>Tanggal Usulan</label><input type="date" name="tanggal_usulan" id="f_tgl_usulan"></div>
          <div><label>Nomor Surat</label><input name="nomor_surat" id="f_no_surat" placeholder="Nomor surat"></div>
          <div><label>Tanggal Surat</label><input type="date" name="tanggal_surat" id="f_tgl_surat"></div>
          <div><label>Hal</label><input name="hal" id="f_hal" placeholder="Hal surat"></div>
          <div><label>Pimpinan</label><input name="pimpinan" id="f_pimpinan" placeholder="Nama pimpinan"></div>
          <div><label>Asal Surat</label><input name="asal_surat" id="f_asal_surat" placeholder="Asal surat"></div>
          <div><label>Berkas (URL/Path)</label><input name="berkas_path" id="f_berkas" placeholder="https://... atau path"></div>
          <textarea name="alasan_pemutusan" id="f_alasan" placeholder="Alasan pemutusan"></textarea>
          <textarea name="keterangan" id="f_keterangan" placeholder="Keterangan tambahan"></textarea>
          <div style="display:flex; gap:10px; justify-content:flex-end; grid-column:1/-1;">
            <button type="button" class="ghost" id="resetForm">Reset</button>
            <button type="submit" class="primary" id="submitBtn">Simpan</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal" id="viewModal" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-head">
        <h3 style="margin:0;">Detail Usulan</h3>
        <button type="button" class="close-btn" id="closeView" aria-label="Tutup">x</button>
      </div>
      <div class="modal-body">
        <div class="detail-grid" id="detailGrid"></div>
        <div style="margin-top:12px;">
          <label>Alasan Pemutusan</label>
          <div id="detailAlasan" style="white-space:pre-wrap; background:#f7fbfb; border:1px solid var(--border); border-radius:10px; padding:10px;"></div>
        </div>
        <div style="margin-top:12px;">
          <label>Keterangan</label>
          <div id="detailKeterangan" style="white-space:pre-wrap; background:#f7fbfb; border:1px solid var(--border); border-radius:10px; padding:10px;"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="validateModal" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-head">
        <h3 id="validateTitle" style="margin:0;">Validasi Usulan Pemutusan JF</h3>
        <button type="button" class="close-btn" id="closeValidate" aria-label="Tutup">x</button>
      </div>
      <div class="modal-body">
        <form id="validateForm" class="form-grid">
          <div>
            <label>Status</label>
            <select name="status" id="validateStatus">
              <option value="DIUSULKAN">Diusulkan</option>
              <option value="DIPROSES">Diproses</option>
              <option value="SELESAI">Selesai</option>
              <option value="DITOLAK">Ditolak</option>
            </select>
          </div>
          <textarea name="keterangan" id="validateNote" placeholder="Catatan hasil validasi..."></textarea>
          <div style="display:flex; gap:10px; justify-content:flex-end; grid-column:1/-1;">
            <button type="submit" class="primary">Simpan</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="../loader.js"></script>
  <script>
    const BASE = (() => {
      const parts = location.pathname.split('/').filter(Boolean);
      if (parts.length && parts[0].toUpperCase() === 'DATA_PEGAWAI') return '/' + parts[0] + '/';
      if (parts.length > 1) return '../';
      return '/';
    })();
    const API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.protocol === 'file:')
      ? 'http://127.0.0.1:5002'
      : 'https://sikepeg.seftianh23.workers.dev';
    const PROXY_KEY = 'proxy_5b8d2f7c4a9e1b6d3c7f2a8b5e9d4c6a';
    const API_HEADERS = { 'X-Proxy-Key': PROXY_KEY };
    if (window.AppLoader) window.AppLoader.wrapFetch(API_BASE);
    const favicon = document.querySelector("link[rel='icon']");
    if (favicon) favicon.href = BASE + 'foto/Dinkes.png';

    const sidebarPromise = fetch(BASE + 'sidebar.html').then(r=>r.text()).catch(()=>''), headerPromise = fetch(BASE + 'header.html').then(r=>r.text()).catch(()=>''), footerPromise = fetch(BASE + 'footer.html').then(r=>r.text()).catch(()=> '');
    Promise.all([sidebarPromise, headerPromise, footerPromise]).then(([s,h,f])=>{
      const wrap = document.getElementById('sidebar-container');
      wrap.innerHTML = s;
      const hdr = document.getElementById('header-container');
      if (hdr) hdr.innerHTML = h;
      const ftr = document.getElementById('footer-container');
      if (ftr) ftr.innerHTML = f;
      document.querySelectorAll('[data-path]').forEach(a=> a.href = BASE + a.dataset.path);
      document.querySelectorAll('[data-logo],[data-logo-header]').forEach(img=> img.src = BASE + 'foto/Dinkes.png');
      const activeLink = Array.from(document.querySelectorAll('.nav-item')).find(a=> (a.dataset.path||'').includes('pemutusan-jf'));
        if (activeLink) activeLink.classList.add('active');
        document.getElementById('logoutBtn')?.addEventListener('click', doLogout);
        const logoutNav = document.querySelector('[data-logout]');
        if (logoutNav) logoutNav.addEventListener('click', doLogout);
        initSidebarToggle();
        syncHeaderUser();
      });

    const authUser = (()=>{ try { return JSON.parse(localStorage.getItem('authUser')||'null'); } catch { return null; } })();
    if (!authUser) { window.location.href = BASE; }
    const norm = (v='') => String(v || '').toLowerCase().trim();
    const roleLower = norm(authUser?.role);
    const isSuper = roleLower.includes('super') || roleLower.includes('dinkes');
    const isWilayahAdmin = roleLower.includes('wilayah');
    const loginUkpd = authUser?.namaUkpd || authUser?.username || '';
    const loginWilayah = authUser?.wilayah || '';
    document.body.classList.toggle('role-super', isSuper);

    const statusBar = document.getElementById('statusBar');
    const tableBody = document.getElementById('tableBody');
    const perPageSel = document.getElementById('perPage');
    const pageNow = document.getElementById('pageNow');
    const pageTotal = document.getElementById('pageTotal');
    const searchInput = document.getElementById('search');
    const ukpdFilter = document.getElementById('ukpdFilter');
    const statusFilter = document.getElementById('statusFilter');
    const totalFiltered = document.getElementById('totalFiltered');
    const mTotal = document.getElementById('mTotal');
    const mDiusulkan = document.getElementById('mDiusulkan');
    const mProses = document.getElementById('mProses');
    const mSelesai = document.getElementById('mSelesai');
    const mDitolak = document.getElementById('mDitolak');

    const form = document.getElementById('pemutusanForm');
    const resetFormBtn = document.getElementById('resetForm');
    const formModal = document.getElementById('formModal');
    const viewModal = document.getElementById('viewModal');
    const validateModal = document.getElementById('validateModal');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const formTitle = document.getElementById('formTitle');
    const submitBtn = document.getElementById('submitBtn');
    const closeForm = document.getElementById('closeForm');
    const closeView = document.getElementById('closeView');
    const closeValidate = document.getElementById('closeValidate');
    const detailGrid = document.getElementById('detailGrid');
    const detailAlasan = document.getElementById('detailAlasan');
    const detailKeterangan = document.getElementById('detailKeterangan');
    const validateForm = document.getElementById('validateForm');
    const validateStatus = document.getElementById('validateStatus');
    const validateNote = document.getElementById('validateNote');
    const validateTitle = document.getElementById('validateTitle');
    const ukpdSelect = document.getElementById('f_ukpd');
    const pegawaiSelect = document.getElementById('f_nama');
    const nipInput = document.getElementById('f_nip');
    const pangkatInput = document.getElementById('f_pangkat');
    const jabatanInput = document.getElementById('f_jabatan');
    const tanggalUsulanInput = document.getElementById('f_tgl_usulan');

    const roleBadge = document.getElementById('roleBadge');
    const userNameEl = document.getElementById('userName');
    const userRoleEl = document.getElementById('userRole');

    const TEMPLATE_PATH = `${BASE}templates/Putus%20JF%20Batch%203.docx`;
    let templateCache = null;
    let rows = [];
    let filtered = [];
    let page = 1;
    let editingId = null;
    let validatingRow = null;
    const bezettingState = { byUkpd: new Map(), ukpdsAll: null, ukpdsWilayah: null };

    function syncHeaderUser(){
      if (!authUser) return;
      const roleText = (authUser.role || 'USER').toUpperCase();
      const namaText = authUser.namaUkpd || authUser.username || 'User';
      if (roleBadge) roleBadge.textContent = roleText;
      if (userNameEl) userNameEl.textContent = namaText;
      if (userRoleEl) userRoleEl.textContent = authUser.role || '';
      const headerRole = document.getElementById('rolePill');
      const headerUkpd = document.getElementById('ukpdPill');
      const headerName = document.getElementById('userName');
      const headerRoleText = document.getElementById('userRole');
      if (headerRole) headerRole.textContent = roleText;
      if (headerUkpd) headerUkpd.textContent = namaText;
      if (headerName) headerName.textContent = namaText;
      if (headerRoleText) headerRoleText.textContent = authUser.role || '';
    }

    function setStatus(msg){ if (statusBar) statusBar.textContent = 'Status: ' + msg; }
    function doLogout(){ localStorage.removeItem('authUser'); window.location.href = BASE; }

    function escapeHtml(str){
      return String(str || '').replace(/[&<>"']/g, (ch) => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[ch]));
    }


    function safeUrl(value){
      const raw = String(value || '').trim();
      if (!raw) return '';
      const lower = raw.toLowerCase();
      if (lower.startsWith('http://') || lower.startsWith('https://')) return raw;
      return '';
    }

    function formatMultiline(value){
      return escapeHtml(value || '').replace(/\n/g, '<br>');
    }

    function sanitizeFilename(value){
      return String(value || 'dokumen')
        .replace(/[\\/:*?"<>|]+/g, ' ')
        .replace(/\s+/g, ' ')
        .trim()
        .slice(0, 80) || 'dokumen';
    }

    function escapeXml(str){
      return String(str || '').replace(/[&<>"']/g, (ch) => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&apos;'
      }[ch]));
    }

    function formatDocxValue(value){
      const safe = escapeXml(value || '-');
      return safe.replace(/\r?\n/g, '</w:t><w:br/><w:t>');
    }

    function showModal(el){
      el.classList.add('show');
      modalBackdrop.classList.add('show');
      el.setAttribute('aria-hidden','false');
    }
    function hideModal(el){
      el.classList.remove('show');
      if (![formModal, viewModal, validateModal].some(m=>m.classList.contains('show'))) modalBackdrop.classList.remove('show');
      el.setAttribute('aria-hidden','true');
    }

    const STATUS_ORDER = { DIUSULKAN: 0, DIPROSES: 1, SELESAI: 2, DITOLAK: 3 };

    function badgeStatus(val){
      const v = (val||'').toUpperCase();
      if (v==='SELESAI') return '<span class="status-pill pill-success">Selesai</span>';
      if (v==='DITOLAK') return '<span class="status-pill pill-danger">Ditolak</span>';
      if (v==='DIPROSES') return '<span class="status-pill pill-warn">Diproses</span>';
      return '<span class="status-pill pill-info">Diusulkan</span>';
    }

    const CRC_TABLE = (() => {
      const table = new Uint32Array(256);
      for (let i = 0; i < 256; i++) {
        let c = i;
        for (let k = 0; k < 8; k++) {
          c = (c & 1) ? (0xedb88320 ^ (c >>> 1)) : (c >>> 1);
        }
        table[i] = c >>> 0;
      }
      return table;
    })();

    function crc32(bytes){
      let crc = 0xffffffff;
      for (let i = 0; i < bytes.length; i++) {
        crc = CRC_TABLE[(crc ^ bytes[i]) & 0xff] ^ (crc >>> 8);
      }
      return (crc ^ 0xffffffff) >>> 0;
    }

    async function loadDocxTemplate(){
      if (templateCache) return templateCache;
      const res = await fetch(TEMPLATE_PATH, { cache: 'no-store' });
      if (!res.ok) throw new Error('Template Word tidak ditemukan');
      templateCache = await res.arrayBuffer();
      return templateCache;
    }

    function findEocd(view){
      for (let i = view.byteLength - 22; i >= Math.max(0, view.byteLength - 0xFFFF - 22); i--) {
        if (view.getUint32(i, true) === 0x06054b50) return i;
      }
      return -1;
    }

    function decodeText(bytes){
      return new TextDecoder('utf-8').decode(bytes);
    }

    function encodeText(text){
      return new TextEncoder().encode(text);
    }

    function parseZip(buffer){
      const view = new DataView(buffer);
      const eocdOffset = findEocd(view);
      if (eocdOffset < 0) throw new Error('Template Word tidak valid');
      const totalEntries = view.getUint16(eocdOffset + 10, true);
      const cdOffset = view.getUint32(eocdOffset + 16, true);
      const entries = [];
      let ptr = cdOffset;
      for (let i = 0; i < totalEntries; i++) {
        if (view.getUint32(ptr, true) !== 0x02014b50) break;
        const flags = view.getUint16(ptr + 8, true);
        const method = view.getUint16(ptr + 10, true);
        const time = view.getUint16(ptr + 12, true);
        const date = view.getUint16(ptr + 14, true);
        const crc = view.getUint32(ptr + 16, true);
        const compSize = view.getUint32(ptr + 20, true);
        const uncompSize = view.getUint32(ptr + 24, true);
        const nameLen = view.getUint16(ptr + 28, true);
        const extraLen = view.getUint16(ptr + 30, true);
        const commentLen = view.getUint16(ptr + 32, true);
        const localOffset = view.getUint32(ptr + 42, true);
        const nameBytes = new Uint8Array(buffer.slice(ptr + 46, ptr + 46 + nameLen));
        const name = decodeText(nameBytes);
        const localNameLen = view.getUint16(localOffset + 26, true);
        const localExtraLen = view.getUint16(localOffset + 28, true);
        const dataOffset = localOffset + 30 + localNameLen + localExtraLen;
        const compressedData = new Uint8Array(buffer.slice(dataOffset, dataOffset + compSize));
        entries.push({
          name,
          method,
          flags,
          time,
          date,
          crc,
          compSize,
          uncompSize,
          compressedData
        });
        ptr += 46 + nameLen + extraLen + commentLen;
      }
      return entries;
    }

    function concatParts(parts){
      const total = parts.reduce((sum, part) => sum + part.length, 0);
      const out = new Uint8Array(total);
      let offset = 0;
      parts.forEach((part) => {
        out.set(part, offset);
        offset += part.length;
      });
      return out;
    }

    function buildZip(entries){
      const chunks = [];
      let offset = 0;
      entries.forEach((entry) => {
        const nameBytes = encodeText(entry.name);
        const localHeader = new Uint8Array(30);
        const view = new DataView(localHeader.buffer);
        const flags = (entry.flags | 0x0800) & ~0x0008;
        view.setUint32(0, 0x04034b50, true);
        view.setUint16(4, 20, true);
        view.setUint16(6, flags, true);
        view.setUint16(8, entry.method, true);
        view.setUint16(10, entry.time || 0, true);
        view.setUint16(12, entry.date || 0, true);
        view.setUint32(14, entry.crc >>> 0, true);
        view.setUint32(18, entry.compSize >>> 0, true);
        view.setUint32(22, entry.uncompSize >>> 0, true);
        view.setUint16(26, nameBytes.length, true);
        view.setUint16(28, 0, true);
        entry.localOffset = offset;
        chunks.push(localHeader, nameBytes, entry.compressedData);
        offset += localHeader.length + nameBytes.length + entry.compressedData.length;
      });

      const centralChunks = [];
      let centralSize = 0;
      entries.forEach((entry) => {
        const nameBytes = encodeText(entry.name);
        const centralHeader = new Uint8Array(46);
        const view = new DataView(centralHeader.buffer);
        const flags = (entry.flags | 0x0800) & ~0x0008;
        view.setUint32(0, 0x02014b50, true);
        view.setUint16(4, 20, true);
        view.setUint16(6, 20, true);
        view.setUint16(8, flags, true);
        view.setUint16(10, entry.method, true);
        view.setUint16(12, entry.time || 0, true);
        view.setUint16(14, entry.date || 0, true);
        view.setUint32(16, entry.crc >>> 0, true);
        view.setUint32(20, entry.compSize >>> 0, true);
        view.setUint32(24, entry.uncompSize >>> 0, true);
        view.setUint16(28, nameBytes.length, true);
        view.setUint16(30, 0, true);
        view.setUint16(32, 0, true);
        view.setUint16(34, 0, true);
        view.setUint16(36, 0, true);
        view.setUint32(38, 0, true);
        view.setUint32(42, entry.localOffset >>> 0, true);
        centralChunks.push(centralHeader, nameBytes);
        centralSize += centralHeader.length + nameBytes.length;
      });

      const centralOffset = offset;
      chunks.push(...centralChunks);
      offset += centralSize;

      const eocd = new Uint8Array(22);
      const eocdView = new DataView(eocd.buffer);
      eocdView.setUint32(0, 0x06054b50, true);
      eocdView.setUint16(4, 0, true);
      eocdView.setUint16(6, 0, true);
      eocdView.setUint16(8, entries.length, true);
      eocdView.setUint16(10, entries.length, true);
      eocdView.setUint32(12, centralSize >>> 0, true);
      eocdView.setUint32(16, centralOffset >>> 0, true);
      eocdView.setUint16(20, 0, true);
      chunks.push(eocd);

      return concatParts(chunks);
    }

    async function streamTransform(data, streamCtor, formats){
      for (const format of formats) {
        try {
          const stream = new streamCtor(format);
          const blobStream = new Blob([data]).stream().pipeThrough(stream);
          const arrayBuffer = await new Response(blobStream).arrayBuffer();
          return new Uint8Array(arrayBuffer);
        } catch (_) { /* try next */ }
      }
      throw new Error('Browser tidak mendukung dekompresi template DOCX');
    }

    async function inflateData(data){
      if (typeof DecompressionStream === 'undefined') throw new Error('Browser tidak mendukung dekompresi template DOCX');
      return streamTransform(data, DecompressionStream, ['deflate-raw', 'deflate']);
    }

    function buildDocxMap(row){
      return {
        Nomor_Surat: row.nomor_surat || '-',
        Tanggal_Surat: formatDate(row.tanggal_surat),
        Hal: row.hal || '-',
        Pimpinan: row.pimpinan || '-',
        ASAL_SURAT: row.asal_surat || '-',
        Nama_: row.nama_pegawai || '-',
        NIP: row.nip || '-',
        Pangkatgolongan: getPangkat(row) || '-',
        Nama_Jabatan_fungsional: getJabatan(row) || '-',
        UKPD: getNamaUkpd(row) || '-',
        Alasan_Pemutusan: row.alasan_pemutusan || '-'
      };
    }

    function applyDocxReplacements(xml, data){
      let next = xml;
      Object.entries(data).forEach(([key, value]) => {
        const token = `\u00ab${key}\u00bb`;
        next = next.split(token).join(formatDocxValue(value));
      });
      return next;
    }

    async function fillDocxTemplate(buffer, data){
      const entries = parseZip(buffer);
      const docEntry = entries.find(e => e.name === 'word/document.xml');
      if (!docEntry) throw new Error('Template Word tidak valid');
      const xmlBytes = await inflateData(docEntry.compressedData);
      const xmlText = decodeText(xmlBytes);
      const updatedText = applyDocxReplacements(xmlText, data);
      const updatedBytes = encodeText(updatedText);
      docEntry.compressedData = updatedBytes;
      docEntry.compSize = updatedBytes.length;
      docEntry.uncompSize = updatedBytes.length;
      docEntry.crc = crc32(updatedBytes);
      docEntry.method = 0;
      docEntry.flags = 0x0800;
      return buildZip(entries);
    }

    async function exportWord(row){
      const buffer = await loadDocxTemplate();
      const filled = await fillDocxTemplate(buffer, buildDocxMap(row));
      const filenameBase = sanitizeFilename(row?.nama_pegawai || row?.id || 'pemutusan-jf');
      const blob = new Blob([filled], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Pemutusan JF - ${filenameBase}.docx`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=> URL.revokeObjectURL(url), 1000);
    }

    function todayIso(){
      return new Date().toISOString().slice(0, 10);
    }

    function resetSelect(select, placeholder){
      if (!select) return;
      select.innerHTML = '';
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = placeholder || 'Pilih';
      select.appendChild(opt);
    }

    function addSelectOption(select, value, label, dataset){
      if (!select) return;
      const opt = document.createElement('option');
      opt.value = value;
      opt.textContent = label || value;
      if (dataset) {
        Object.entries(dataset).forEach(([key, val]) => {
          if (val !== undefined && val !== null) opt.dataset[key] = String(val);
        });
      }
      select.appendChild(opt);
    }

    function setSelectOptions(select, items, placeholder){
      resetSelect(select, placeholder);
      (items || []).forEach((item) => {
        if (!item) return;
        addSelectOption(select, item, item);
      });
    }

    function setSelectValue(select, value, label, dataset){
      if (!select) return;
      if (!value) {
        select.value = '';
        return;
      }
      const exists = Array.from(select.options).some(opt => opt.value === value);
      if (!exists) addSelectOption(select, value, label || value, dataset);
      select.value = value;
    }

    async function fetchBezettingMeta(params){
      const qs = new URLSearchParams(params || {});
      if (!qs.has('limit')) qs.set('limit', '1');
      const body = await apiFetch(`${API_BASE}?action=bezetting_list&${qs.toString()}`);
      return { rows: body.rows || [], ukpds: body.ukpds || [] };
    }

    async function getUkpdListAll(){
      if (bezettingState.ukpdsAll) return bezettingState.ukpdsAll;
      const meta = await fetchBezettingMeta();
      bezettingState.ukpdsAll = meta.ukpds || [];
      return bezettingState.ukpdsAll;
    }

    async function getUkpdListWilayah(){
      if (bezettingState.ukpdsWilayah) return bezettingState.ukpdsWilayah;
      const meta = await fetchBezettingMeta({ wilayah: loginWilayah || '' });
      bezettingState.ukpdsWilayah = meta.ukpds || [];
      return bezettingState.ukpdsWilayah;
    }

    async function getBezettingByUkpd(ukpd){
      const key = `${norm(ukpd)}|${isWilayahAdmin ? norm(loginWilayah) : ''}`;
      if (!ukpd) return [];
      if (bezettingState.byUkpd.has(key)) return bezettingState.byUkpd.get(key);
      const params = new URLSearchParams({ ukpd, limit: '30000' });
      if (isWilayahAdmin && loginWilayah) params.set('wilayah', loginWilayah);
      const body = await apiFetch(`${API_BASE}?action=bezetting_list&${params.toString()}`);
      const rows = body.rows || [];
      bezettingState.byUkpd.set(key, rows);
      return rows;
    }

    function resetPegawaiFields(){
      if (nipInput) nipInput.value = '';
      if (pangkatInput) pangkatInput.value = '';
      if (jabatanInput) jabatanInput.value = '';
    }

    function applyPegawaiSelection(){
      if (!pegawaiSelect) return;
      const opt = pegawaiSelect.selectedOptions[0];
      if (!opt || !opt.value) {
        resetPegawaiFields();
        return;
      }
      const data = opt.dataset || {};
      if (nipInput) nipInput.value = data.nip || '';
      if (pangkatInput) pangkatInput.value = data.pangkat || '';
      if (jabatanInput) jabatanInput.value = data.jabatan || '';
      if (ukpdSelect && data.ukpd) setSelectValue(ukpdSelect, data.ukpd);
    }

    async function renderPegawaiOptions(ukpd, selectedName, fallback){
      if (!pegawaiSelect) return;
      resetSelect(pegawaiSelect, 'Pilih pegawai');
      resetPegawaiFields();
      if (!ukpd) {
        pegawaiSelect.disabled = true;
        return;
      }
      pegawaiSelect.disabled = false;
      const rows = await getBezettingByUkpd(ukpd);
      rows.filter(r => r.nama_pegawai).forEach((r) => {
        const pangkat = r.pangkat_golongan || r.pangkat_gol || '';
        const jabatan = r.jabatan_orb || r.nama_jabatan_pergub || r.nama_jabatan_permenpan || '';
        const label = r.nip ? `${r.nama_pegawai} - ${r.nip}` : r.nama_pegawai;
        addSelectOption(pegawaiSelect, r.nama_pegawai, label, {
          nip: r.nip || '',
          pangkat,
          jabatan,
          ukpd: r.ukpd || ''
        });
      });
      if (selectedName) {
        const fallbackData = fallback ? {
          nip: fallback.nip || '',
          pangkat: getPangkat(fallback) || '',
          jabatan: getJabatan(fallback) || '',
          ukpd: getNamaUkpd(fallback) || ukpd
        } : null;
        setSelectValue(pegawaiSelect, selectedName, selectedName, fallbackData);
      }
      if (pegawaiSelect.value) applyPegawaiSelection();
    }

    async function renderUkpdOptions(selectedUkpd){
      if (!ukpdSelect) return;
      if (!isSuper && !isWilayahAdmin) {
        setSelectOptions(ukpdSelect, loginUkpd ? [loginUkpd] : [], 'Nama UKPD');
        ukpdSelect.value = loginUkpd || '';
        ukpdSelect.disabled = true;
        return;
      }
      ukpdSelect.disabled = false;
      const ukpds = isWilayahAdmin ? await getUkpdListWilayah() : await getUkpdListAll();
      setSelectOptions(ukpdSelect, ukpds, 'Pilih UKPD');
      if (selectedUkpd) setSelectValue(ukpdSelect, selectedUkpd);
    }

    async function applyFormDefaults(row){
      if (tanggalUsulanInput && !tanggalUsulanInput.value) tanggalUsulanInput.value = todayIso();
      const defaultUkpd = row?.nama_ukpd || (!isSuper && !isWilayahAdmin ? loginUkpd : '');
      await renderUkpdOptions(defaultUkpd);
      const activeUkpd = ukpdSelect?.value || defaultUkpd;
      if (activeUkpd) {
        await renderPegawaiOptions(activeUkpd, row?.nama_pegawai || '', row);
      } else {
        resetSelect(pegawaiSelect, 'Pilih pegawai');
        if (pegawaiSelect) pegawaiSelect.disabled = true;
        resetPegawaiFields();
      }
    }

    function normalizeRow(row){
      const next = { ...(row || {}) };
      if (!next.id) next.id = next.id_usulan || '';
      if (next.id !== undefined && next.id !== null) next.id = String(next.id);
      if (!next.nama_ukpd) next.nama_ukpd = next.ukpd || '';
      if (!next.jabatan) next.jabatan = next.jabatan_lama || '';
      if (!next.pangkat_golongan) next.pangkat_golongan = next.pangkat_gol || '';
      if (!next.alasan_pemutusan) next.alasan_pemutusan = next.alasan_usulan || '';
      if (!next.berkas_path) next.berkas_path = next.link_dokumen || '';
      if (!next.tanggal_usulan) next.tanggal_usulan = next.created_at || next.updated_at || '';
      return next;
    }

    function getNamaUkpd(row){ return row?.nama_ukpd || row?.ukpd || ''; }
    function getJabatan(row){ return row?.jabatan || row?.jabatan_lama || ''; }
    function getPangkat(row){ return row?.pangkat_golongan || row?.pangkat_gol || ''; }

    function getStatusRank(val){
      const key = (val || '').toUpperCase();
      return Object.prototype.hasOwnProperty.call(STATUS_ORDER, key) ? STATUS_ORDER[key] : 99;
    }

    function getSortTime(row){
      const raw = row?.created_at || row?.tanggal_usulan || row?.updated_at || row?.tanggal_surat || '';
      const parsed = Date.parse(raw);
      return Number.isNaN(parsed) ? 0 : parsed;
    }

    function sortRows(list){
      return list.sort((a,b)=>{
        const ra = getStatusRank(a.status);
        const rb = getStatusRank(b.status);
        if (ra !== rb) return ra - rb;
        return getSortTime(b) - getSortTime(a);
      });
    }

    function applyRoleFilter(data){
      if (isSuper) return data;
      if (isWilayahAdmin && loginWilayah) return data;
      const ukpd = norm(loginUkpd);
      if (!ukpd) return data;
      return data.filter(d => norm(getNamaUkpd(d)) === ukpd);
    }

    async function apiFetch(url, options={}){
      const opts = { ...options };
      opts.headers = { ...API_HEADERS, ...(opts.headers || {}) };
      if (opts.body && !opts.headers['Content-Type']) opts.headers['Content-Type'] = 'application/json';
      const res = await fetch(url, opts);
      const text = await res.text();
      let body;
      try { body = JSON.parse(text); } catch { throw new Error(text || 'Respon bukan JSON'); }
      if (!res.ok || body.ok === false) throw new Error(body.error || 'Permintaan gagal');
      return body;
    }

    function renderMetrics(){
      const total = filtered.length;
      const count = (status) => filtered.filter(r => (r.status||'').toUpperCase() === status).length;
      mTotal.textContent = total;
      mDiusulkan.textContent = count('DIUSULKAN');
      mProses.textContent = count('DIPROSES');
      mSelesai.textContent = count('SELESAI');
      mDitolak.textContent = count('DITOLAK');
      totalFiltered.textContent = total;
    }

    function buildUkpdFilter(list){
      const opts = ['<option value="">Semua</option>', ...(list||[]).map(u=>{ const safe = escapeHtml(u); return `<option value="${safe}">${safe}</option>`; })];
      ukpdFilter.innerHTML = opts.join('');
      if (!isSuper && !isWilayahAdmin){
        ukpdFilter.value = loginUkpd;
        ukpdFilter.disabled = true;
      } else {
        ukpdFilter.disabled = false;
      }
    }

    function applyFilters(){
      const q = norm(searchInput.value);
      const uk = norm(ukpdFilter.value);
      const statusActive = statusFilter?.value || '';
      filtered = applyRoleFilter(rows).filter(r=>{
        const matchQ = !q || norm(r.nama_pegawai).includes(q) || norm(r.nip).includes(q);
        const matchUk = !uk || norm(getNamaUkpd(r)) === uk;
        const matchSt = !statusActive || norm(r.status) === norm(statusActive);
        return matchQ && matchUk && matchSt;
      });
      filtered = sortRows(filtered);
      page = 1;
      render();
    }

    function render(){
      const per = parseInt(perPageSel.value,10) || 10;
      const maxPage = Math.max(1, Math.ceil((filtered.length || 0) / per));
      if (page > maxPage) page = maxPage;
      const start = (page-1)*per;
      const slice = filtered.slice(start, start+per);
      if (!slice.length){
        tableBody.innerHTML = '<tr><td colspan="9" style="text-align:center; color:var(--muted); padding:16px;">Tidak ada data</td></tr>';
      } else {
        tableBody.innerHTML = slice.map((r,idx)=>{
          const safeId = escapeHtml(r.id || '');
          const nama = escapeHtml(r.nama_pegawai || '-');
          const nip = escapeHtml(r.nip || '-');
          const pangkat = escapeHtml(getPangkat(r) || '-');
          const jabatan = escapeHtml(getJabatan(r) || '-');
          const ukpd = escapeHtml(getNamaUkpd(r) || '-');
          const nomorSurat = escapeHtml(r.nomor_surat || '-');
          const tanggalSurat = escapeHtml(formatDate(r.tanggal_surat));
          const berkasUrl = safeUrl(r.berkas_path);
          const berkasLink = berkasUrl ? `<a href="${escapeHtml(berkasUrl)}" target="_blank" rel="noopener">Berkas</a>` : '-';
          const berkasMenu = berkasUrl ? `<a href="${escapeHtml(berkasUrl)}" target="_blank" rel="noopener">Buka Berkas</a>` : '';
          return `
          <tr>
            <td>${start + idx + 1}</td>
            <td>${badgeStatus(r.status)}</td>
            <td class="actions">
              <button class="ghost dropdown-toggle" data-id="${safeId}">Aksi v</button>
              <div class="dropdown-menu">
                <button data-action="view" data-id="${safeId}">Lihat</button>
                ${isSuper ? `<button data-action="validate" data-id="${safeId}">Validasi</button>` : ''}
                ${isSuper ? `<button data-action="print" data-id="${safeId}">Cetak Word</button>` : ''}
                <button data-action="edit" data-id="${safeId}">Ubah</button>
                <button data-action="delete" data-id="${safeId}">Hapus</button>
                ${berkasMenu}
              </div>
            </td>
            <td>
              <div style="font-weight:800;">${nama}</div>
              <div style="color:var(--muted); font-size:12px;">NIP: ${nip}</div>
              <div style="color:var(--muted); font-size:12px;">Pangkat/Gol: ${pangkat}</div>
            </td>
            <td>${jabatan}</td>
            <td>
              <div style="font-weight:700;">${ukpd}</div>
            </td>
            <td>${nomorSurat}</td>
            <td>${tanggalSurat}</td>
            <td>${berkasLink}</td>
          </tr>
          `;
        }).join('');
      }
      pageNow.textContent = page;
      pageTotal.textContent = Math.max(1, Math.ceil((filtered.length || 0) / per));
      renderMetrics();
    }

    function formatDate(raw){
      if (!raw) return '-';
      const d = new Date(raw);
      if (Number.isNaN(d.getTime())) return raw;
      return d.toLocaleDateString('id-ID', { day:'2-digit', month:'short', year:'numeric' });
    }

    async function loadData(){
      try{
        setStatus('Memuat data...');
        const params = new URLSearchParams();
        const statusActive = statusFilter?.value || '';
        if (statusActive) params.set('status', statusActive);
        if (searchInput.value) params.set('search', searchInput.value);
        if (isSuper){
          if (ukpdFilter.value) params.set('ukpd', ukpdFilter.value);
        } else if (isWilayahAdmin) {
          if (loginWilayah) params.set('wilayah', loginWilayah);
          if (ukpdFilter.value) params.set('ukpd', ukpdFilter.value);
        } else {
          params.set('ukpd', loginUkpd);
        }
        const res = await apiFetch(`${API_BASE}?action=pemutusan_jf_list&${params.toString()}`);
        rows = (res.rows || []).map(normalizeRow);
        buildUkpdFilter(res.ukpds || rows.map(r=>getNamaUkpd(r)).filter(Boolean));
        applyFilters();
        setStatus('Data dimuat: ' + (rows.length||0) + ' baris');
      }catch(err){
        rows = [];
        filtered = [];
        render();
        setStatus('Gagal ambil data: ' + err.message);
      }
    }

    async function openForm(row){
      editingId = row?.id || null;
      formTitle.textContent = editingId ? 'Ubah Usulan Pemutusan JF' : 'Tambah Usulan Pemutusan JF';
      submitBtn.textContent = editingId ? 'Update' : 'Simpan';
      form.reset();
      document.getElementById('f_status').disabled = !isSuper;
      if (row){
        Object.keys(row).forEach(k=>{ if (form.elements[k]) form.elements[k].value = row[k] || ''; });
      }
      if (!isSuper){
        form.elements['status'].value = 'DIUSULKAN';
      }
      await applyFormDefaults(row || null);
      showModal(formModal);
    }

    function fillView(row){
      const berkasUrl = safeUrl(row.berkas_path);
      const pairs = [
        ['ID', row.id],
        ['Status', row.status],
        ['Nama Pegawai', row.nama_pegawai],
        ['NIP', row.nip],
        ['Pangkat/Golongan', row.pangkat_golongan],
        ['Jabatan', row.jabatan],
        ['Jabatan Baru', row.jabatan_baru],
        ['Angka Kredit', row.angka_kredit],
        ['Nama UKPD', row.nama_ukpd],
        ['Tanggal Usulan', formatDate(row.tanggal_usulan)],
        ['Nomor Surat', row.nomor_surat],
        ['Tanggal Surat', formatDate(row.tanggal_surat)],
        ['Hal', row.hal],
        ['Pimpinan', row.pimpinan],
        ['Asal Surat', row.asal_surat],
        ['Berkas', berkasUrl ? `<a href="${escapeHtml(berkasUrl)}" target="_blank" rel="noopener">Buka Berkas</a>` : '-', true],
        ['Dibuat Oleh', row.created_by_ukpd],
        ['Dibuat Pada', formatDate(row.created_at)],
        ['Diupdate Pada', formatDate(row.updated_at)]
      ];
      detailGrid.innerHTML = pairs.map(([l,v,isHtml])=>{
        const safeLabel = escapeHtml(l);
        const safeValue = isHtml ? (v || '-') : escapeHtml(v || '-');
        return `<div class="detail-card"><div class="detail-label">${safeLabel}</div><div class="detail-value">${safeValue}</div></div>`;
      }).join('');
      detailAlasan.textContent = row.alasan_pemutusan || '-';
      detailKeterangan.textContent = row.keterangan || '-';
    }

    function openValidate(row){
      validatingRow = row;
      if (validateForm) validateForm.reset();
      if (validateStatus) validateStatus.value = (row.status || 'DIUSULKAN').toUpperCase();
      if (validateNote) validateNote.value = row.keterangan || '';
      if (validateTitle) {
        const nama = row.nama_pegawai || '-';
        validateTitle.textContent = `Validasi Usulan Pemutusan JF - ${nama}`;
      }
      showModal(validateModal);
    }

    async function saveValidate(e){
      e.preventDefault();
      if (!validatingRow) return;
      const payload = {
        action: 'pemutusan_jf_update',
        id: validatingRow.id,
        status: validateStatus?.value || validatingRow.status || 'DIUSULKAN',
        keterangan: String(validateNote?.value || '').trim(),
        updated_at: new Date().toISOString()
      };
      await apiFetch(API_BASE, { method: 'POST', body: JSON.stringify(payload) });
      hideModal(validateModal);
      validatingRow = null;
      await loadData();
      alert('Validasi tersimpan');
    }

    async function savePemutusan(e){
      e.preventDefault();
      const data = Object.fromEntries(new FormData(form).entries());
      if (!data.nama_ukpd && ukpdSelect?.value) data.nama_ukpd = ukpdSelect.value;
      if (!data.nama_pegawai || !data.nip || !data.jabatan || !data.nama_ukpd){
        alert('Nama, NIP, Jabatan, dan Nama UKPD wajib diisi');
        return;
      }
      const now = new Date();
      const nowIso = now.toISOString();
      const today = nowIso.slice(0,10);
      if (!editingId){
        data.id = `PJ-${Date.now()}`;
        data.created_by_ukpd = authUser?.namaUkpd || authUser?.username || 'user';
        data.created_at = nowIso;
      }
      data.updated_at = nowIso;
      if (!data.tanggal_usulan) data.tanggal_usulan = today;
      if (!isSuper){
        data.status = 'DIUSULKAN';
        if (!isWilayahAdmin) data.nama_ukpd = loginUkpd;
      }
      const action = editingId ? 'pemutusan_jf_update' : 'pemutusan_jf_create';
      const bodyPayload = { action, ...data };
      if (editingId) bodyPayload.id = editingId;
      submitBtn.disabled = true;
      try{
        await apiFetch(API_BASE, { method: 'POST', body: JSON.stringify(bodyPayload) });
        editingId = null;
        form.reset();
        hideModal(formModal);
        await loadData();
      }catch(err){
        alert(err.message);
      }finally{
        submitBtn.disabled = false;
      }
    }

    async function deletePemutusan(id){
      if (!confirm('Hapus usulan ini?')) return;
      try{
        await apiFetch(API_BASE, {
          method: 'POST',
          body: JSON.stringify({ action: 'pemutusan_jf_delete', id })
        });
        await loadData();
      }catch(err){
        alert(err.message);
      }
    }

    tableBody.addEventListener('click', (e)=>{
      const ddBtn = e.target.closest('.dropdown-toggle');
      if (ddBtn){
        const menu = ddBtn.nextElementSibling;
        document.querySelectorAll('.dropdown-menu').forEach(m=>{ if (m!==menu) m.style.display='none'; });
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        e.stopPropagation();
        return;
      }
      const btn = e.target.closest('button');
      if (!btn) return;
      const id = btn.dataset.id;
      const action = btn.dataset.action;
      const row = rows.find(r=>String(r.id || '') === String(id || ''));
      if (!row) return;
      if (action === 'view'){ fillView(row); showModal(viewModal); }
      if (action === 'validate' && row && isSuper){ openValidate(row); }
      if (action === 'print' && isSuper){ exportWord(row).catch(err=>alert(err.message)); }
      if (action === 'edit'){ openForm(row).catch(err=>alert(err.message)); }
      if (action === 'delete'){ deletePemutusan(id); }
    });

    document.addEventListener('click', (e)=>{ if (!e.target.closest('.actions')) document.querySelectorAll('.dropdown-menu').forEach(m=> m.style.display='none'); });

    document.getElementById('applyFilter').addEventListener('click', ()=> applyFilters());
    document.getElementById('resetFilter').addEventListener('click', ()=>{
      searchInput.value='';
      if (statusFilter) statusFilter.value = '';
      if (!isSuper && !isWilayahAdmin){ ukpdFilter.value = loginUkpd; } else { ukpdFilter.value = ''; }
      applyFilters();
    });

    searchInput.addEventListener('input', ()=>{ page=1; applyFilters(); });
    ukpdFilter.addEventListener('change', ()=>{ page=1; applyFilters(); });
    statusFilter?.addEventListener('change', ()=>{ page=1; applyFilters(); });
    perPageSel.addEventListener('change', ()=>{ page=1; render(); });
    document.getElementById('prevPage').addEventListener('click', ()=>{ if (page>1){ page--; render(); } });
    document.getElementById('nextPage').addEventListener('click', ()=>{ const per = parseInt(perPageSel.value,10)||10; const maxPage = Math.max(1, Math.ceil((filtered.length||0)/per)); if (page < maxPage){ page++; render(); } });
    document.getElementById('refreshBtn')?.addEventListener('click', ()=> loadData());
    document.getElementById('addBtn').addEventListener('click', ()=> openForm(null).catch(err=>alert(err.message)));

    form.addEventListener('submit', (e)=>{ savePemutusan(e).catch(err=>alert(err.message)); });
    resetFormBtn.addEventListener('click', ()=>{
      editingId = null;
      form.reset();
      if (!isSuper) form.elements['status'].value = 'DIUSULKAN';
      submitBtn.textContent = 'Simpan';
      formTitle.textContent = 'Tambah Usulan Pemutusan JF';
      applyFormDefaults(null).catch(err=>alert(err.message));
    });
    closeForm.addEventListener('click', ()=> hideModal(formModal));
    closeView.addEventListener('click', ()=> hideModal(viewModal));
    closeValidate?.addEventListener('click', ()=> hideModal(validateModal));
    modalBackdrop.addEventListener('click', ()=>{ hideModal(formModal); hideModal(viewModal); hideModal(validateModal); });
    document.addEventListener('keydown', (e)=>{ if (e.key==='Escape'){ hideModal(formModal); hideModal(viewModal); hideModal(validateModal); } });
    validateForm?.addEventListener('submit', (e)=>{ saveValidate(e).catch(err=>alert(err.message)); });

    if (ukpdSelect){
      ukpdSelect.addEventListener('change', ()=>{
        renderPegawaiOptions(ukpdSelect.value, '').catch(err=>alert(err.message));
      });
    }
    if (pegawaiSelect){
      pegawaiSelect.addEventListener('change', ()=>{ applyPegawaiSelection(); });
    }

    function initSidebarToggle(){
      const btn = document.getElementById('sidebarToggle');
      const backdrop = document.getElementById('sidebarBackdrop');
      const sidebarEl = document.querySelector('.sidebar');
      if (!btn || !backdrop || !sidebarEl) return;
      const close = ()=>{ sidebarEl.classList.remove('show'); backdrop.classList.remove('show'); document.body.style.overflow=''; };
      btn.addEventListener('click', ()=>{
        const willShow = !sidebarEl.classList.contains('show');
        sidebarEl.classList.toggle('show', willShow);
        backdrop.classList.toggle('show', willShow);
        document.body.style.overflow = willShow ? 'hidden' : '';
      });
      backdrop.addEventListener('click', close);
      sidebarEl.addEventListener('click', (e)=>{ if (e.target.closest('a')) close(); });
      window.addEventListener('resize', ()=>{ if (window.innerWidth >= 1100) close(); });
    }

    loadData();
  </script>
</body>
</html>










