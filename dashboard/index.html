<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Dinas Kesehatan</title>
  <link rel="icon" type="image/png" href="foto/Dinkes.png" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="../loader.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Plus Jakarta Sans','Inter','Segoe UI','sans-serif'] },
          colors: { brand:'#0EA5E9', cpns:'#06B6D4', pppk:'#22C55E', pro:'#14B8A6', pjlp:'#8B5CF6', card:'#ffffff' },
          boxShadow: { soft:'0 10px 30px -12px rgba(15,23,42,.25)' }
        }
      }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0" defer></script>
  <style>
    :root{
      --sidebar-w: 16.5rem;
      --h-status: 380px;
      --h-ukpd: 520px;
      --h-rumpun: 440px;
      --tbl-font: 0.875rem;
      --tbl-pad-y: .5rem;
      --brand: #5e8bff;
      --brand-soft: #eef3ff;
      --card-shadow: 0 10px 30px -12px rgba(24,39,75,.14);
    }
    body{
      background: radial-gradient(circle at 18% 20%, rgba(94,139,255,0.08), transparent 30%), radial-gradient(circle at 80% 0%, rgba(255,159,104,0.12), transparent 32%), #f7f9fc;
      font-family:'Plus Jakarta Sans','Inter','Segoe UI',sans-serif;
      color:#1b2b3a;
    }
    #mainWrap{ margin-left: var(--sidebar-w); transition: margin .2s ease; }
    @media (max-width: 1023px){ #mainWrap{ margin-left: 0; } }
    body.compact{
      --h-status: 300px;
      --h-ukpd: 360px;
      --h-rumpun: 320px;
      --tbl-font: 0.8125rem;
      --tbl-pad-y: .375rem;
    }
    #scrollProg{ position: fixed; inset: 0 auto auto 0; height:3px; width:0; background:#fbbf24; z-index:60; }
    .card{
      background: #fff;
      border: 1px solid rgba(226,232,240,.9);
      border-radius: 18px;
      box-shadow: var(--shadow, var(--card-shadow));
      padding: 16px;
    }
    table#ukpdTable th, table#ukpdTable td{
      font-size: var(--tbl-font);
      padding-top: var(--tbl-pad-y);
      padding-bottom: var(--tbl-pad-y);
    }
    .sidebar{
      position: fixed; inset: 0 auto 0 0; width: var(--sidebar-w);
      background: #ffffff;
      color: #475569; padding: 18px 14px; display:flex; flex-direction:column; gap:18px; box-shadow: 8px 0 30px -20px rgba(0,0,0,.08); border-right:1px solid #e2e8f0;
    }
    .sidebar .logo{ display:flex; align-items:center; gap:10px; color:#0f172a; font-weight:800; }
    .sidebar .logo img{ width:38px; height:38px; object-fit:contain; }
    .sidebar .logo-title{ font-size:14px; text-transform:uppercase; letter-spacing:.2px; }
    .sidebar .logo-sub{ font-size:12px; color:#94a3b8; }
    .sidebar .nav-item{ display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; color:#475569; text-decoration:none; transition:all .15s ease; font-weight:600; }
    .sidebar .icon-round{ width:26px; height:26px; border-radius:10px; background:#eef2ff; color:#4338ca; display:grid; place-items:center; font-size:12px; }
    .sidebar .nav-item:hover{ background:#f8fafc; }
    .sidebar .nav-item.active{ background:var(--brand-soft); color:#3b5ecc; font-weight:700; box-shadow:0 10px 22px rgba(94,139,255,0.18); }
    [data-animate]{ opacity:0; transform: translateY(12px); transition: opacity .5s ease, transform .5s ease; }
    [data-animate].in-view{ opacity:1; transform:none; }
    .danger-btn { background:#ef4444; color:#fff; border:none; border-radius:10px; padding:9px 14px; cursor:pointer; font-weight:700; }
    .mobile-toggle{
      position: fixed; top: 14px; left: 14px; z-index: 70;
      background: #5e8bff; color: #f8fafc; border: 1px solid rgba(255,255,255,0.18);
      border-radius: 14px; padding: 10px 14px; display:none; align-items:center; gap:8px; font-weight:800;
      box-shadow: 0 12px 26px rgba(94,139,255,0.35);
    }
    #sidebarBackdrop{
      position: fixed; inset:0; background: rgba(0,0,0,0.45);
      opacity:0; pointer-events:none; transition: opacity .2s ease; z-index:50;
    }
    #sidebarBackdrop.show{ opacity:1; pointer-events:auto; }
    @media (max-width: 1280px){
      :root{ --h-ukpd: 460px; --h-rumpun: 380px; }
    }
    @media (max-width: 1023px){
      :root{ --h-status: 260px; --h-ukpd: 380px; --h-rumpun: 320px; }
      .mobile-toggle{ display:inline-flex; }
      .sidebar{
        transform: translateX(-100%);
        transition: transform .2s ease;
        z-index: 60;
        width: calc(100vw - 72px);
        max-width: 280px;
      }
      .sidebar.show{ transform: translateX(0); }
    }
  </style>
</head>
<body class="text-slate-900">
  <div id="scrollProg"></div>
  <div id="sidebarBackdrop"></div>
  <button id="sidebarToggle" aria-label="Buka menu" class="mobile-toggle">
    <span style="font-size:18px;">&#9776;</span> Menu
  </button>
  <div class="flex min-h-screen">
    <div id="sidebar-container"></div>
    <div class="flex-1" id="mainWrap">
      <div id="header-container"></div>
      <div id="statusBar" class="px-4 sm:px-6 text-sm text-slate-600 mt-2">Status: memuat...</div>

      <main class="px-4 sm:px-6 pb-10 pt-2 space-y-4" id="contentRoot">
        <section class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-5 gap-4" data-animate>
          <div class="card text-white bg-gradient-to-br from-sky-600 to-brand shadow-soft" data-kpi="PNS">
            <div class="flex items-center gap-3">
              <div class="w-11 h-11 rounded-xl bg-white/20 grid place-items-center text-lg">P</div>
              <div><p class="text-xs/4 opacity-90">Jenis Pegawai</p><p class="text-sm font-semibold">PNS</p></div>
            </div>
            <div class="mt-3 text-3xl font-bold" data-count>0</div>
          </div>
          <div class="card text-white bg-gradient-to-br from-cyan-500 to-cpns shadow-soft" data-kpi="CPNS">
            <div class="flex items-center gap-3">
              <div class="w-11 h-11 rounded-xl bg-white/20 grid place-items-center text-lg">C</div>
              <div><p class="text-xs/4 opacity-90">Jenis Pegawai</p><p class="text-sm font-semibold">CPNS</p></div>
            </div>
            <div class="mt-3 text-3xl font-bold" data-count>0</div>
          </div>
          <div class="card text-white bg-gradient-to-br from-green-600 to-pppk shadow-soft" data-kpi="PPPK">
            <div class="flex items-center gap-3">
              <div class="w-11 h-11 rounded-xl bg-white/20 grid place-items-center text-lg">P3</div>
              <div><p class="text-xs/4 opacity-90">Jenis Pegawai</p><p class="text-sm font-semibold">PPPK</p></div>
            </div>
            <div class="mt-3 text-3xl font-bold" data-count>0</div>
          </div>
          <div class="card text-white bg-gradient-to-br from-teal-700 to-pro shadow-soft" data-kpi="PROFESIONAL">
            <div class="flex items-center gap-3">
              <div class="w-11 h-11 rounded-xl bg-white/20 grid place-items-center text-lg">NP</div>
              <div><p class="text-xs/4 opacity-90">Jenis Pegawai</p><p class="text-sm font-semibold">PROFESIONAL</p></div>
            </div>
            <div class="mt-3 text-3xl font-bold" data-count>0</div>
          </div>
          <div class="card text-white bg-gradient-to-br from-violet-700 to-pjlp shadow-soft" data-kpi="PJLP">
            <div class="flex items-center gap-3">
              <div class="w-11 h-11 rounded-xl bg-white/20 grid place-items-center text-lg">J</div>
              <div><p class="text-xs/4 opacity-90">Jenis Pegawai</p><p class="text-sm font-semibold">PJLP</p></div>
            </div>
            <div class="mt-3 text-3xl font-bold" data-count>0</div>
          </div>
        </section>

        <div class="flex items-center justify-end gap-2 text-sm text-slate-600" data-animate>
          <span>Tampilan chart:</span>
          <select id="chartMode" class="rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm">
            <option value="status" selected>Status Pegawai</option>
            <option value="gender">Jenis Kelamin</option>
            <option value="marital">Status Pernikahan</option>
          </select>
        </div>

        <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="card" data-animate>
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-semibold" id="statusTitle">Distribusi Pegawai per Status (Aktif)</h3>
              <button data-download="status" class="text-xs px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-100">Unduh PNG</button>
            </div>
            <div class="mt-3 flex items-center justify-center" style="height: var(--h-status);">
              <canvas id="statusChart" class="max-w-[640px] w-full h-full"></canvas>
            </div>
          </div>
          <div class="card" data-animate>
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-semibold" id="ukpdTitle">Distribusi Pegawai per UKPD (Aktif)</h3>
              <button data-download="ukpd" class="text-xs px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-100">Unduh PNG</button>
            </div>
            <div class="mt-3 flex items-center justify-center" style="height: var(--h-ukpd);">
              <canvas id="ukpdChart" class="w-full h-full"></canvas>
            </div>
          </div>
        </section>

        <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="card" data-animate>
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-semibold" id="pendidikanTitle">Distribusi Pegawai per Jenjang Pendidikan</h3>
              <button data-download="pendidikan" class="text-xs px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-100">Unduh PNG</button>
            </div>
            <div class="mt-3 flex items-center justify-center" style="height: var(--h-rumpun);">
              <canvas id="pendidikanChart" class="w-full h-full"></canvas>
            </div>
          </div>
          <div class="card" data-animate>
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-semibold" id="rumpunTitle">Rumpun A - Status Pegawai</h3>
              <button data-download="rumpun" class="text-xs px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-100">Unduh PNG</button>
            </div>
            <div class="mt-3 flex items-center justify-center" style="height: var(--h-rumpun);">
              <canvas id="rumpunChart" class="w-full h-full"></canvas>
            </div>
          </div>
        </section>

        <section class="card" data-animate>
          <div class="flex items-center justify-between gap-3 flex-wrap">
            <h3 class="text-sm font-semibold">Daftar UKPD (Aktif)</h3>
            <input id="tableFilter" type="search" placeholder="Cari UKPD..." class="rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-sm" />
          </div>
          <div class="overflow-x-auto mt-2">
            <table class="min-w-full text-sm" id="ukpdTable">
              <thead class="sticky top-0 bg-white border-b border-slate-200">
                <tr>
                  <th class="px-3 py-2 text-center w-16">NO</th>
                  <th class="px-3 py-2 text-left">Nama UKPD</th>
                  <th class="px-3 py-2 text-center">PNS</th>
                  <th class="px-3 py-2 text-center">CPNS</th>
                  <th class="px-3 py-2 text-center">PPPK</th>
                  <th class="px-3 py-2 text-center">PROFESIONAL</th>
                  <th class="px-3 py-2 text-center">PJLP</th>
                  <th class="px-3 py-2 text-center">Total</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr class="bg-sky-50 font-semibold" id="tableTotalRow">
                  <td class="px-3 py-2 text-right" colspan="2">Total Keseluruhan</td>
                  <td class="px-3 py-2 text-center">0</td>
                  <td class="px-3 py-2 text-center">0</td>
                  <td class="px-3 py-2 text-center">0</td>
                  <td class="px-3 py-2 text-center">0</td>
                  <td class="px-3 py-2 text-center">0</td>
                  <td class="px-3 py-2 text-center">0</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </section>
      </main>

      <footer class="py-3 px-4 sm:px-6 flex items-center justify-between text-xs text-slate-500 border-t border-slate-200">
        <div id="footer-container"></div>
      </footer>
    </div>
  </div>

  <script>
    const BASE = (() => {
      const parts = location.pathname.split('/').filter(Boolean);
      return parts.length && parts[0].toUpperCase() === 'DATA_PEGAWAI' ? '/' + parts[0] + '/' : '/';
    })();
    const favicon = document.querySelector("link[rel='icon']");
    if (favicon) favicon.href = BASE + 'foto/Dinkes.png';
    const API_BASE = 'https://sikepeg.seftianh23.workers.dev';
    const PROXY_KEY = 'proxy_5b8d2f7c4a9e1b6d3c7f2a8b5e9d4c6a';
    const API_HEADERS = { 'X-Proxy-Key': PROXY_KEY };
    if (window.AppLoader) window.AppLoader.wrapFetch(API_BASE);
    const statusOrder = ['PNS','CPNS','PPPK','PROFESIONAL','PJLP'];
    const statusLabels = { PNS:'PNS', CPNS:'CPNS', PPPK:'PPPK', PROFESIONAL:'PROFESIONAL', PJLP:'PJLP' };
    const statusColors = { PNS:'#0EA5E9', CPNS:'#06B6D4', PPPK:'#22C55E', PROFESIONAL:'#14B8A6', PJLP:'#8B5CF6' };
    const genderOrder = ['LAKI','PEREMPUAN'];
    const genderLabels = { LAKI:'Laki-laki', PEREMPUAN:'Perempuan' };
    const genderColors = { LAKI:'#0EA5E9', PEREMPUAN:'#F97316' };
    const maritalOrder = ['BELUM_MENIKAH','MENIKAH','CERAI_HIDUP','CERAI_MATI'];
    const maritalLabels = {
      BELUM_MENIKAH:'Belum Menikah',
      MENIKAH:'Menikah',
      CERAI_HIDUP:'Cerai Hidup',
      CERAI_MATI:'Cerai Mati'
    };
    const maritalColors = {
      BELUM_MENIKAH:'#0EA5E9',
      MENIKAH:'#22C55E',
      CERAI_HIDUP:'#F97316',
      CERAI_MATI:'#EF4444'
    };

const authUser = (()=>{ try { return JSON.parse(localStorage.getItem('authUser') || 'null'); } catch { return null; } })();
if (!authUser) { window.location.href = BASE; }
const norm = (v='') => String(v || '').toLowerCase().trim();
const roleLower = norm(authUser?.role);
const isSuper = roleLower.includes('super') || roleLower.includes('dinkes');
const isWilayahAdmin = roleLower.includes('wilayah');
const loginUkpd = authUser?.namaUkpd || authUser?.username || '';
const loginWilayah = authUser?.wilayah || '';
document.body.classList.toggle('role-super', isSuper);

    const charts = { status:null, ukpd:null, rumpun:null, pendidikan:null };

    const statusBar = document.getElementById('statusBar');
    const tableBody = document.querySelector('#ukpdTable tbody');
    const tableTotalRow = document.getElementById('tableTotalRow');
    const chartModeSelect = document.getElementById('chartMode');
    let chartMode = 'status';
    let preparedCache = null;
    const roleBadge = document.getElementById('roleBadge');
    const userNameEl = document.getElementById('userName');
    const userRoleEl = document.getElementById('userRole');
    const compactDot = document.getElementById('compactDot');

    const sidebarPromise = fetch(BASE + 'sidebar.html').then(r=>r.text()).catch(()=> '');
    const headerPromise = fetch(BASE + 'header.html').then(r=>r.text()).catch(()=> '');
    const footerPromise = fetch(BASE + 'footer.html').then(r=>r.text()).catch(()=> '');
    Promise.all([sidebarPromise, headerPromise, footerPromise]).then(([s,h,f])=>{
      const wrap = document.getElementById('sidebar-container');
      wrap.innerHTML = s;
      const hdr = document.getElementById('header-container');
      if (hdr) hdr.innerHTML = h;
      const ftr = document.getElementById('footer-container');
      if (ftr) ftr.innerHTML = f;
      setActiveNav();
      const logoutLink = wrap.querySelector('[data-logout]');
      if (logoutLink) logoutLink.addEventListener('click', doLogout);
      document.getElementById('logoutBtn')?.addEventListener('click', doLogout);
      syncHeaderUser();
      initSidebarToggle();
    });

    function syncHeaderUser(){
      if (!authUser) return;
      const headerRole = document.getElementById('rolePill');
      const headerUkpd = document.getElementById('ukpdPill');
      const headerName = document.getElementById('userName');
      const headerRoleText = document.getElementById('userRole');
      const roleText = (authUser.role || 'USER').toUpperCase();
      const namaText = authUser.namaUkpd || authUser.username || 'User';
      if (headerRole) headerRole.textContent = roleText;
      if (headerUkpd) headerUkpd.textContent = namaText;
      if (headerName) headerName.textContent = namaText;
      if (headerRoleText) headerRoleText.textContent = authUser.role || '';
    }

    if (roleBadge) roleBadge.textContent = (authUser?.role || 'USER').toUpperCase();
    if (userNameEl) userNameEl.textContent = authUser?.namaUkpd || authUser?.username || 'Pengguna';
    if (userRoleEl) userRoleEl.textContent = authUser?.role || '';

    document.getElementById('compactToggle')?.addEventListener('click', ()=>{
      const now = !document.body.classList.contains('compact');
      setCompact(now);
    });

    document.getElementById('tableFilter')?.addEventListener('input', filterTable);
    document.querySelectorAll('[data-download]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const key = btn.getAttribute('data-download');
        const map = { status:'statusChart', ukpd:'ukpdChart', rumpun:'rumpunChart', pendidikan:'pendidikanChart' };
        const id = map[key];
        if (!id) return;
        const canvas = document.getElementById(id);
        const a = document.createElement('a');
        a.href = canvas.toDataURL('image/png', 1);
        a.download = `${key}.png`;
        a.click();
      });
    });

    function setStatus(msg){ if (statusBar) statusBar.textContent = 'Status: ' + msg; }
    function doLogout(){ localStorage.removeItem('authUser'); window.location.href = BASE; }
    function setActiveNav(){
      document.querySelectorAll('.nav-item').forEach(a=>{
        document.querySelectorAll('[data-path]').forEach(a=>a.href = BASE + a.dataset.path);
        document.querySelectorAll('[data-logo],[data-logo-header]').forEach(img=> img.src = BASE + 'foto/Dinkes.png');
        if (a.getAttribute('href') === BASE + 'dashboard/') a.classList.add('active');
        else a.classList.remove('active');
      });
    }

    function normalizeStatus(raw){
      const t = (raw || '').toUpperCase().trim();
      if (t === 'PNS') return 'PNS';
      if (t === 'CPNS') return 'CPNS';
      if (t.includes('PPPK') || t.includes('P3K')) return 'PPPK';
      if (t.includes('PJLP')) return 'PJLP';
      if (['NON PNS','NON ASN','PROFESIONAL','PROFESIONAL (NON PNS)','PROFESIONAL/NON PNS','TENAGA PROFESIONAL'].includes(t)) return 'PROFESIONAL';
      return 'LAINNYA';
    }

    function normalizeGender(raw){
      const t = (raw || '').toString().toLowerCase().trim();
      if (!t) return '';
      if (['l','laki','laki-laki','laki laki','pria','cowok','cwo','male','m','lk'].includes(t) || t.includes('laki')) return 'LAKI';
      if (['p','perempuan','wanita','cewek','cwe','female','f','pr'].includes(t) || t.includes('perempuan')) return 'PEREMPUAN';
      return '';
    }

    function normalizeMarital(raw){
      const t = (raw || '').toString().toLowerCase().trim();
      if (!t) return '';
      if (t.includes('belum') || t.includes('single') || t.includes('tidak menikah')) return 'BELUM_MENIKAH';
      if (t.includes('cerai') && t.includes('mati')) return 'CERAI_MATI';
      if (t.includes('cerai') && t.includes('hidup')) return 'CERAI_HIDUP';
      if (t.includes('janda') || t.includes('duda')) return 'CERAI_MATI';
      if (t.includes('menikah') || t.includes('kawin')) return 'MENIKAH';
      return '';
    }

    function cleanLabel(v){ return (v || '').trim() || '(Tidak Tercatat)'; }

    function applyRoleFilter(data){
      if (isSuper) return data;
      if (isWilayahAdmin && loginWilayah){
        const w = norm(loginWilayah);
        return data.filter(d => {
          const wukpd = norm(d.wilayah_ukpd || '');
          const unitName = norm(d.nama_ukpd || d.unit || '');
          return wukpd ? wukpd.includes(w) : unitName.includes(w);
        });
      }
      const ukpd = norm(loginUkpd);
      if (!ukpd) return data;
      return data.filter(d => norm(d.nama_ukpd || d.unit || '') === ukpd);
    }

    async function init(){
      try{
        setStatus('Cek koneksi server...');
        const health = await fetch(API_BASE + '?action=health', { headers: API_HEADERS });
        if (!health.ok) throw new Error('Server tidak siap');
        setStatus('Server siap. Memuat data...');
        await loadData();
      }catch(err){
        setStatus('Gagal konek server: ' + err.message);
      }
    }

    async function loadData(){
      try{
        const params = new URLSearchParams({ limit:'20000', offset:'0' });
        if (!isSuper) {
          if (isWilayahAdmin) {
            if (loginWilayah) params.set('wilayah', loginWilayah);
          } else {
            const ukpd = loginUkpd.trim();
            if (ukpd) params.set('unit', ukpd);
          }
        }
        const res = await fetch(`${API_BASE}?action=list&${params.toString()}`, { headers: API_HEADERS });
        const body = await res.json();
        if (!res.ok || !body.ok) throw new Error(body.error || 'Gagal ambil data');
        const rows = applyRoleFilter(body.rows || []);
        const prepared = prepareData(rows);
        preparedCache = prepared;
        renderKpi(prepared.statusCounts);
        updateChartTitles(chartMode);
        renderCharts(prepared);
        renderTable(prepared.tableRows);
        setStatus('Data dimuat: ' + rows.length + ' baris.');
      }catch(err){
        setStatus('Gagal ambil data: ' + err.message);
      }
    }

    function prepareData(rows){
      const statusCounts = { PNS:0, CPNS:0, PPPK:0, PROFESIONAL:0, PJLP:0 };
      const genderCounts = { LAKI:0, PEREMPUAN:0 };
      const maritalCounts = { BELUM_MENIKAH:0, MENIKAH:0, CERAI_HIDUP:0, CERAI_MATI:0 };
      const emptyStatusCounts = () => ({ PNS:0, CPNS:0, PPPK:0, PROFESIONAL:0, PJLP:0 });
      const emptyGenderCounts = () => ({ LAKI:0, PEREMPUAN:0 });
      const emptyMaritalCounts = () => ({ BELUM_MENIKAH:0, MENIKAH:0, CERAI_HIDUP:0, CERAI_MATI:0 });
      const unitStatusMap = {};
      const unitGenderMap = {};
      const unitMaritalMap = {};
      const wilMap = {};
      const rumpunStatusMap = {};
      const rumpunGenderMap = {};
      const rumpunMaritalMap = {};
      const pendidikanStatusMap = {};
      const pendidikanGenderMap = {};
      const pendidikanMaritalMap = {};

      rows.forEach(r=>{
        const unit = cleanLabel(r.nama_ukpd);
        const wilayah = cleanLabel(r.wilayah_ukpd || r.wilayah || '');
        const rumpun = cleanLabel(r.nama_status_rumpun);
        const pend = cleanLabel(r.jenjang_pendidikan);

        const st = normalizeStatus(r.nama_jenis_pegawai || r.nama_status_aktif || r.nama_status_rumpun);
        if (st !== 'LAINNYA') {
          statusCounts[st] = (statusCounts[st] || 0) + 1;
          wilMap[wilayah] = wilMap[wilayah] || {};
          wilMap[wilayah][unit] = wilMap[wilayah][unit] || emptyStatusCounts();
          wilMap[wilayah][unit][st] += 1;
          unitStatusMap[unit] = unitStatusMap[unit] || emptyStatusCounts();
          unitStatusMap[unit][st] += 1;
          rumpunStatusMap[rumpun] = rumpunStatusMap[rumpun] || emptyStatusCounts();
          rumpunStatusMap[rumpun][st] += 1;
          pendidikanStatusMap[pend] = pendidikanStatusMap[pend] || emptyStatusCounts();
          pendidikanStatusMap[pend][st] += 1;
        }

        const gender = normalizeGender(r.jenis_kelamin);
        if (gender) {
          genderCounts[gender] = (genderCounts[gender] || 0) + 1;
          unitGenderMap[unit] = unitGenderMap[unit] || emptyGenderCounts();
          unitGenderMap[unit][gender] += 1;
          rumpunGenderMap[rumpun] = rumpunGenderMap[rumpun] || emptyGenderCounts();
          rumpunGenderMap[rumpun][gender] += 1;
          pendidikanGenderMap[pend] = pendidikanGenderMap[pend] || emptyGenderCounts();
          pendidikanGenderMap[pend][gender] += 1;
        }

        const marital = normalizeMarital(r.status_pernikahan);
        if (marital) {
          maritalCounts[marital] = (maritalCounts[marital] || 0) + 1;
          unitMaritalMap[unit] = unitMaritalMap[unit] || emptyMaritalCounts();
          unitMaritalMap[unit][marital] += 1;
          rumpunMaritalMap[rumpun] = rumpunMaritalMap[rumpun] || emptyMaritalCounts();
          rumpunMaritalMap[rumpun][marital] += 1;
          pendidikanMaritalMap[pend] = pendidikanMaritalMap[pend] || emptyMaritalCounts();
          pendidikanMaritalMap[pend][marital] += 1;
        }
      });

      const unitLabelsStatus = Object.keys(unitStatusMap).sort();
      const unitLabelsGender = Object.keys(unitGenderMap).sort();
      const unitLabelsMarital = Object.keys(unitMaritalMap).sort();
      const rumpunLabelsStatus = Object.keys(rumpunStatusMap).sort((a,b)=> total(rumpunStatusMap[b]) - total(rumpunStatusMap[a]));
      const rumpunLabelsGender = Object.keys(rumpunGenderMap).sort((a,b)=> total(rumpunGenderMap[b]) - total(rumpunGenderMap[a]));
      const rumpunLabelsMarital = Object.keys(rumpunMaritalMap).sort((a,b)=> total(rumpunMaritalMap[b]) - total(rumpunMaritalMap[a]));
      const pendidikanLabelsStatus = Object.keys(pendidikanStatusMap).sort((a,b)=> total(pendidikanStatusMap[b]) - total(pendidikanStatusMap[a]));
      const pendidikanLabelsGender = Object.keys(pendidikanGenderMap).sort((a,b)=> total(pendidikanGenderMap[b]) - total(pendidikanGenderMap[a]));
      const pendidikanLabelsMarital = Object.keys(pendidikanMaritalMap).sort((a,b)=> total(pendidikanMaritalMap[b]) - total(pendidikanMaritalMap[a]));

      const makeDatasets = (map, labels, order, labelMap, colorMap) => order.map(s=>({
        label: labelMap[s],
        data: labels.map(l => map[l]?.[s] || 0),
        backgroundColor: colorMap[s],
        borderRadius: 6
      }));

      const wilayahLabels = Object.keys(wilMap).sort();
      const tableRows = [];
      wilayahLabels.forEach(w=>{
        const unitEntries = Object.keys(wilMap[w] || {});
        const unitRows = unitEntries.map(u=>{
          const counts = { ...emptyStatusCounts(), ...(wilMap[w][u] || {}) };
          return { wilayah: w || 'Tidak Tercatat', unit: u || '-', ...counts, total: total(counts) };
        }).sort((a,b)=> b.total - a.total);
        const groupTotals = unitRows.reduce((acc,row)=>{
          statusOrder.forEach(k=> acc[k] = (acc[k]||0) + (row[k]||0));
          acc.total = (acc.total||0) + (row.total||0);
          return acc;
        }, { ...emptyStatusCounts(), total:0 });
        tableRows.push({ isGroup:true, wilayah: w || 'Tidak Tercatat', ...groupTotals });
        unitRows.forEach((row, idx)=> tableRows.push({ ...row, no: idx + 1 }));
      });

      return {
        statusCounts,
        genderCounts,
        maritalCounts,
        unitLabelsStatus,
        unitLabelsGender,
        unitLabelsMarital,
        unitDatasetsStatus: makeDatasets(unitStatusMap, unitLabelsStatus, statusOrder, statusLabels, statusColors),
        unitDatasetsGender: makeDatasets(unitGenderMap, unitLabelsGender, genderOrder, genderLabels, genderColors),
        unitDatasetsMarital: makeDatasets(unitMaritalMap, unitLabelsMarital, maritalOrder, maritalLabels, maritalColors),
        rumpunLabelsStatus,
        rumpunLabelsGender,
        rumpunLabelsMarital,
        rumpunDatasetsStatus: makeDatasets(rumpunStatusMap, rumpunLabelsStatus, statusOrder, statusLabels, statusColors),
        rumpunDatasetsGender: makeDatasets(rumpunGenderMap, rumpunLabelsGender, genderOrder, genderLabels, genderColors),
        rumpunDatasetsMarital: makeDatasets(rumpunMaritalMap, rumpunLabelsMarital, maritalOrder, maritalLabels, maritalColors),
        pendidikanLabelsStatus,
        pendidikanLabelsGender,
        pendidikanLabelsMarital,
        pendidikanDatasetsStatus: makeDatasets(pendidikanStatusMap, pendidikanLabelsStatus, statusOrder, statusLabels, statusColors),
        pendidikanDatasetsGender: makeDatasets(pendidikanGenderMap, pendidikanLabelsGender, genderOrder, genderLabels, genderColors),
        pendidikanDatasetsMarital: makeDatasets(pendidikanMaritalMap, pendidikanLabelsMarital, maritalOrder, maritalLabels, maritalColors),
        tableRows
      };
    }

    function total(obj){ return Object.values(obj || {}).reduce((s,n)=> s + (+n || 0), 0); }

    function renderKpi(statusCounts){
      document.querySelectorAll('[data-kpi]').forEach(card=>{
        const key = card.getAttribute('data-kpi');
        const target = statusCounts[key] || 0;
        const numEl = card.querySelector('[data-count]');
        if (!numEl) return;
        animateNumber(numEl, target);
      });
    }

    function animateNumber(el, target){
      const duration = 1000 + Math.min(2000, target * 0.2);
      const start = performance.now();
      const fmt = n => n.toLocaleString('id-ID');
      function step(now){
        const p = Math.min(1, (now - start) / duration);
        const eased = 1 - Math.pow(1 - p, 3);
        const val = Math.floor(target * eased);
        el.textContent = fmt(val);
        if (p < 1) requestAnimationFrame(step);
        else el.textContent = fmt(target);
      }
      requestAnimationFrame(step);
    }

    function updateChartTitles(mode){
      const isGender = mode === 'gender';
      const isMarital = mode === 'marital';
      const statusTitle = document.getElementById('statusTitle');
      const ukpdTitle = document.getElementById('ukpdTitle');
      const pendidikanTitle = document.getElementById('pendidikanTitle');
      const rumpunTitle = document.getElementById('rumpunTitle');
      if (statusTitle) statusTitle.textContent = isGender
        ? 'Distribusi Pegawai per Jenis Kelamin (Aktif)'
        : (isMarital ? 'Distribusi Pegawai per Status Pernikahan (Aktif)' : 'Distribusi Pegawai per Status (Aktif)');
      if (ukpdTitle) ukpdTitle.textContent = isGender
        ? 'Distribusi Pegawai per UKPD (Jenis Kelamin)'
        : (isMarital ? 'Distribusi Pegawai per UKPD (Status Pernikahan)' : 'Distribusi Pegawai per UKPD (Aktif)');
      if (pendidikanTitle) pendidikanTitle.textContent = isGender
        ? 'Distribusi Pegawai per Jenjang Pendidikan (Jenis Kelamin)'
        : (isMarital ? 'Distribusi Pegawai per Jenjang Pendidikan (Status Pernikahan)' : 'Distribusi Pegawai per Jenjang Pendidikan');
      if (rumpunTitle) rumpunTitle.textContent = isGender
        ? 'Rumpun A - Jenis Kelamin Pegawai'
        : (isMarital ? 'Rumpun A - Status Pernikahan Pegawai' : 'Rumpun A - Status Pegawai');
    }

    function renderCharts(data){
      if (typeof Chart === 'undefined') return;
      if (typeof ChartDataLabels !== 'undefined') Chart.register(ChartDataLabels);

      const mode = chartMode === 'gender' ? 'gender' : (chartMode === 'marital' ? 'marital' : 'status');
      const emptyPlugin = {
        id:'empty',
        afterDraw(chart){
          const totalVal = (chart.data.datasets || []).reduce((sum, ds)=> sum + (ds.data || []).reduce((a,b)=> a + (+b || 0), 0), 0);
          if (!totalVal) {
            const { ctx, chartArea } = chart; if (!chartArea) return;
            ctx.save();
            ctx.fillStyle = getComputedStyle(document.body).color;
            ctx.globalAlpha = .6;
            ctx.textAlign = 'center';
            ctx.font = '600 14px "Plus Jakarta Sans", system-ui';
            ctx.fillText('Tidak ada data', (chartArea.left+chartArea.right)/2, (chartArea.top+chartArea.bottom)/2);
            ctx.restore();
          }
        }
      };
      Chart.register(emptyPlugin);

      const isDark = () => document.documentElement.classList.contains('dark');
      const gridColor = () => isDark() ? '#334155' : '#e5e7eb';
      const commonAnim = { duration: 800, easing: 'easeOutQuart' };

      const statusData = mode === 'gender'
        ? {
          labels: genderOrder.map(s => genderLabels[s]),
          datasets: [{ data: genderOrder.map(s => data.genderCounts[s] || 0), backgroundColor: genderOrder.map(s => genderColors[s]) }]
        }
        : (mode === 'marital'
          ? {
            labels: maritalOrder.map(s => maritalLabels[s]),
            datasets: [{ data: maritalOrder.map(s => data.maritalCounts[s] || 0), backgroundColor: maritalOrder.map(s => maritalColors[s]) }]
          }
          : {
            labels: statusOrder.map(s => statusLabels[s]),
            datasets: [{ data: statusOrder.map(s => data.statusCounts[s] || 0), backgroundColor: statusOrder.map(s => statusColors[s]) }]
          });

      destroyChart('status');
      charts.status = new Chart(document.getElementById('statusChart'), {
        type: 'doughnut',
        data: statusData,
        options: {
          responsive:true,
          cutout:'58%',
          plugins:{
            legend:{ position:'bottom' },
            tooltip:{ callbacks:{ label:c=>{ const v = +c.raw || 0; const tot = visibleTotal(c.chart, c.datasetIndex); const p = (v / tot * 100); return `${c.label}: ${v.toLocaleString('id-ID')} (${p.toFixed(1)}%)`; } } },
            datalabels:{
              color:'#fff', font:{ weight:'bold' },
              formatter:(v,ctx)=>{ const tot = visibleTotal(ctx.chart, ctx.datasetIndex); const p = v / tot * 100; return p >= 4 ? p.toFixed(1)+'%' : ''; }
            },
            empty:{}
          },
          animation:{ animateRotate:true, duration:900, easing:'easeOutQuart' }
        }
      });

      const unitLabels = mode === 'gender'
        ? data.unitLabelsGender
        : (mode === 'marital' ? data.unitLabelsMarital : data.unitLabelsStatus);
      const pendidikanLabels = mode === 'gender'
        ? data.pendidikanLabelsGender
        : (mode === 'marital' ? data.pendidikanLabelsMarital : data.pendidikanLabelsStatus);
      const rumpunLabels = mode === 'gender'
        ? data.rumpunLabelsGender
        : (mode === 'marital' ? data.rumpunLabelsMarital : data.rumpunLabelsStatus);

      destroyChart('ukpd');
      charts.ukpd = new Chart(document.getElementById('ukpdChart'), {
        type:'bar',
        data:{ labels: unitLabels, datasets: JSON.parse(JSON.stringify(mode === 'gender' ? data.unitDatasetsGender : (mode === 'marital' ? data.unitDatasetsMarital : data.unitDatasetsStatus))) },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{ position:'top', align:'start', labels:{ usePointStyle:true } }, datalabels:{ display:false }, tooltip:{ callbacks:{ label:c=>`${c.dataset.label}: ${( +c.raw).toLocaleString('id-ID')}` } }, empty:{} },
          scales:{ x:{ stacked:true, ticks:{ autoSkip:false, maxRotation:60 }, grid:{ color:gridColor } }, y:{ stacked:true, beginAtZero:true, grid:{ color:gridColor } } },
          animation: commonAnim
        }
      });

      destroyChart('pendidikan');
      charts.pendidikan = new Chart(document.getElementById('pendidikanChart'), {
        type:'bar',
        data:{ labels: pendidikanLabels, datasets: JSON.parse(JSON.stringify(mode === 'gender' ? data.pendidikanDatasetsGender : (mode === 'marital' ? data.pendidikanDatasetsMarital : data.pendidikanDatasetsStatus))) },
        options:{
          indexAxis:'y',
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{ position:'top', align:'start', labels:{ usePointStyle:true } }, datalabels:{ display:false }, tooltip:{ callbacks:{ label:c=>`${c.dataset.label}: ${( +c.raw).toLocaleString('id-ID')}` } }, empty:{} },
          scales:{ x:{ stacked:true, beginAtZero:true, grid:{ color:gridColor } }, y:{ stacked:true, grid:{ color:gridColor } } },
          animation: commonAnim
        }
      });

      destroyChart('rumpun');
      charts.rumpun = new Chart(document.getElementById('rumpunChart'), {
        type:'bar',
        data:{ labels: rumpunLabels, datasets: JSON.parse(JSON.stringify(mode === 'gender' ? data.rumpunDatasetsGender : (mode === 'marital' ? data.rumpunDatasetsMarital : data.rumpunDatasetsStatus))) },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{ position:'top', align:'start', labels:{ usePointStyle:true } }, datalabels:{ display:false }, tooltip:{ callbacks:{ label:c=>`${c.dataset.label}: ${( +c.raw).toLocaleString('id-ID')}` } }, empty:{} },
          scales:{ x:{ stacked:true, grid:{ color:gridColor } }, y:{ stacked:true, beginAtZero:true, grid:{ color:gridColor } } },
          animation: commonAnim
        }
      });
    }

    function visibleTotal(chart, dsIndex){
      const ds = chart.data.datasets[dsIndex];
      let sum = 0;
      ds.data.forEach((v,i)=>{ if (chart.getDataVisibility(i)) sum += (+v || 0); });
      return sum || 1;
    }

    function destroyChart(key){
      if (charts[key]) { charts[key].destroy(); charts[key] = null; }
    }

    function renderTable(rows){
      tableBody.innerHTML = '';
      let totalP=0,totalC=0,totalP3=0,totalPro=0,totalJ=0,totalAll=0;
      rows.forEach((r, idx)=>{
        const tr = document.createElement('tr');
        if (r.isGroup){
          tr.className = 'bg-slate-50 font-semibold border-b border-slate-100';
          tr.innerHTML = `
            <td class="px-3 py-2 text-center text-slate-500">-</td>
            <td class="px-3 py-2">Wilayah: ${r.wilayah || '-'}</td>
            <td class="px-3 py-2 text-center">${(r.PNS||0).toLocaleString('id-ID')}</td>
            <td class="px-3 py-2 text-center">${(r.CPNS||0).toLocaleString('id-ID')}</td>
            <td class="px-3 py-2 text-center">${(r.PPPK||0).toLocaleString('id-ID')}</td>
            <td class="px-3 py-2 text-center">${(r.PROFESIONAL||0).toLocaleString('id-ID')}</td>
            <td class="px-3 py-2 text-center">${(r.PJLP||0).toLocaleString('id-ID')}</td>
            <td class="px-3 py-2 text-center font-semibold">${(r.total||0).toLocaleString('id-ID')}</td>
          `;
        } else {
          totalP += r.PNS || 0; totalC += r.CPNS || 0; totalP3 += r.PPPK || 0; totalPro += r.PROFESIONAL || 0; totalJ += r.PJLP || 0; totalAll += r.total || 0;
          tr.className = 'border-b border-slate-100';
          tr.dataset.unit = (r.unit || '').toLowerCase();
          tr.innerHTML = `
            <td class="px-3 py-2 text-center">${r.no || idx + 1}</td>
            <td class="px-3 py-2">${r.unit || '-'}</td>
            <td class="px-3 py-2 text-center">${(r.PNS||0).toLocaleString('id-ID')}</td>
            <td class="px-3 py-2 text-center">${(r.CPNS||0).toLocaleString('id-ID')}</td>
            <td class="px-3 py-2 text-center">${(r.PPPK||0).toLocaleString('id-ID')}</td>
            <td class="px-3 py-2 text-center">${(r.PROFESIONAL||0).toLocaleString('id-ID')}</td>
            <td class="px-3 py-2 text-center">${(r.PJLP||0).toLocaleString('id-ID')}</td>
            <td class="px-3 py-2 text-center font-semibold">${(r.total||0).toLocaleString('id-ID')}</td>
          `;
        }
        tableBody.appendChild(tr);
      });
      const cells = tableTotalRow?.querySelectorAll('td');
      if (cells && cells.length >= 7){
        cells[1].textContent = totalP.toLocaleString('id-ID');
        cells[2].textContent = totalC.toLocaleString('id-ID');
        cells[3].textContent = totalP3.toLocaleString('id-ID');
        cells[4].textContent = totalPro.toLocaleString('id-ID');
        cells[5].textContent = totalJ.toLocaleString('id-ID');
        cells[6].textContent = totalAll.toLocaleString('id-ID');
      }
    }

    if (chartModeSelect) {
      chartModeSelect.addEventListener('change', ()=>{
        chartMode = chartModeSelect.value === 'gender'
          ? 'gender'
          : (chartModeSelect.value === 'marital' ? 'marital' : 'status');
        updateChartTitles(chartMode);
        if (preparedCache) renderCharts(preparedCache);
      });
      updateChartTitles(chartMode);
    }

    function filterTable(){
      const q = (document.getElementById('tableFilter')?.value || '').toLowerCase();
      const rows = tableBody.querySelectorAll('tr');
      rows.forEach(tr=>{
        const text = (tr.dataset.unit || '') + ' ' + tr.textContent.toLowerCase();
        tr.style.display = !q || text.includes(q) ? '' : 'none';
      });
    }

    function setCompact(enabled){
      document.body.classList.toggle('compact', !!enabled);
      localStorage.setItem('compactMode', enabled ? '1' : '0');
      if (compactDot){
        compactDot.classList.toggle('bg-emerald-500', enabled);
        compactDot.classList.toggle('bg-slate-300', !enabled);
      }
      setTimeout(()=>{
        try{ charts.status?.resize(); }catch(e){}
        try{ charts.ukpd?.resize(); }catch(e){}
        try{ charts.rumpun?.resize(); }catch(e){}
        try{ charts.pendidikan?.resize(); }catch(e){}
      }, 0);
    }

    const savedCompact = localStorage.getItem('compactMode') === '1';
    setCompact(savedCompact);

    const prog = document.getElementById('scrollProg');
    function onScrollProg(){
      const t = window.scrollY || document.documentElement.scrollTop;
      const h = document.documentElement.scrollHeight - window.innerHeight;
      prog.style.width = (Math.max(0, Math.min(1, h ? t / h : 0)) * 100) + '%';
    }
    onScrollProg();
    window.addEventListener('scroll', onScrollProg, { passive:true });

    const io = new IntersectionObserver((entries)=>{
      entries.forEach(e=>{ if (e.isIntersecting){ e.target.classList.add('in-view'); io.unobserve(e.target); } });
    }, { threshold:.12, rootMargin:'0px 0px -40px 0px' });
    document.querySelectorAll('[data-animate]').forEach(el=>io.observe(el));

    function initSidebarToggle(){
      const btn = document.getElementById('sidebarToggle');
      const backdrop = document.getElementById('sidebarBackdrop');
      const sidebar = document.querySelector('.sidebar');
      if (!btn || !sidebar || !backdrop) return;
      const close = ()=>{ sidebar.classList.remove('show'); backdrop.classList.remove('show'); document.body.style.overflow=''; };
      btn.addEventListener('click', ()=>{
        const willShow = !sidebar.classList.contains('show');
        sidebar.classList.toggle('show', willShow);
        backdrop.classList.toggle('show', willShow);
        document.body.style.overflow = willShow ? 'hidden' : '';
      });
      backdrop.addEventListener('click', close);
      sidebar.addEventListener('click', (e)=>{ if (e.target.closest('a')) close(); });
      window.addEventListener('resize', ()=>{ if (window.innerWidth >= 1024) close(); });
    }

    init();
  </script>
</body>
</html>





