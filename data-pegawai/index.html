<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Data Pegawai</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="foto/Dinkes.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --border: #e6ecf4;
      --muted: #6b7280;
      --accent: #5e8bff;
      --accent-2: #ff9f68;
      --success: #16a34a;
      --danger: #dc2626;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Plus Jakarta Sans','Inter','Segoe UI',Arial,sans-serif; background: radial-gradient(circle at 18% 20%, rgba(94,139,255,0.08), transparent 30%), radial-gradient(circle at 80% 0%, rgba(255,159,104,0.12), transparent 32%), #f7f9fc; color: #1b2b3a; }
    .layout { min-height: 100vh; }
    .content { margin-left: 260px; min-height: 100vh; display:flex; flex-direction:column; transition: margin .2s ease; }
    .page { width: 100%; max-width: none; margin: 0; display:flex; flex-direction:column; gap:12px; padding:0; }
    .sidebar { position: fixed; inset:0 auto 0 0; width: 260px; background: #ffffff; color: #475569; padding: 18px 14px; display:flex; flex-direction:column; gap:18px; min-height: 100vh; box-shadow: 8px 0 30px -20px rgba(0,0,0,0.08); border-right:1px solid #e2e8f0; }
    .logo { display:flex; align-items:center; gap:10px; color:#0f172a; font-weight:800; }
    .logo img { width:38px; height:38px; object-fit:contain; }
    .logo-title { font-size:13px; text-transform:uppercase; letter-spacing:.2px; }
    .logo-sub { font-size:12px; color:#94a3b8; }
    nav { display:flex; flex-direction:column; gap:6px; }
    .nav-title { margin:18px 10px 6px; font-size:11px; letter-spacing:0.5px; text-transform:uppercase; color:#94a3b8; }
    .nav-item { display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; color:#475569; text-decoration:none; transition:all .15s ease; font-weight:600; }
    .nav-item:hover { background:#f8fafc; }
    .nav-item.active { background:#eef3ff; color:#3b5ecc; font-weight:700; box-shadow:0 10px 22px rgba(94,139,255,0.18); }
    .icon-round { width:26px; height:26px; border-radius:10px; background:#eef2ff; color:#4338ca; display:grid; place-items:center; font-size:12px; }
    .icon-round { width:26px; height:26px; border-radius:10px; background:#eef2ff; color:#4338ca; display:grid; place-items:center; font-size:12px; }
    .topbar { background:linear-gradient(120deg, rgba(94,139,255,0.14), rgba(255,159,104,0.16)), #ffffff; border-bottom:1px solid var(--border); padding:12px 18px; display:flex; align-items:center; justify-content:space-between; gap:12px; box-shadow: 0 10px 28px rgba(24,39,75,0.12); backdrop-filter:blur(6px); }
    .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .badge { display:inline-flex; align-items:center; gap:8px; background:#eef3ff; color:#3b5ecc; padding:8px 12px; border-radius:999px; font-weight:700; font-size:13px; box-shadow:0 10px 20px rgba(94,139,255,0.2); }
    .ghost-btn { padding:8px 10px; border:1px solid var(--border); border-radius:10px; background:#f8fafc; cursor:pointer; }
    .danger-btn { background:linear-gradient(135deg, #ff6b6b, #ff9f68); color:#fff; border:none; border-radius:12px; padding:9px 14px; cursor:pointer; font-weight:800; box-shadow: 0 12px 26px rgba(255,107,107,0.28); }
    main { padding:18px; }
    .panel { background: var(--card); border: 1px solid var(--border); border-radius: 18px; padding: 18px; box-shadow: 0 12px 26px rgba(24,39,75,0.08); }
    .grid { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
    .stat { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; box-shadow: 0 8px 16px rgba(0,0,0,0.05); }
    .stat .title { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: .5px; margin-bottom: 6px; }
    .stat .value { font-size: 28px; font-weight: 800; }
    .filters { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); gap:14px; align-items:end; }
    .filters input, .filters select { width: 100%; }
    label { font-size: 12px; font-weight: 700; color: #485668; text-transform: uppercase; letter-spacing: .5px; }
    input, select, button, textarea { padding: 11px 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 14px; font-family: 'Plus Jakarta Sans','Inter','Segoe UI',Arial,sans-serif; }
    textarea { width: 100%; min-height: 90px; resize: vertical; }
    button { cursor: pointer; background: linear-gradient(120deg, var(--accent) 0%, #7cb3ff 45%, var(--accent-2) 100%); color: #0b1f2c; border: none; font-weight: 800; box-shadow: 0 15px 35px rgba(94,139,255,0.32); }
    button.secondary { background: #f8fafc; color: #1b2b3a; border:1px solid var(--border); box-shadow:0 8px 18px rgba(24,39,75,0.06); }
    button.danger { background: var(--danger); }
    button:disabled { background: #9ec2ff; cursor: not-allowed; }
    .chips { display:flex; flex-wrap:wrap; gap:8px; }
    .chip { display:inline-flex; align-items:center; gap:6px; padding:8px 10px; border-radius:999px; border:1px solid var(--border); background:#f8fafc; cursor:pointer; }
    .chip.active { border-color: var(--accent); color: var(--accent); font-weight:700; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 8px; border-bottom: 1px solid var(--border); text-align: left; font-size: 13px; }
    th { background: #eef2f8; font-size: 12px; text-transform: uppercase; letter-spacing: .5px; }
    tr:hover { background: #f7f9fd; }
    #status { margin-top: 10px; color: #0b5ed7; font-weight: 600; }
    .hidden { display: none; }
    .actions { display:inline-flex; gap:6px; align-items:center; padding:4px; border-radius:999px; background:#f8fafc; border:1px solid #e2e8f0; }
    .icon-btn {
      width:36px; height:36px; display:grid; place-items:center; border:1px solid transparent; border-radius:999px;
      cursor:pointer; background:#ffffff; color:#475569; box-shadow: 0 8px 16px rgba(15,23,42,0.08);
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .icon-btn svg { width:16px; height:16px; display:block; fill:currentColor; }
    .icon-btn:hover { transform: translateY(-1px); box-shadow: 0 10px 20px rgba(15,23,42,0.14); }
    .icon-btn:focus-visible { outline: 2px solid rgba(94,139,255,0.45); outline-offset: 2px; }
    .icon-view { background:linear-gradient(135deg, #e0f2fe, #eff6ff); color:#0f5098; border-color:#bfdbfe; }
    .icon-edit { background:linear-gradient(135deg, #fff7ed, #ffedd5); color:#c2410c; border-color:#fed7aa; }
    .icon-delete { background:linear-gradient(135deg, #fee2e2, #ffe4e6); color:#b91c1c; border-color:#fecdd3; }
    .warn-badge{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:8px; background:#fef3c7; color:#92400e; font-size:12px; font-weight:700; margin-left:6px; cursor:pointer; border:1px solid #fcd34d; }
    .toast-container{ position:fixed; top:18px; right:18px; display:flex; flex-direction:column; gap:10px; z-index:9999; }
    .toast{
      min-width:240px; max-width:360px; background:#ffffff; border:1px solid var(--border); border-left:4px solid var(--accent);
      padding:10px 12px; border-radius:12px; box-shadow:0 12px 24px rgba(15,23,42,0.18);
      display:flex; flex-direction:column; gap:4px; font-size:13px; color:#0f172a; transition: opacity .2s ease, transform .2s ease;
    }
    .toast.success{ border-left-color: var(--success); }
    .toast.error{ border-left-color: var(--danger); }
    .toast.hide{ opacity:0; transform: translateY(-6px); }
    .toast-title{ font-weight:800; }
    .toast-msg{ color:#475569; }
    .table-tools { display:flex; gap:14px; align-items:center; justify-content:space-between; margin:8px 0; flex-wrap:wrap; }
    .table-actions { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; z-index: 20; }
    .modal-backdrop.show { display: flex; }
    .modal { background: #fff; border-radius: 16px; padding: 18px; width: min(1100px, 96vw); box-shadow: 0 22px 48px rgba(24,39,75,0.22); }
    .modal h3 { margin: 0 0 12px; }
    .modal form { display:flex; flex-direction:column; gap:14px; max-height: 72vh; overflow:auto; padding-right:4px; }
    .form-section{ background:#f8fafc; border:1px solid var(--border); border-radius:14px; padding:12px; display:flex; flex-direction:column; gap:12px; }
    .section-title{ font-size:12px; font-weight:800; color:#0f172a; text-transform:uppercase; letter-spacing:.6px; display:flex; align-items:center; gap:8px; }
    .section-grid{ display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap:12px; align-items:start; }
    .section-grid > div{ display:flex; flex-direction:column; gap:6px; }
    .section-grid input, .section-grid select, .section-grid textarea{ width:100%; }
    .section-grid .full { grid-column: 1 / -1; }
    .form-section label{ min-height:28px; }
    .modal-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:4px; }
    @media (max-width: 1200px){
      .section-grid{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    @media (max-width: 960px){
      .section-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 640px){
      .section-grid{ grid-template-columns: 1fr; }
      .form-section label{ min-height: auto; }
    }
    .pill { display:inline-flex; gap:6px; align-items:center; padding:6px 10px; background:#e0f2fe; color:#0369a1; border-radius:999px; font-weight:700; }
    .mobile-toggle{
      position: fixed; top: 14px; left: 14px; z-index: 70;
      background: #5e8bff; color: #f8fafc; border: 1px solid rgba(255,255,255,0.18);
      border-radius: 14px; padding: 10px 14px; display:none; align-items:center; gap:8px; font-weight:800;
      box-shadow: 0 12px 26px rgba(94,139,255,0.35);
    }
    #sidebarBackdrop{
      position: fixed; inset:0; background: rgba(0,0,0,0.45);
      opacity:0; pointer-events:none; transition: opacity .2s ease; z-index:50;
    }
    #sidebarBackdrop.show{ opacity:1; pointer-events:auto; }
    @media (max-width: 1100px){
      .content { margin-left: 0; }
      .sidebar{
        position: fixed; inset: 0 auto 0 0; width: calc(100vw - 72px); max-width: 280px;
        transform: translateX(-100%); transition: transform .2s ease; z-index: 60; min-height: 100vh;
        box-shadow: 8px 0 30px -20px rgba(0,0,0,0.5);
      }
      .sidebar.show{ transform: translateX(0); }
      .mobile-toggle{ display:inline-flex; }
      main { padding: 14px; margin-top: 20px; padding-top:62px; }
      .table-tools { flex-direction: column; align-items: flex-start; }
    }
    @media (max-width: 640px){
      .filters { grid-template-columns: 1fr; }
      .table-tools { align-items: stretch; }
      .table-tools > div:last-child { width: 100%; gap:6px; flex-wrap: wrap; }
      input, select, button { font-size: 13px; }
      th, td { font-size: 12px; }
    }
  </style>
</head>
<body>
  <div id="sidebarBackdrop"></div>
  <button id="sidebarToggle" aria-label="Buka menu" class="mobile-toggle"><span style="font-size:18px;">&#9776;</span> Menu</button>
  <div class="layout">
    <div id="sidebar-container"></div>
    <div class="content">
      <div id="header-container"></div>
      <main>
        <div class="page">
          <div class="panel" style="background:linear-gradient(135deg, rgba(94,139,255,0.2), rgba(255,159,104,0.18)), #0f1f3a; color:#e8eef9; border:none; box-shadow:0 14px 32px rgba(24,39,75,0.2);">
            <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:center;">
              <div>
                <div class="badge" id="roleBadge">-</div>
                <h2 style="margin:6px 0 4px; color:#fff;">Data Pegawai Dinas Kesehatan</h2>
                <div style="color:#d6e1f5;">Kelola dan tinjau data pegawai sesuai hak akses login.</div>
              </div>
            </div>
          </div>
          <div class="panel">
            <h3 style="margin:0 0 12px;">Data Pegawai Dinas Kesehatan Provinsi DKI Jakarta</h3>
            <div class="grid" id="stats"></div>
          </div>

          <div class="panel">
            <div class="filters">
              <div class="full">
                <label>Kata Kunci (NIP/NIK/Nama)</label>
                <input id="search" placeholder="Cari NIP/NIK/Nama" />
              </div>
              <div>
                <label>Nama UKPD</label>
                <select id="unitFilter"><option value="">Pilih UKPD</option></select>
              </div>
              <div>
                <label>Jabatan (ORB)</label>
                <select id="jabatanFilter"><option value="">Pilih Jabatan</option></select>
              </div>
              <div style="display:flex; gap:8px;">
                <button id="applyFilter">Terapkan</button>
                <button id="resetFilter" class="secondary">Reset</button>
              </div>
            </div>
            <div style="margin-top:10px;" class="chips" id="chipStatus">
              <!-- chips injected -->
            </div>
            <div id="status">Status: menunggu data...</div>
          </div>

          <div class="panel">
            <div class="table-tools">
              <div style="display:flex; gap:8px; align-items:center;">
                <label for="pageSize">Tampilkan</label>
                <select id="pageSize">
                  <option value="10">10</option>
                  <option value="25">25</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                </select>
                <span>data</span>
              </div>
              <div class="table-actions">
                <input id="quickSearch" placeholder="Cari cepat..." />
                <button class="secondary">Export CSV</button>
                <button class="secondary">Export Semua (xls)</button>
                <button class="secondary">Export Filter (xls)</button>
                <button class="success" id="addBtn">+ Tambah Pegawai</button>
              </div>
            </div>
            <div style="overflow-x:auto;">
              <table>
                <thead>
                  <tr>
                    <th>No</th><th>NIP</th><th>NIK</th><th>Nama</th><th>Jabatan ORB</th><th>Rumpun</th><th>Status Pegawai</th><th>UKPD</th><th>Kondisi</th><th>Aksi</th>
                  </tr>
                </thead>
                <tbody id="tableBody"></tbody>
              </table>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;flex-wrap:wrap;gap:8px;">
              <div id="pagerInfo" style="font-size:12px;color:var(--muted);">Halaman 1</div>
              <div style="display:flex;gap:6px;align-items:center;">
                <button id="prevPage" class="secondary" type="button">Sebelumnya</button>
                <button id="nextPage" class="secondary" type="button">Berikutnya</button>
              </div>
            </div>
          </div>
        </div>
      </main>
      <div id="footer-container"></div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <h3 id="modalTitle">Tambah Pegawai</h3>
      <form id="pegawaiForm" autocomplete="off">
        <div class="form-section">
          <div class="section-title">Identitas</div>
          <div class="section-grid">
            <div><label>Nama Pegawai</label><input name="nama_pegawai" required /></div>
            <div><label>NIP</label><input name="nip" required /></div>
            <div><label>NIK</label><input name="nik" required /></div>
            <div><label>Jenis Kelamin</label><select name="jenis_kelamin" id="jenis_kelamin" required></select></div>
            <div><label>Tempat Lahir</label><input name="tempat_lahir" required /></div>
            <div><label>Tanggal Lahir</label><input type="date" name="tanggal_lahir" required /></div>
            <div><label>Agama</label><select name="agama" id="agama" required></select></div>
            <div><label>Golongan Darah</label><select name="golongan_darah" id="golongan_darah" required></select></div>
            <div><label>Status Pernikahan (Opsional)</label><select name="status_pernikahan" id="status_pernikahan"></select></div>
          </div>
        </div>

        <div class="form-section">
          <div class="section-title">Kepegawaian</div>
          <div class="section-grid">
            <div><label>Status Aktif</label><select name="nama_status_aktif" id="nama_status_aktif" required></select></div>
            <div><label>Status Rumpun</label><select name="nama_status_rumpun" id="nama_status_rumpun" required></select></div>
            <div><label>Jenis Pegawai (Opsional)</label><select name="nama_jenis_pegawai" id="nama_jenis_pegawai"></select></div>
            <div><label>Jenis Kontrak</label><select name="jenis_kontrak" id="jenis_kontrak" required></select></div>
            <div><label>Jabatan ORB</label><input name="nama_jabatan_orb" required /></div>
            <div><label>Jabatan PRB</label><input name="nama_jabatan_prb" required /></div>
            <div><label>Nama UKPD</label><input name="nama_ukpd" id="nama_ukpd" required /></div>
            <div><label>Wilayah UKPD</label><input name="wilayah_ukpd" id="wilayah_ukpd" placeholder="Wilayah UKPD" /></div>
            <div><label>TMT Kerja UKPD</label><input type="date" name="tmt_kerja_ukpd" required /></div>
          </div>
        </div>

        <div class="form-section">
          <div class="section-title">Pendidikan & Gelar</div>
          <div class="section-grid">
            <div><label>Jenjang Pendidikan</label><select name="jenjang_pendidikan" id="jenjang_pendidikan" required></select></div>
            <div><label>Jurusan Pendidikan</label><input name="jurusan_pendidikan" required /></div>
            <div><label>Gelar Depan</label><input name="gelar_depan" /></div>
            <div><label>Gelar Belakang</label><input name="gelar_belakang" /></div>
          </div>
        </div>

        <div class="form-section">
          <div class="section-title">Kontak</div>
          <div class="section-grid">
            <div><label>No Tlp</label><input name="no_tlp" required /></div>
            <div><label>Email</label><input name="email" required /></div>
            <div><label>NPWP</label><input name="npwp" required /></div>
            <div><label>No BPJS</label><input name="no_bpjs" required /></div>
          </div>
        </div>

        <div class="form-section">
          <div class="section-title">Alamat</div>
          <div class="section-grid">
            <div class="full"><label>Alamat KTP</label><textarea name="alamat_ktp" rows="2" required></textarea></div>
            <div class="full"><label>Alamat Domisili</label><textarea name="alamat_domisili" rows="3" required></textarea></div>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="secondary" id="cancelModal">Batal</button>
          <button type="submit" id="submitModal">Simpan</button>
        </div>
      </form>
    </div>
  </div>

  <div id="toast-container" class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <script src="../loader.js"></script>
  <script>
    const BASE = (() => {
      const parts = location.pathname.split('/').filter(Boolean);
      return parts.length && parts[0].toUpperCase() === 'DATA_PEGAWAI' ? '/' + parts[0] + '/' : '/';
    })();
    const favicon = document.querySelector("link[rel='icon']");
    if (favicon) favicon.href = BASE + 'foto/Dinkes.png';
    const API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.protocol === 'file:')
      ? 'http://127.0.0.1:5002'
      : 'https://sikepeg.seftianh23.workers.dev';
    const PROXY_KEY = 'proxy_5b8d2f7c4a9e1b6d3c7f2a8b5e9d4c6a';
    const API_HEADERS = { 'X-Proxy-Key': PROXY_KEY };
    if (window.AppLoader) window.AppLoader.wrapFetch(API_BASE);
    const sidebar = fetch(BASE + 'sidebar.html').then(r=>r.text()).catch(()=>''), header = fetch(BASE + 'header.html').then(r=>r.text()).catch(()=> ''), footer = fetch(BASE + 'footer.html').then(r=>r.text()).catch(()=> '');
    Promise.all([sidebar, header, footer]).then(([s,h,f])=>{
      document.getElementById('sidebar-container').innerHTML = s;
      document.getElementById('header-container').innerHTML = h;
      document.getElementById('footer-container').innerHTML = f;
      const logoutBtn = document.getElementById('logoutBtn'); if (logoutBtn) logoutBtn.addEventListener('click', doLogout);
      const logoutNav = document.querySelector('[data-logout]');
      if (logoutNav) logoutNav.addEventListener('click', doLogout);
      document.querySelectorAll('[data-path]').forEach(a=> a.href = BASE + a.dataset.path);
      document.querySelectorAll('[data-logo],[data-logo-header]').forEach(img=> img.src = BASE + 'foto/Dinkes.png');
      updateHeaderUser(); setActiveNav(); initSidebarToggle();
    });

    const authUser = (()=>{ try { return JSON.parse(localStorage.getItem('authUser')||'null'); } catch { return null; } })();
    if (!authUser) { window.location.href = BASE; }
    const norm = (v='') => String(v || '').toLowerCase().trim();
    const roleLower = norm(authUser?.role);
    const isSuper = roleLower.includes('super') || roleLower.includes('dinkes');
    const isWilayahAdmin = roleLower.includes('wilayah');
    const loginUkpd = authUser?.namaUkpd || authUser?.username || '';
    const loginWilayah = authUser?.wilayah || '';
    document.body.classList.toggle('role-super', isSuper);

    const statusEl = document.getElementById('status');
    const tableBody = document.getElementById('tableBody');
    const statsEl = document.getElementById('stats');
    const unitFilter = document.getElementById('unitFilter');
    const jabatanFilter = document.getElementById('jabatanFilter');
    const aktifFilter = document.getElementById('aktifFilter');
    const searchInput = document.getElementById('search');
    const quickSearch = document.getElementById('quickSearch');
    const refreshBtn = document.getElementById('refresh');
    const addBtn = document.getElementById('addBtn');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const pegawaiForm = document.getElementById('pegawaiForm');
    const modalTitle = document.getElementById('modalTitle');
    const submitModal = document.getElementById('submitModal');
    const cancelModal = document.getElementById('cancelModal');
    const selectStatusAktif = document.getElementById('nama_status_aktif');
    const selectStatusRumpun = document.getElementById('nama_status_rumpun');
    const selectJenisKontrak = document.getElementById('jenis_kontrak');
    const selectJenisKelamin = document.getElementById('jenis_kelamin');
    const selectAgama = document.getElementById('agama');
    const selectJenjang = document.getElementById('jenjang_pendidikan');
    const selectGoldar = document.getElementById('golongan_darah');
    const selectStatusNikah = document.getElementById('status_pernikahan');
    const selectJenisPegawai = document.getElementById('nama_jenis_pegawai');
    const inputUkpd = document.getElementById('nama_ukpd');
    const inputWilayah = document.getElementById('wilayah_ukpd');
    const pageSize = document.getElementById('pageSize');
    const chipStatus = document.getElementById('chipStatus');
    const applyFilter = document.getElementById('applyFilter');
    const resetFilter = document.getElementById('resetFilter');
    const pagerInfo = document.getElementById('pagerInfo');
    const prevPage = document.getElementById('prevPage');
    const nextPage = document.getElementById('nextPage');
    const roleBadge = document.getElementById('roleBadge');
    const userNameEl = document.getElementById('userName');
    const userRoleEl = document.getElementById('userRole');
    const rolePill = document.getElementById('rolePill');
    const ukpdPill = document.getElementById('ukpdPill');

    let rows = [];
    let initialized = false;
    let editingId = null;
    let statusTags = [];
    let currentPage = 1;
    let totalCount = 0;

    const LIST_STATUS_RUMPUN = [
      'Jabatan Administrator',
      'Jabatan Fungsional Keahlian Kesehatan',
      'Jabatan Fungsional Keterampilan Non Kesehatan',
      'Jabatan Fungsional Keterampilan Kesehatan',
      'Jabatan Pelaksana Administrasi Tingkat Ahli',
      'Jabatan Pelaksana Administrasi Tingkat Terampil',
      'Jabatan Pelaksana Operasional Tingkat Terampil',
      'Jabatan Pelaksana Pelayan Tingkat Ahli',
      'Jabatan Pelaksana Pelayan Tingkat Terampil',
      'Jabatan Pelaksana Pelayanan Tingkat Ahli',
      'Jabatan Pelaksana Pelayanan Tingkat Terampil',
      'Jabatan Pelaksana Satuan',
      'Jabatan Pelaksana Teknis Tingkat Ahli',
      'Jabatan Pelaksana Teknis Tingkat Terampil'
    ];
    const LIST_JENIS_KONTRAK = ['KONTRAK','Part Time','TETAP'];
    const LIST_AGAMA = ['Islam','Kristen','Katolik','Hindu','Buddha','Konghucu','Lainnya'];
    const LIST_STATUS_AKTIF = ['AKTIF','Diberhentikan Dengan Hormat','Resign Atas Permintaan Sendiri','Tidak cakap jasmani/rohani'];
    const LIST_JENIS_KELAMIN = ['Laki-laki','Perempuan'];
    const LIST_GOLDAR = ['A-','A+','AB+','AB-','B-','B+','O-','O+'];
    const LIST_JENJANG = ['SD','SMP','SMA/SEDERAJAT','D-I','D-II','D-III','D-IV','S-1','PROFESI','S-2','S-3','Spesialis'];
    const LIST_STATUS_NIKAH = ['Belum Menikah','Cerai Hidup','Cerai Mati','Menikah'];
    const LIST_JENIS_PEGAWAI = ['PNS','PPPK','NON ASN','PJLP'];

    function setStatus(msg){ statusEl.textContent = 'Status: ' + msg; }
    function escapeHtml(str){
      return String(str || '').replace(/[&<>"']/g, (ch) => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[ch]));
    }
    function showToast(message, type = 'success'){
      const container = document.getElementById('toast-container');
      if (!container) return;
      const toast = document.createElement('div');
      const title = type === 'error' ? 'Gagal' : 'Berhasil';
      toast.className = `toast ${type}`;
      toast.innerHTML = `<div class="toast-title">${escapeHtml(title)}</div><div class="toast-msg">${escapeHtml(message)}</div>`;
      container.appendChild(toast);
      setTimeout(() => {
        toast.classList.add('hide');
        setTimeout(() => toast.remove(), 250);
      }, 2600);
    }
    function toggleDataSection(show){ /* intentionally keep always visible */ }
    function updateHeaderUser(){
      if (!authUser) return;
      const badge = document.querySelector('.badge');
      const uname = document.querySelector('.user-name');
      const urole = document.querySelector('.user-role');
      const roleText = (authUser.role || '').toUpperCase() || 'USER';
      const nameText = authUser.namaUkpd || authUser.username || 'User';
      if (badge) badge.textContent = roleText;
      if (uname) uname.textContent = nameText;
      if (urole) urole.textContent = authUser.role || '';
      if (roleBadge) roleBadge.textContent = roleText;
      if (userNameEl) userNameEl.textContent = nameText;
      if (userRoleEl) userRoleEl.textContent = authUser.role || '';
      if (rolePill) rolePill.textContent = roleText;
      if (ukpdPill) ukpdPill.textContent = nameText;
    }
    function setActiveNav(){
      document.querySelectorAll('.nav-item').forEach(a=>{
        if (a.getAttribute('href') === BASE + 'data-pegawai/') a.classList.add('active');
        else a.classList.remove('active');
      });
    }

    function init(){
      initialized = true;
      initSelectOptions();
      setUkpdField();
      loadData();
    }

    function initSelectOptions(){
      const setOpts = (el, list, placeholder = 'Pilih')=>{ if (!el) return; el.innerHTML = `<option value=\"\">${escapeHtml(placeholder)}</option>` + list.map(v=>{ const safe = escapeHtml(v); return `<option value=\"${safe}\">${safe}</option>`; }).join(''); };
      setOpts(selectStatusRumpun, LIST_STATUS_RUMPUN);
      setOpts(selectJenisKontrak, LIST_JENIS_KONTRAK);
      setOpts(selectAgama, LIST_AGAMA);
      setOpts(selectStatusAktif, LIST_STATUS_AKTIF);
      setOpts(selectJenisKelamin, LIST_JENIS_KELAMIN);
      setOpts(selectGoldar, LIST_GOLDAR);
      setOpts(selectJenjang, LIST_JENJANG);
      setOpts(selectStatusNikah, LIST_STATUS_NIKAH);
      setOpts(selectJenisPegawai, LIST_JENIS_PEGAWAI, 'Opsional');
    }

    function setUkpdField(fillDefault=true){
      if (!inputUkpd || !inputWilayah) return;
      if (isSuper) {
        if (fillDefault) {
          inputUkpd.value = '';
          inputWilayah.value = '';
        }
        inputUkpd.readOnly = false;
        inputWilayah.readOnly = false;
      } else if (isWilayahAdmin) {
        if (fillDefault) {
          inputUkpd.value = '';
          inputWilayah.value = loginWilayah || '';
        }
        inputUkpd.readOnly = false;
        inputWilayah.readOnly = false;
        inputUkpd.placeholder = loginWilayah ? `UKPD dalam ${loginWilayah}` : 'Nama UKPD';
      } else {
        if (fillDefault) {
          inputUkpd.value = loginUkpd;
          inputWilayah.value = loginWilayah;
        }
        inputUkpd.readOnly = true;
        inputWilayah.readOnly = true;
      }
    }

    function applyRoleFilter(data){
      if (isSuper) return data;
      if (isWilayahAdmin && loginWilayah){
        const w = norm(loginWilayah);
        return data.filter(d => {
          const wukpd = norm(d.wilayah_ukpd || '');
          const unitName = norm(d.nama_ukpd || d.unit || '');
          return wukpd ? wukpd.includes(w) : unitName.includes(w);
        });
      }
      const ukpd = norm(loginUkpd);
      if (!ukpd) return data;
      return data.filter(d => {
        const val = norm(d.nama_ukpd || d.unit || '');
        return val === ukpd;
      });
    }

    async function loadData(){
      if (!initialized) return;
      setStatus('Memuat data pegawai...');
      try {
        const size = parseInt(pageSize.value,10) || 25;
        const params = new URLSearchParams({
          limit: String(size),
          offset: String((currentPage - 1) * size)
        });
        let unitVal = unitFilter.value || '';
        if (isSuper) {
          if (unitVal) params.set('unit', unitVal);
        } else if (isWilayahAdmin) {
          if (loginWilayah) params.set('wilayah', loginWilayah);
          if (unitVal) params.set('unit', unitVal);
        } else {
          unitVal = unitVal || loginUkpd;
          if (unitVal) params.set('unit', unitVal);
        }
        const jabVal = jabatanFilter.value;
        if (jabVal) params.set('jabatan', jabVal);
        const searchTerm = searchInput.value || quickSearch.value;
        if (searchTerm) params.set('search', searchTerm);
        const activeChips = Array.from(document.querySelectorAll('.chip.active')).map(c=>c.dataset.status);
        if (activeChips.length) params.set('status', activeChips.join(','));

        const res = await fetch(`${API_BASE}?action=list&${params.toString()}`, { headers: API_HEADERS });
        const body = await res.json();
        if (!res.ok || !body.ok) throw new Error(body.error || 'Gagal ambil data');
        rows = applyRoleFilter(body.rows || []);
        totalCount = body.total || rows.length;
        populateFilters(body, rows);
        renderStats(body.summary, rows.length);
        renderTable();
        const maxPage = Math.max(1, Math.ceil(totalCount / size));
        if (currentPage > maxPage) { currentPage = maxPage; renderTable(); }
        setStatus('Data dimuat: ' + totalCount.toLocaleString('id-ID') + ' baris (halaman ' + currentPage + ').');
      } catch(err){
        setStatus('Gagal ambil data: ' + err.message);
      }
    }

    function populateFilters(body, dataRows){
      const units = (body?.units && body.units.length ? body.units : Array.from(new Set(dataRows.map(d => d.nama_ukpd).filter(Boolean)))).sort();
      unitFilter.innerHTML = '<option value="">Pilih UKPD</option>' + units.map(u => { const safe = escapeHtml(u); return `<option value="${safe}">${safe}</option>`; }).join('');
      if (!isSuper && !isWilayahAdmin) {
        unitFilter.value = loginUkpd;
        unitFilter.disabled = true;
      } else {
        unitFilter.disabled = false;
        if (!unitFilter.value) unitFilter.value = '';
      }
      const jabs = (body?.jabs && body.jabs.length ? body.jabs : Array.from(new Set(dataRows.map(d => d.nama_jabatan_orb).filter(Boolean)))).sort();
      jabatanFilter.innerHTML = '<option value="">Pilih Jabatan</option>' + jabs.map(u => { const safe = escapeHtml(u); return `<option value="${safe}">${safe}</option>`; }).join('');
      const statuses = (body?.statuses && body.statuses.length ? body.statuses : Array.from(new Set(dataRows.map(d => d.nama_jenis_pegawai || d.nama_status_aktif).filter(Boolean)))).sort();
      const activeSet = new Set(Array.from(chipStatus.querySelectorAll('.chip.active')).map(c=>c.dataset.status));
      statusTags = statuses;
      chipStatus.innerHTML = statuses.map(s => { const safe = escapeHtml(s); return `<div class="chip" data-status="${safe}">${safe}</div>`; }).join('');
      chipStatus.querySelectorAll('.chip').forEach(chip=>{ if (activeSet.has(chip.dataset.status)) chip.classList.add('active'); });
      chipStatus.onclick = (e)=>{
        const chip = e.target.closest('.chip');
        if (!chip) return;
        chip.classList.toggle('active');
        currentPage = 1;
        loadData();
      };
    }

    function applyFilters(){
      currentPage = 1;
      loadData();
    }

    function debounce(fn, wait = 300){
      let timer;
      return (...args) => {
        if (timer) clearTimeout(timer);
        timer = setTimeout(() => fn.apply(null, args), wait);
      };
    }

    function renderStats(summary, countInPage){
      statsEl.innerHTML = '';
      const cards = [{ title: 'Total Pegawai (filter)', value: totalCount || countInPage || 0 }];
      if (summary) {
        Object.entries(summary).forEach(([k,v]) => cards.push({ title: k, value: v }));
      }
      cards.forEach(c=>{
        const div = document.createElement('div');
        div.className = 'stat';
        div.innerHTML = `<div class="title">${escapeHtml(c.title)}</div><div class="value">${escapeHtml(c.value)}</div>`;
        statsEl.appendChild(div);
      });
    }

    const REQUIRED_FIELDS = [
      ['nip','NIP'],['nik','NIK'],['nama_pegawai','Nama'],['nama_ukpd','UKPD'],['nama_jabatan_orb','Jabatan'],
      ['nama_status_rumpun','Rumpun'],['nama_status_aktif','Status Pegawai'],
      ['jenis_kelamin','Jenis Kelamin'],['tanggal_lahir','Tanggal Lahir'],['tempat_lahir','Tempat Lahir'],
      ['agama','Agama'],['jenjang_pendidikan','Pendidikan'],['no_tlp','No Tlp'],['alamat_domisili','Alamat Domisili']
    ];
    function missingFields(row){
      return REQUIRED_FIELDS.filter(([k])=> !row[k]).map(([,label])=>label);
    }

    function renderTable(){
      const size = parseInt(pageSize.value,10) || 10;
      const total = totalCount || rows.length;
      const maxPage = Math.max(1, Math.ceil(total / size));
      if (currentPage > maxPage) currentPage = maxPage;
      tableBody.innerHTML = '';
      rows.forEach((r, idx)=>{
        const tr = document.createElement('tr');
        const rowId = r.id || r.nip || r.nik || '';
        const missing = missingFields(r);
        const missingText = missing.join(', ');
        const warnBadge = missing.length ? `<span class="warn-badge" title="Belum lengkap: ${escapeHtml(missingText)}" data-missing="${escapeHtml(missing.join('|'))}">⚠ Lengkapi</span>` : '';
        const safeRowId = escapeHtml(rowId);
        tr.innerHTML = `
          <td>${(currentPage - 1) * size + idx + 1}</td>
          <td>${escapeHtml(r.nip || '-')}</td>
          <td>${escapeHtml(r.nik || '-')}</td>
          <td>${escapeHtml(r.nama_pegawai || '-')}${warnBadge}</td>
          <td>${escapeHtml(r.nama_jabatan_orb || '-')}</td>
          <td>${escapeHtml(r.nama_status_rumpun || '-')}</td>
          <td>${escapeHtml(r.nama_jenis_pegawai || '-')}</td>
          <td>${escapeHtml(r.nama_ukpd || '-')}</td>
            <td>${escapeHtml(r.nama_status_aktif || '-')}</td>
            <td class="actions">
              <button class="icon-btn icon-view" type="button" title="Lihat Profil" aria-label="Lihat Profil" data-id="${safeRowId}" data-action="view">
                <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                  <path d="M12 5c5 0 9.27 3.11 11 7-1.73 3.89-6 7-11 7S2.73 15.89 1 12c1.73-3.89 6-7 11-7Zm0 2c-3.76 0-7.09 2.2-8.74 5 1.65 2.8 4.98 5 8.74 5s7.09-2.2 8.74-5C19.09 9.2 15.76 7 12 7Zm0 2.5A2.5 2.5 0 1 1 9.5 12 2.5 2.5 0 0 1 12 9.5Z"></path>
                </svg>
              </button>
              <button class="icon-btn icon-edit" type="button" title="Edit" aria-label="Edit" data-id="${safeRowId}" data-action="edit">
                <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                  <path d="M3 17.25V21h3.75l11.06-11.06-3.75-3.75L3 17.25Zm2.06 2.69H5v-0.94l9.06-9.06.94.94-9.06 9.06Zm12.02-11.08-.94.94-3.75-3.75.94-.94a1 1 0 0 1 1.41 0l2.34 2.34a1 1 0 0 1 0 1.41Z"></path>
                </svg>
              </button>
              <button class="icon-btn icon-delete" type="button" title="Hapus" aria-label="Hapus" data-id="${safeRowId}" data-action="delete">
                <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                  <path d="M6 7h12l-1 13H7L6 7Zm3-3h6l1 1h4v2H4V5h4l1-1Zm1 5v9h2V9H10Zm4 0v9h2V9H14Z"></path>
                </svg>
              </button>
            </td>
          `;
        tableBody.appendChild(tr);
      });
      if (pagerInfo) pagerInfo.textContent = `Halaman ${currentPage} / ${maxPage} • Total ${total.toLocaleString('id-ID')} baris`;
    }

    function countBy(arr, fn){ return arr.reduce((acc, item)=>{ const k = fn(item); acc[k] = (acc[k]||0)+1; return acc; }, {}); }

    function disableFormAutocomplete(formEl){
      if (!formEl) return;
      const fields = formEl.querySelectorAll('input, textarea');
      fields.forEach((el) => {
        el.setAttribute('autocomplete', 'off');
        el.setAttribute('autocorrect', 'off');
        el.setAttribute('autocapitalize', 'off');
        el.setAttribute('spellcheck', 'false');
      });
    }

    function ensureSelectValue(el, value){
      if (!el || !value) return;
      const exists = Array.from(el.options || []).some(o => o.value === value);
      if (!exists) {
        const opt = document.createElement('option');
        opt.value = value;
        opt.textContent = value;
        el.appendChild(opt);
      }
      el.value = value;
    }

    function openModal(data){
      modalBackdrop.classList.add('show');
      pegawaiForm.reset();
      disableFormAutocomplete(pegawaiForm);
      editingId = data?.id || data?.nip || data?.nik || null;
      modalTitle.textContent = editingId ? 'Edit Pegawai' : 'Tambah Pegawai';
      submitModal.textContent = editingId ? 'Simpan Perubahan' : 'Tambah';
      if (data){
        Object.keys(data).forEach(k => { if (pegawaiForm.elements[k]) pegawaiForm.elements[k].value = data[k] || ''; });
        ensureSelectValue(selectJenisPegawai, data.nama_jenis_pegawai);
        setUkpdField(false);
      } else {
        setUkpdField(true);
      }
    }
    function closeModal(){ modalBackdrop.classList.remove('show'); editingId = null; }

    async function savePegawai(e){
      e.preventDefault();
      const data = Object.fromEntries(new FormData(pegawaiForm).entries());
      if (!data.nip && !editingId){ setStatus('NIP wajib diisi'); return; }
      try {
        setStatus(editingId ? 'Menyimpan perubahan...' : 'Menambah pegawai...');
        const isEdit = Boolean(editingId);
        const bodyPayload = { action: isEdit ? 'update' : 'create', ...data };
        if (isEdit) bodyPayload.id = editingId;
        const res = await fetch(API_BASE, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-Proxy-Key': PROXY_KEY },
          body: JSON.stringify(bodyPayload)
        });
        const body = await res.json();
        if (!res.ok || !body.ok) throw new Error(body.error || 'Gagal simpan');
        closeModal();
        await loadData();
        setStatus('Berhasil disimpan');
        showToast('Data pegawai berhasil disimpan.', 'success');
      } catch(err){
        setStatus('Gagal simpan: ' + err.message);
        showToast('Gagal menyimpan data pegawai.', 'error');
      }
    }

    async function deletePegawai(id){
      if (!confirm('Hapus data ini?')) return;
      try {
        setStatus('Menghapus...');
        const res = await fetch(API_BASE, {
          method:'POST',
          headers: { 'Content-Type': 'application/json', 'X-Proxy-Key': PROXY_KEY },
          body: JSON.stringify({ action: 'delete', id })
        });
        const body = await res.json();
        if (!res.ok || !body.ok) throw new Error(body.error || 'Gagal hapus');
        await loadData();
        setStatus('Data terhapus');
        showToast('Data pegawai berhasil dihapus.', 'success');
      } catch(err){
        setStatus('Gagal hapus: ' + err.message);
        showToast('Gagal menghapus data pegawai.', 'error');
      }
    }

    function doLogout(){ localStorage.removeItem('authUser'); window.location.href = BASE; }

    function initSidebarToggle(){
      const btn = document.getElementById('sidebarToggle');
      const backdrop = document.getElementById('sidebarBackdrop');
      const sidebar = document.querySelector('.sidebar');
      if (!btn || !sidebar || !backdrop) return;
      const close = ()=>{ sidebar.classList.remove('show'); backdrop.classList.remove('show'); document.body.style.overflow=''; };
      btn.addEventListener('click', ()=>{
        const willShow = !sidebar.classList.contains('show');
        sidebar.classList.toggle('show', willShow);
        backdrop.classList.toggle('show', willShow);
        document.body.style.overflow = willShow ? 'hidden' : '';
      });
      backdrop.addEventListener('click', close);
      sidebar.addEventListener('click', (e)=>{ if (e.target.closest('a')) close(); });
      window.addEventListener('resize', ()=>{ if (window.innerWidth >= 1100) close(); });
    }

    if (refreshBtn) refreshBtn.addEventListener('click', loadData);
    addBtn.addEventListener('click', ()=>openModal(null));
    cancelModal.addEventListener('click', closeModal);
    pegawaiForm.addEventListener('submit', savePegawai);
    unitFilter.addEventListener('change', applyFilters);
    jabatanFilter.addEventListener('change', applyFilters);
    if (aktifFilter) aktifFilter.addEventListener('change', applyFilters);
    const debouncedApply = debounce(applyFilters, 350);
    searchInput.addEventListener('input', debouncedApply);
    quickSearch.addEventListener('input', debouncedApply);
    pageSize.addEventListener('change', ()=>{ currentPage = 1; loadData(); });
    prevPage.addEventListener('click', ()=>{ if (currentPage > 1) { currentPage--; loadData(); } });
    nextPage.addEventListener('click', ()=>{ const size = parseInt(pageSize.value,10)||10; const maxPage = Math.max(1, Math.ceil((totalCount||rows.length)/size)); if (currentPage < maxPage) { currentPage++; loadData(); } });
    applyFilter.addEventListener('click', applyFilters);
    resetFilter.addEventListener('click', ()=>{
      searchInput.value='';
      quickSearch.value='';
      jabatanFilter.value='';
      if (aktifFilter) aktifFilter.value='';
      document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      if (!isSuper && !isWilayahAdmin) {
        unitFilter.value = loginUkpd;
      } else {
        unitFilter.value = '';
      }
      applyFilters();
    });
    tableBody.addEventListener('click', (e)=>{ 
      const warn = e.target.closest('.warn-badge');
      if (warn){
        const missingList = warn.dataset.missing ? warn.dataset.missing.split('|').join(', ') : 'Data belum lengkap';
        alert('Lengkapi data: ' + missingList);
        return;
      }
      const btn = e.target.closest('button'); 
      if(!btn) return; 
      const id = btn.dataset.id; 
      const action = btn.dataset.action; 
      const row = rows.find(r => r.id === id || r.nip === id || r.nik === id); 
      if(action==='edit' && row) openModal(row); 
      if(action==='delete' && id) deletePegawai(id); 
      if(action==='view' && row){ 
        try { localStorage.setItem('selectedPegawai', JSON.stringify(row)); } catch(_){} 
        window.location.href = BASE + 'profil/'; 
      }
    });

    init();
  </script>
</body>
</html>





